<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>FunnySaltyFish&#39;s Blog</title>
  
  <subtitle>FunnySaltyFish的小站</subtitle>
  <link href="https://blog.funnysaltyfish.fun/atom.xml" rel="self"/>
  
  <link href="https://blog.funnysaltyfish.fun/"/>
  <updated>2022-03-28T02:46:14.502Z</updated>
  <id>https://blog.funnysaltyfish.fun/</id>
  
  <author>
    <name>FunnySaltyFish</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>博客迁移完毕</title>
    <link href="https://blog.funnysaltyfish.fun/2022/03/28/migrate-finish/"/>
    <id>https://blog.funnysaltyfish.fun/2022/03/28/migrate-finish/</id>
    <published>2022-03-28T02:40:59.000Z</published>
    <updated>2022-03-28T02:46:14.502Z</updated>
    
    <content type="html"><![CDATA[<p>鉴于 CDN <code>jsdelivr</code> 难以访问，以及 <code>Gitee</code> 于 2022/03/25 突然禁止图床链接，我于 2022/03/26-2022/03/28 进行了博客迁移工作<br>主要内容包括：</p><ul><li>更换 <code>jsdelivr</code> 为 <code>jsdelivr.panbaidu.cn</code></li><li>更换 图片链接 到个人服务器</li><li>基于 Lsky Pro 2.0 搭建新图床，之后的图片将保存于自建图床</li></ul><p>完毕！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;鉴于 CDN &lt;code&gt;jsdelivr&lt;/code&gt; 难以访问，以及 &lt;code&gt;Gitee&lt;/code&gt; 于 2022/03/25 突然禁止图床链接，我于 2022/03/26-2022/03/28 进行了博客迁移工作&lt;br&gt;主要内容包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>深入Jetpack Compose——布局原理与自定义布局（四）</title>
    <link href="https://blog.funnysaltyfish.fun/2022/03/10/jetpack-compose-layout-4/"/>
    <id>https://blog.funnysaltyfish.fun/2022/03/10/jetpack-compose-layout-4/</id>
    <published>2022-03-10T03:47:16.000Z</published>
    <updated>2022-03-28T02:37:06.940Z</updated>
    
    <content type="html"><![CDATA[<p>上一篇<a href="https://juejin.cn/post/7068164264363556872">文章</a>，我们接触了固有特性测量。这一篇，我们将探索<code>ParentData</code></p><h3 id="ParentData"><a href="#ParentData" class="headerlink" title="ParentData"></a>ParentData</h3><h4 id="曾经的例子"><a href="#曾经的例子" class="headerlink" title="曾经的例子"></a>曾经的例子</h4><p>让我们回忆一下第一篇文章中提到的例子，为了实现如下效果</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202121752667.png" alt="左上角的圆角是屏幕边缘"></p><p>我们当时使用了这样一串修饰符：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Box(modifier = Modifier</span><br><span class="line">            .fillMaxSize()</span><br><span class="line">            .wrapContentSize(align = Alignment.Center)</span><br><span class="line">            .size(<span class="number">50.</span>dp)</span><br><span class="line">            .background(Color.Blue))</span><br></pre></td></tr></table></figure><p>也就是说，子微件的居中是它自己的<code>wrapContentSize(align = Alignment.Center)</code>调整的结果。那么，如果我们现在知道了子微件（小的蓝色方块）被包裹在另一个方块（Box）里，我们能不能让父布局帮忙确定居中位置呢？</p><p>答案是可以的！<code>Box</code> 在其<code>content</code>作用域中提供了<code>align</code> 方法，这可以让<strong>子微件自行告知父布局：我需要居中</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">Box</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">// content 提供了 BoxScope</span></span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> <span class="type">BoxScope</span>.() -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> measurePolicy = rememberBoxMeasurePolicy(contentAlignment, propagateMinConstraints)</span><br><span class="line">    Layout(</span><br><span class="line">        content = &#123; BoxScopeInstance.content() &#125;,</span><br><span class="line">        measurePolicy = measurePolicy,</span><br><span class="line">        modifier = modifier</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而 <code>BoxScope</code>的源码如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BoxScope</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Stable</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> Modifier.<span class="title">align</span><span class="params">(alignment: <span class="type">Alignment</span>)</span></span>: Modifier</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Stable</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> Modifier.<span class="title">matchParentSize</span><span class="params">()</span></span>: Modifier</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>作为接口，在此作用域中，子微件就可以调用<code>align</code>告诉父微件自己的align方式了</p><p>所以上面的效果这可以这样实现：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">ModifierSample2</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 父元素</span></span><br><span class="line">    Box(modifier = Modifier</span><br><span class="line">        .width(<span class="number">200.</span>dp)</span><br><span class="line">        .height(<span class="number">300.</span>dp)</span><br><span class="line">        .background(Color.Yellow))&#123;</span><br><span class="line">        <span class="comment">// 子元素</span></span><br><span class="line">        Box(modifier = Modifier</span><br><span class="line">            .align(Alignment.Center)</span><br><span class="line">            .size(<span class="number">50.</span>dp)</span><br><span class="line">            .background(Color.Blue))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果是一样的</p><p>不像我们之前看到的<code>布局修饰符</code>，align是<code>父级数据修饰符</code>。本质上，这类由子微件向父布局通信就是由<code>parentData</code>实现的。如上面的<code>align</code>最终会涉及到如下代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">val</span> parentData: Any?</span><br><span class="line">        <span class="keyword">get</span>() = with(modifier) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ParentData provided through the parentData node will override the data provided</span></span><br><span class="line"><span class="comment">             * through a modifier</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            layoutNode.measureScope.modifyParentData(wrapped.parentData)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p><code>ParentDataModifier</code>源码如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个修饰符[Modifier]，为父布局[Layout]提供数据. </span></span><br><span class="line"><span class="comment"> * 可在[Layout]的 measurement 和 positioning 过程中通过 [IntrinsicMeasurable.parentData] 读取到.</span></span><br><span class="line"><span class="comment"> * parent data 通常被用于告诉父布局：子微件应该如何测量和定位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ParentDataModifier</span> : <span class="type">Modifier.Element &#123;</span></span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Provides a parentData, given the [parentData] already provided through the modifier&#x27;s chain.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> Density.<span class="title">modifyParentData</span><span class="params">(parentData: <span class="type">Any</span>?)</span></span>: Any?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="尝试用用：咸鱼的“地摊”"><a href="#尝试用用：咸鱼的“地摊”" class="headerlink" title="尝试用用：咸鱼的“地摊”"></a>尝试用用：咸鱼的“地摊”</h4><p>接下来我们尝试用用它。我们来假想这样一个布局：<code>小咸鱼的地摊</code></p><ul><li><p>“地摊”里面有一些微件，它们一个一个纵向排列</p></li><li><p>每个子微件都是“付费”的，比如某一个<code>Box</code>“售价”100，另一个<code>Box</code>“售价”200……以此类推</p></li><li><p>每个子微件会显示自己的价格，而“地摊”会显示总价钱</p></li></ul><p>上述描述换成代码的话就是：每一个子微件通过自定义的<code>Modifier</code>定义自身的价格，并把它传递给父布局，父布局计算所有的价格累积在一起，并显示出来。</p><p>开始写代码吧。我们先定义一个类，继承自<code>ParentDataModifier</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作者 FunnySaltyFish (http://funnysaltyfish.fun)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountNumParentData</span></span>(<span class="keyword">var</span> countNum: <span class="built_in">Int</span>) : ParentDataModifier &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> Density.<span class="title">modifyParentData</span><span class="params">(parentData: <span class="type">Any</span>?)</span></span> = <span class="keyword">this</span><span class="symbol">@CountNumParentData</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（为了简单起见，我们将<code>modifyParentData</code>这个方法直接返回自身了。在原版<code>Column</code>的实现中，这个方法实际类似这样：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> Density.<span class="title">modifyParentData</span><span class="params">(parentData: <span class="type">Any</span>?)</span></span> =</span><br><span class="line">    ((parentData <span class="keyword">as</span>? RowColumnParentData) ?: RowColumnParentData()).also &#123;</span><br><span class="line">        it.weight = weight</span><br><span class="line">        it.fill = fill</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>）</p><p>然后我们编写一个简单的<code>Modifier</code>，返回一个实例</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Modifier.<span class="title">count</span><span class="params">(num: <span class="type">Int</span>)</span></span> = <span class="keyword">this</span>.then(</span><br><span class="line">        <span class="comment">// 这部分是 父级数据修饰符</span></span><br><span class="line">        CountNumParentData(num)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>接下来我们复用一下之前的<code>VerticalLayout</code>，只不过在里面读取一下<code>ParentData</code>而已，部分代码如下</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> num = <span class="number">0</span></span><br><span class="line">Layout(</span><br><span class="line">    modifier = modifier,</span><br><span class="line">    content = content</span><br><span class="line">) &#123; measurables: List&lt;Measurable&gt;, constraints: Constraints -&gt;</span><br><span class="line">    <span class="keyword">val</span> placeables = measurables.map &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.parentData <span class="keyword">is</span> CountNumParentData) &#123;</span><br><span class="line">            num += (it.parentData <span class="keyword">as</span> CountNumParentData).countNum</span><br><span class="line">        &#125;</span><br><span class="line">        it.measure(constraints)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略布局的其他代码</span></span><br><span class="line">    Log.d(TAG, <span class="string">&quot;CountChildrenNumber: 总价格是：<span class="variable">$num</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后运行一下这个例子</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">CountNumTest</span><span class="params">()</span></span> &#123;</span><br><span class="line">    CountChildrenNumber &#123;</span><br><span class="line">        repeat(<span class="number">5</span>) &#123;</span><br><span class="line">            Box(</span><br><span class="line">                modifier = Modifier</span><br><span class="line">                    .size(<span class="number">40.</span>dp)</span><br><span class="line">                    .background(randomColor())</span><br><span class="line">                    .count(Random.nextInt(<span class="number">30</span>, <span class="number">100</span>))</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202203071601534.png" alt="image-20220307160129098"></p><p>对应的总价格输出如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202203071602599.png" alt="image-20220307160211472"></p><p>你可能注意到了，上面的Box里面还用文字指明了自己的“售价”，但调用的代码却没用到<code>Text</code>。这里的文本又是怎么画的呢？</p><p>答案就是刚刚的<code>count</code>Modifier，除了作为<code>父级数据修饰符</code>外，它还发挥了修饰自身的作用。它的代码完整如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Modifier.<span class="title">count</span><span class="params">(num: <span class="type">Int</span>)</span></span> = <span class="keyword">this</span>.drawWithContent &#123;</span><br><span class="line">        drawIntoCanvas &#123; canvas -&gt;</span><br><span class="line">            <span class="keyword">val</span> paint = android.graphics</span><br><span class="line">                .Paint()</span><br><span class="line">                .apply &#123;</span><br><span class="line">                    textSize = <span class="number">40F</span></span><br><span class="line">                &#125;</span><br><span class="line">            canvas.nativeCanvas.drawText(num.toString(), <span class="number">0F</span>, <span class="number">40F</span>, paint)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绘制 Box 自身内容</span></span><br><span class="line">        drawContent()</span><br><span class="line">    &#125;</span><br><span class="line">    .then(</span><br><span class="line">        <span class="comment">// 这部分是 父级数据修饰符</span></span><br><span class="line">        CountNumParentData(num)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>这里用到了绘制时的部分内容，如果你感兴趣的话，后面我还可能介绍一下自定义绘制。嗯，挖了个坑，之后再填吧~</p><p><code>ParentData</code>的实际场景主要集中在父布局对子微件的特殊位置和大小的控制上，比如<code>Box</code>的<code>align</code>，<code>Column</code>和<code>Row</code>的<code>align</code>、<code>alignBy</code>、<code>weight</code>上。接下来我们来实现一个简化版的<code>weight</code>吧</p><h4 id="尝试用用：实现简易版weight"><a href="#尝试用用：实现简易版weight" class="headerlink" title="尝试用用：实现简易版weight"></a>尝试用用：实现简易版weight</h4><p>为了简易起见，我们实现的<code>weight</code>有如下限制：</p><ul><li>所有子微件都有weight，按比例实现高度分配</li><li>父布局的宽高是确定的</li></ul><p>所以代码的逻辑就是：读取所有<code>weight</code>，按比例分配高度就行。</p><p>首先类似于<code>Box</code>，我们也写一个<code>VerticalScope</code>，让我们自定义的weight只能在自定义的布局中使用</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">VerticalScope</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Stable</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> Modifier.<span class="title">weight</span><span class="params">(weight: <span class="type">Float</span>)</span></span> : Modifier</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后再自定义我们的<code>ParentDataModifier</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeightParentData</span></span>(<span class="keyword">val</span> weight: <span class="built_in">Float</span>=<span class="number">0f</span>) : ParentDataModifier &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> Density.<span class="title">modifyParentData</span><span class="params">(parentData: <span class="type">Any</span>?)</span></span> = <span class="keyword">this</span><span class="symbol">@WeightParentData</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写一个object，让它实现我们的<code>VerticalScope</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> VerticalScopeInstance : VerticalScope &#123;</span><br><span class="line">    <span class="meta">@Stable</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> Modifier.<span class="title">weight</span><span class="params">(weight: <span class="type">Float</span>)</span></span>: Modifier = <span class="keyword">this</span>.then(</span><br><span class="line">        WeightParentData(weight)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，就是具体的<code>Composable</code>实现了。注意，在此处，我们的<code>content</code>需要加上<code>VerticalScope.</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">WeightedVerticalLayout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> <span class="type">VerticalScope</span>.() -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><p>具体实现类似于之前的<code>VerticalLayout</code>，不同之处在于我们要获取到各个<code>WeightParentData</code>的值并保存下来，计算总的weight。这样就可以按比例分配高度了。</p><p>关键代码如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> measurePolicy = MeasurePolicy &#123; measurables, constraints -&gt;</span><br><span class="line">    <span class="keyword">val</span> placeables = measurables.map &#123;it.measure(constraints)&#125;</span><br><span class="line">    <span class="comment">// 获取各weight值</span></span><br><span class="line">    <span class="keyword">val</span> weights = measurables.map &#123;</span><br><span class="line">        (it.parentData <span class="keyword">as</span> WeightParentData).weight</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> totalHeight = constraints.maxHeight</span><br><span class="line">    <span class="keyword">val</span> totalWeight = weights.sum()</span><br><span class="line">    <span class="comment">// 宽度：最宽的一项</span></span><br><span class="line">    <span class="keyword">val</span> width = placeables.maxOf &#123; it.width &#125;</span><br><span class="line"></span><br><span class="line">    layout(width, totalHeight) &#123;</span><br><span class="line">        <span class="keyword">var</span> y = <span class="number">0</span></span><br><span class="line">        placeables.forEachIndexed() &#123; i, placeable -&gt;</span><br><span class="line">            placeable.placeRelative(<span class="number">0</span>, y)</span><br><span class="line">            <span class="comment">// 按比例设置大小</span></span><br><span class="line">            y += (totalHeight * weights[i] / totalWeight).toInt()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Layout(modifier = modifier, content = &#123; VerticalScopeInstance.content() &#125;, measurePolicy=measurePolicy)</span><br></pre></td></tr></table></figure><p>测试一下？我们预备让三个Box按<code>1:2:7</code>的高度显示</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WeightedVerticalLayout(Modifier.padding(<span class="number">16.</span>dp).height(<span class="number">200.</span>dp)) &#123;</span><br><span class="line">    Box(modifier = Modifier.width(<span class="number">40.</span>dp).weight(<span class="number">1f</span>).background(randomColor()))</span><br><span class="line">    Box(modifier = Modifier.width(<span class="number">40.</span>dp).weight(<span class="number">2f</span>).background(randomColor()))</span><br><span class="line">    Box(modifier = Modifier.width(<span class="number">40.</span>dp).weight(<span class="number">7f</span>).background(randomColor()))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终效果如下，可以看到，三个Box正确按照<code>1:2:7</code>的比例显示高度</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202203101113984.png" alt="image-20220310111258869"></p><p>成功！</p><h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>关于ParentData我们就先看这些。下一篇，我们……等我想想要写啥</p><p>本文参考：</p><ul><li><a href="https://juejin.cn/post/6964010073576177671">JetPack Compose 手写一个 Row 布局 | 自定义布局 - 掘金 (juejin.cn)</a></li><li>Android官方视频：<a href="https://www.youtube.com/watch?v=zMKMwh9gZuI">Deep dive into Jetpack Compose layouts</a></li></ul><p>本文所有代码见：<a href="https://github.com/FunnySaltyFish/JetpackComposeStudy/tree/master/app/src/main/java/com/funny/compose/study/ui/post_layout">此处</a>，欢迎star~</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;上一篇&lt;a href=&quot;https://juejin.cn/post/7068164264363556872&quot;&gt;文章&lt;/a&gt;，我们接触了固有特性测量。这一篇，我们将探索&lt;code&gt;ParentData&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;ParentData&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>深入Jetpack Compose——布局原理与自定义布局（三）</title>
    <link href="https://blog.funnysaltyfish.fun/2022/02/24/jetpack-compose-layout-3/"/>
    <id>https://blog.funnysaltyfish.fun/2022/02/24/jetpack-compose-layout-3/</id>
    <published>2022-02-24T03:47:16.000Z</published>
    <updated>2022-03-28T02:37:06.940Z</updated>
    
    <content type="html"><![CDATA[<p>在上一篇[文章](<a href="https://juejin.cn/post/7063816490021027871">深入Jetpack Compose——布局原理与自定义布局（二）</a>)中，我们探索了<code>Modifier</code>的本质和原理。这一次我们看看Compose体系中的一个重要特性：<code>固有特性测量</code>。</p><h2 id="固有特性测量"><a href="#固有特性测量" class="headerlink" title="固有特性测量"></a>固有特性测量</h2><p>或许不少人已经知道，Compose为了提高测绘性能，强行规定了每个微件只能被测量一次。也就是说，我们不能写出类似下面这样的代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> placeables = measurables.map &#123; it.measure(constrains) &#125;</span><br><span class="line"><span class="comment">// 尝试测量第二次，直接报错</span></span><br><span class="line"><span class="keyword">val</span> placeablesSecond = measurables.map &#123; it.measure(constrains) &#125;</span><br></pre></td></tr></table></figure><h3 id="一个小问题"><a href="#一个小问题" class="headerlink" title="一个小问题"></a>一个小问题</h3><p>那么接下来我们看一个小例子。我们想实现一个菜单，菜单里面有几个菜单栏。于是我们写出了类似这样按的代码</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241339204.png" alt="image-20220224133926999"></p><p>但是效果不怎么样，因为每个<code>Text</code>的宽度不一样。看起来有点丑</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241340468.png" alt="image-20220224134059328"></p><p>你可能会说，要解决这个问题很简单，为每个<code>Text</code> 添加修饰符<code>fillMaxWidth</code>，让它占满即可。效果如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241342424.png" alt="image-20220224134220288"></p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241342785.png" alt="image-20220224134255678"></p><p>但是这样新的问题来了：由于每个<code>Text</code>的<code>Constraint</code>的<code>maxWidth</code>都是最大值，于是咱们的<code>Column</code>宽度也是最大值。于是这个菜单占满了全部屏幕空间。这可不妙！</p><p>要解决这个问题，我们只需要为<code>Column</code>添加这样一个修饰符</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Modifier.width(IntrinsicSize.Max)</span><br></pre></td></tr></table></figure><p>它的宽度就是子微件宽度的最大值啦</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241349842.png" alt="image-20220224134901689"></p><p>有<code>Max</code>应该就有<code>Min</code>，咱们试试？</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241351729.png" alt="image-20220224135116580"></p><p>宽度变窄了！很神奇吗？这就是固有特性测量的功劳。</p><p><em>（如果你好奇为什么最小宽度是这个，因为子微件是文本，而文本的最小宽度是它每行能容纳一个词时的宽度。在这个例子中，就是Send Feedback分成 Send \n Feedback时Feedback这行字的宽度）</em></p><p>上面的例子中，<code>Column</code>就适配了固有特性测量这一特性。接下来，我们把自己的实现的<code>VerticalLayout</code>也来适应一下（VerticalLayout具体实现见第一篇）。</p><h3 id="适配固有特性测量"><a href="#适配固有特性测量" class="headerlink" title="适配固有特性测量"></a>适配固有特性测量</h3><p>让我们重新把目光转向<code>Layout</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">Layout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> () -&gt; <span class="type">Unit</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    measurePolicy: <span class="type">MeasurePolicy</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><p>之前对于第三个参数，我们是写成了SAM的形式。我们现在再来看看这个<code>MeasurePolicy</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Stable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> MeasurePolicy &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> MeasureScope.<span class="title">measure</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        measurables: <span class="type">List</span>&lt;<span class="type">Measurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        constraints: <span class="type">Constraints</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: MeasureResult</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The function used to calculate [IntrinsicMeasurable.minIntrinsicWidth]. It represents</span></span><br><span class="line"><span class="comment">     * the minimum width this layout can take, given a specific height, such that the content</span></span><br><span class="line"><span class="comment">     * of the layout can be painted correctly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> IntrinsicMeasureScope.<span class="title">minIntrinsicWidth</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        measurables: <span class="type">List</span>&lt;<span class="type">IntrinsicMeasurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        height: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: <span class="built_in">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> IntrinsicMeasureScope.<span class="title">minIntrinsicHeight</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        measurables: <span class="type">List</span>&lt;<span class="type">IntrinsicMeasurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        width: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: <span class="built_in">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> IntrinsicMeasureScope.<span class="title">maxIntrinsicWidth</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        measurables: <span class="type">List</span>&lt;<span class="type">IntrinsicMeasurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        height: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: <span class="built_in">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">fun</span> IntrinsicMeasureScope.<span class="title">maxIntrinsicHeight</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        measurables: <span class="type">List</span>&lt;<span class="type">IntrinsicMeasurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        width: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: <span class="built_in">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>measure</code>方法是我们之前就用过的，而其余几个拓展函数就是我们要适配 <code>固有特性测量</code> 所需要重写的啦。举个栗子，使用 <code>Modifier.width(IntrinsicSize.Max)</code> ，则会调用 <code>maxIntrinsicWidth</code> 方法，其余同理。</p><p>接下来，咱们开干。先挑一个吧</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> IntrinsicMeasureScope.<span class="title">maxIntrinsicWidth</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    measurables: <span class="type">List</span>&lt;<span class="type">IntrinsicMeasurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    height: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    TODO(<span class="string">&quot;Not yet implemented&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们以子微件宽度的最大值作为最大约束</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> IntrinsicMeasureScope.<span class="title">maxIntrinsicWidth</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    measurables: <span class="type">List</span>&lt;<span class="type">IntrinsicMeasurable</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    height: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> width = <span class="number">0</span></span><br><span class="line">    measurables.forEach &#123; </span><br><span class="line">        <span class="keyword">val</span> childWidth = it.maxIntrinsicWidth(height)</span><br><span class="line">        <span class="keyword">if</span>(childWidth &gt; width) width = childWidth</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> width</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241435172.png" alt="image-20220224143551073"></p><center>(宽度以单词 Funny 为标准)</center><p><strong>min</strong>的情况也差不多，效果如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202241438740.png" alt="image-20220224143833653"></p><center>(宽度以单词 is 为标准)</center><p>完整代码参见Github仓库</p><h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>关于固有特性测量我们就先看这些。下一篇，我们将探索<code>ParentData</code>和其它特性，继续我们的布局之旅</p><p>本文参考：</p><ul><li><a href="https://juejin.cn/post/6969021972051132452">聊一聊Compose的固有特性测量Intrinsic - 掘金 (juejin.cn)</a></li><li>Android官方视频：<a href="https://www.youtube.com/watch?v=zMKMwh9gZuI">Deep dive into Jetpack Compose layouts</a></li></ul><p>本文所有代码见：<a href="https://github.com/FunnySaltyFish/JetpackComposeStudy/tree/master/app/src/main/java/com/funny/compose/study/ui/post_layout">此处</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在上一篇[文章](&lt;a href=&quot;https://juejin.cn/post/7063816490021027871&quot;&gt;深入Jetpack Compose——布局原理与自定义布局（二）&lt;/a&gt;)中，我们探索了&lt;code&gt;Modifier&lt;/code&gt;的本质和原理。这一次</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>深入Jetpack Compose——布局原理与自定义布局（二）</title>
    <link href="https://blog.funnysaltyfish.fun/2022/02/12/jetpack-compose-layout-2/"/>
    <id>https://blog.funnysaltyfish.fun/2022/02/12/jetpack-compose-layout-2/</id>
    <published>2022-02-12T13:36:16.000Z</published>
    <updated>2022-03-28T02:37:06.940Z</updated>
    
    <content type="html"><![CDATA[<p>在上一篇文章<a href="https://juejin.cn/post/7063451846861406245">深入Jetpack Compose——布局原理与自定义布局（一） - 掘金 (juejin.cn)</a> 中，我们大致了解了Layout过程并简单实现了两个自定义布局。本次让我们将目光转向Modifier和固有特性测量</p><p>本文部分参考自Android官方视频：<a href="https://www.youtube.com/watch?v=zMKMwh9gZuI">Deep dive into Jetpack Compose layouts</a></p><h3 id="Modifier"><a href="#Modifier" class="headerlink" title="Modifier"></a>Modifier</h3><h4 id="本质"><a href="#本质" class="headerlink" title="本质"></a>本质</h4><p>关于Modifier的本质，<code>RugerMc</code>大佬在<a href="https://juejin.cn/post/6986933061845778446">图解 Modifier 实现原理 ，竟然如此简单</a>这篇文章中已经解释地非常清楚了，我就不画蛇添足了。不过为了后续行文方便，我还是在此简单说几点：</p><ol><li>Modifier 是个接口，包含三个直接实现类或接口：<code>伴生对象 Modifier</code>、内部子接口<code>Modifier.Element</code>和<code>CombinedModifier</code>。</li><li><code>伴生对象Modifier</code>是日常使用最多的，后面两者均为内部实现，实际开发中无需关注</li><li><code>Modifier.xxx()</code>方法实际上会创建一个<code>Modifier</code>接口的实现类的实例。如<code>Modifier.size()</code>会创建<code>SizeModifer</code>实例</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Stable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Modifier.<span class="title">size</span><span class="params">(size: <span class="type">Dp</span>)</span></span> = <span class="keyword">this</span>.then(</span><br><span class="line">    SizeModifier(</span><br><span class="line">        <span class="comment">/*省略具体细节*/</span></span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ol start="4"><li><p><code>Modifier.xxx().yyy().zzz()</code>实际上会创建一个Modifier链，内部顺序遵循 xxx -&gt; yyy -&gt; zzz ，由<code>CombinedModifier</code>连接。<code>Modifie接口</code>提供了<code>foldIn</code>/<code>foldOut</code>方法允许我们<code>顺序</code>/<code>逆序</code>遍历到每个Modifier</p><p>这里借上面文章中的一张图来说明：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa50641cb3364416958bf33aa848bbf4~tplv-k3u1fbpfcp-watermark.awebp" alt="来源见水印，侵删"></p></li></ol><p>我们可以简单遍历一下看看，对于下面的例子：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">TraverseModifier</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> modifier = Modifier</span><br><span class="line">        .size(<span class="number">40.</span>dp)</span><br><span class="line">        .background(Color.Gray)</span><br><span class="line">        .clip(CircleShape)</span><br><span class="line">    LaunchedEffect(modifier)&#123;</span><br><span class="line">        <span class="comment">// 顺序遍历Modifier</span></span><br><span class="line">        modifier.foldIn(<span class="number">0</span>)&#123; index , element : Modifier.Element -&gt;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;<span class="variable">$index</span> -&gt; <span class="variable">$element</span>&quot;</span>)</span><br><span class="line">            index + <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它的输出为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 -&gt; androidx.compose.foundation.layout.SizeModifier@78000000</span><br><span class="line">1 -&gt; Background(color=Color(...), brush=null, alpha = 1.0, shape=RectangleShape)</span><br><span class="line">2 -&gt; SimpleGraphicsLayerModifier(...)</span><br></pre></td></tr></table></figure><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>接下来，我们看看Modifier是怎么在布局中起作用的</p><p>先看一个例子</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">ModifierSample1</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 父元素</span></span><br><span class="line">    Box(modifier = Modifier</span><br><span class="line">        .width(<span class="number">200.</span>dp)</span><br><span class="line">        .height(<span class="number">300.</span>dp)</span><br><span class="line">        .background(Color.Yellow))&#123;</span><br><span class="line">        <span class="comment">// 子元素</span></span><br><span class="line">        Box(modifier = Modifier</span><br><span class="line">            .fillMaxSize()</span><br><span class="line">            .wrapContentSize(align = Alignment.Center)</span><br><span class="line">            .size(<span class="number">50.</span>dp)</span><br><span class="line">            .background(Color.Blue))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它实际显示的效果如下</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202121752667.png" alt="左上角的圆角是屏幕边缘"></p><center><small>（左上角的圆角是屏幕边缘）</small></center><p>我们来逐步看看这到底是怎么发生的。这里我们选择子元素，也就是那个小一点的蓝色Box，来看看它的<strong>measure</strong>和<strong>place</strong>过程。</p><p>首先是<strong>measure</strong>。父元素明确了自身大小为200*300，该大小也就是子元素能占据的最大空间。因此</p><ol><li><p>初始：初始约束 <strong>w:0-200, h:0-300</strong></p></li><li><p>fillMaxSize()：占据最大空间，约束的<code>min</code>值更改为与<code>max</code>相同，即 <strong>w:200-200, h:300-300</strong></p></li><li><p>wrapContentSize()：适应内容大小，约束的<code>min</code>值重新变回了0，即 <strong>w:0-200, h:0-300</strong></p></li><li><p>size()：指定了精准大小。约束变为 <strong>w:50-50, h:50-50</strong></p></li><li><p>background()：对大小约束无影响</p></li></ol><p>最后，在<code>Modifier</code>的一顿操作之下，Box会收到一个 <strong>w:50-50, h:50-50</strong> 的约束。到这里走过的状态如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202121806531.png" alt="image-20220212180649407"></p><p>接下来，Box内部的<code>Layout</code>微件执行<strong>measure</strong>方法得到了自己的大小：*<em>50</em>50<strong>。这个大小</strong>反向传回到Modifier链的最后一项，并开始place**。接下来：</p><ol><li>background()：此处略过</li><li>size(50.dp)：测得自己的大小：50*50，并据此创建自己的位置指令</li><li>wrapContentSize()：测得自己的大小：200<em>300，并知道自己的子元素大小50\</em>50，且居中放置。据此创建自己的位置指令。</li><li>fillMaxSize()：解析自己的大小和位置</li></ol><p>这个过程很类似于<code>Layout</code>微件，区别就是<strong>每个Modifier只有一个子元素</strong>（也就是Modifier链上的下一个元素）。事实上，如果看代码，你也很容易感受到二者的相似之处</p><p>拿<code>wrapContentSize</code>修饰符的代码举例，其实现类<code>WrapContentModifier</code>的<code>measure</code>方法如下</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> MeasureScope.<span class="title">measure</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    measurable: <span class="type">Measurable</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    constraints: <span class="type">Constraints</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: MeasureResult &#123;</span><br><span class="line">    <span class="comment">// 设置约束</span></span><br><span class="line">    <span class="keyword">val</span> wrappedConstraints = Constraints(<span class="comment">/**/)</span></span><br><span class="line"><span class="comment">    // 测量得到可放置项</span></span><br><span class="line"><span class="comment">    val placeable = measurable.measure(wrappedConstraints)</span></span><br><span class="line"><span class="comment">    val wrapperWidth = placeable.width.coerceIn(constraints.minWidth, constraints.maxWidth)</span></span><br><span class="line"><span class="comment">    val wrapperHeight = placeable.height.coerceIn(constraints.minHeight, constraints.maxHeight)</span></span><br><span class="line"><span class="comment">    // layout函数放置到指定位置并返回结果</span></span><br><span class="line"><span class="comment">    return layout(</span></span><br><span class="line"><span class="comment">        wrapperWidth,</span></span><br><span class="line"><span class="comment">        wrapperHeight</span></span><br><span class="line"><span class="comment">    ) &#123;</span></span><br><span class="line"><span class="comment">        val position = alignmentCallback(</span></span><br><span class="line"><span class="comment">            IntSize(wrapperWidth - placeable.width, wrapperHeight - placeable.height),</span></span><br><span class="line"><span class="comment">            layoutDirection</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment">        placeable.place(position)</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p>怎么样，是不是很相似？</p><h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>关于Modifier我们就先看这些。下一篇，我们将接触<code>固有特性测量</code>这一特性，并改进我们在第一篇文章中实现的纵向布局。</p><p>本文所有代码见：<a href="https://github.com/FunnySaltyFish/JetpackComposeStudy/tree/master/app/src/main/java/com/funny/compose/study/ui/post_layout">此处</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在上一篇文章&lt;a href=&quot;https://juejin.cn/post/7063451846861406245&quot;&gt;深入Jetpack Compose——布局原理与自定义布局（一） - 掘金 (juejin.cn)&lt;/a&gt; 中，我们大致了解了Layout过程并简单实现了两</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>深入Jetpack Compose——布局原理与自定义布局（一）</title>
    <link href="https://blog.funnysaltyfish.fun/2022/02/12/jetpack-compose-layout-1/"/>
    <id>https://blog.funnysaltyfish.fun/2022/02/12/jetpack-compose-layout-1/</id>
    <published>2022-02-12T03:47:16.000Z</published>
    <updated>2022-03-28T02:37:06.938Z</updated>
    
    <content type="html"><![CDATA[<p>Jetpack Compose 正式版发布也已半年了，对我来说，应用到项目中也很久了<small>（参见本人开源项目：<a href="https://github.com/FunnySaltyFish/FunnyTranslation">译站</a>）</small>。 目前很多文章还集中于初探上，因此萌生了写作本文的想法，算是为Compose中文资料提供绵薄之力。</p><p>本文的内容来自Android官方视频：<a href="https://www.youtube.com/watch?v=zMKMwh9gZuI">Deep dive into Jetpack Compose layouts</a></p><h3 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h3><p>Jetpack Compose 中，单个可组合项被显示出来，总体上经历三个过程</p><p><strong>Composition（组合） -&gt; Layout（布局） -&gt; Drawing（绘制）</strong> ，其中Layout阶段又存在两个方面的内容：<strong>Measure（测量） 和 Place（摆放）</strong></p><p>今天我们主要着眼于 Layout 阶段，看看各个 Composable 是如何正确确定各自位置和大小的</p><h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3><p>Layout阶段主要做三件事情：</p><ol><li>测量所有子微件的大小</li><li>确定自己的大小</li><li>正确摆放所有子元素的位置</li></ol><p>为简化说明，我们先给出一个简单例子。该例子中，所有元素只需要遍历一次。</p><p>如下图的 <code>SearchResult</code>微件，它的构成如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111712123.png" alt="image-20220211171231994"></p><p>现在我们来看看Layout过程在这个例子中是什么情况</p><h4 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a>Measure</h4><ol><li>请求测量根布局，即<code>Row</code></li></ol><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111715804.png" alt="image-20220211171509751" style="zoom:50%;" /><ol start="2"><li><p><code>Row</code>为了知道自己的大小，就得先知道自己的子微件有多大，于是请求<code>Image</code>和<code>Column</code>测量它们自己</p><ol><li>对于<code>Image</code>，由于它内部没有其他微件，所以它可以完成自身测量过程并返回相关位置指令</li></ol><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111717527.png" alt="image-20220211171746467" style="zoom: 50%;" /><ol start="2"><li>接下来是<code>Column</code>，因为它内部有两个<code>Text</code>，于是请求子微件测量。而对于<code>Text</code>，它们也会正确返回自己的大小和位置指令</li></ol><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111719907.png" alt="image-20220211171934824" style="zoom:50%;" /><ol start="3"><li>这时 Column 大小和位置指令即可正确确定</li></ol></li><li><p>最后，<code>Row</code>内部所有测量完成，它可以正确获得自己的大小和位置指令</p></li></ol><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111721514.png" alt="image-20220211172155426" style="zoom:50%;" /><p>测量阶段到此结束，接下来就是正确的摆放位置了</p><h4 id="Place"><a href="#Place" class="headerlink" title="Place"></a>Place</h4><p>完成测量后，微件就可以根据自身大小<strong>从上至下</strong>执行各子微件的位置指令，从而确定每个微件的正确位置</p><p>现在我们把目光转向Composition阶段。大家平时写微件，内部都是由很多更基本的微件组合而来的，而事实上，这些基本的微件还有更底层的组成部分。如果我们展开刚刚的那个例子，它就成了这个样子</p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111728631.png" alt="image-20220211172838557" style="zoom:50%;" /><p>在这里，所有的叶节点<small>(即没有子元素的节点)</small>都是<code>Layout</code>这个微件</p><p>我们来看看这个微件吧</p><h3 id="Layout-Composable"><a href="#Layout-Composable" class="headerlink" title="Layout Composable"></a>Layout Composable</h3><p>此微件的签名如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">Layout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> () -&gt; <span class="type">Unit</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    measurePolicy: <span class="type">MeasurePolicy</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><p>我们先看看第三个参数，这是之前从未见过的东西；而它恰恰控制着如何确定微件大小以及它们的摆放策略</p><p>那来写个例子吧。我们现在自定义一个简单的纵向布局，也就是低配版Column</p><h4 id="自定义布局-纵向布局"><a href="#自定义布局-纵向布局" class="headerlink" title="自定义布局 - 纵向布局"></a>自定义布局 - 纵向布局</h4><p>写个框架</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">VerticalLayout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> () -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    Layout(</span><br><span class="line">        modifier = modifier,</span><br><span class="line">        content = content</span><br><span class="line">    ) &#123; measurables: List&lt;Measurable&gt;, constrains: Constraints -&gt;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Measurable</code>代表可测量的，其定义如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Measurable</span> : <span class="type">IntrinsicMeasurable &#123;</span></span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Measures the layout with [constraints], returning a [Placeable] layout that has its new</span></span><br><span class="line"><span class="comment">     * size. A [Measurable] can only be measured once inside a layout pass.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">measure</span><span class="params">(constraints: <span class="type">Constraints</span>)</span></span>: Placeable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，这是个接口，唯一的方法<code>measure</code>返回<code>Placeable</code>，接下来根据这个Placeable摆放位置。而参数measurables其实也就是传入的子微件形成的列表</p><p>而<code>Constraints</code>则描述了微件的大小策略，它的部分定义摘录如下：</p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111748748.png" alt="image-20220211174814661" style="zoom:50%;" /><p>举个栗子，如果我们想让这个微件想多大就多大（类似match_parent），那我们可以这样写：</p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111749649.png" alt="image-20220211174939592" style="zoom:50%;" /><p>如果它是固定大小（比如长宽50），那就是这样写</p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111750399.png" alt="image-20220211175028341" style="zoom:50%;" /><p>接下来我们就先获取placeable吧</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> placeables = measurables.map &#123; it.measure(constrains) &#125;</span><br></pre></td></tr></table></figure><p>在这个简单的例子中，我们不对measure的过程进行过多干预，直接测完获得有大小的可放置项</p><p>接下来确定我们的<code>VerticalLayout</code>的宽、高。对于咱们的布局，它的宽应该容纳的下最宽的孩子，高应该是所有孩子之和。于是得到以下代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 宽度：最宽的一项</span></span><br><span class="line"><span class="keyword">val</span> width = placeables.maxOf &#123; it.width &#125;</span><br><span class="line"><span class="comment">// 高度：所有子微件高度之和</span></span><br><span class="line"><span class="keyword">val</span> height = placeables.sumOf &#123; it.height &#125;</span><br></pre></td></tr></table></figure><p>最后，我们调用<code>layout</code>方法返回最终的测量结果。前两个参数为自身的宽高，第三个lambda确定每个Placeable的位置</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">layout(width, height)&#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="number">0</span></span><br><span class="line">    placeables.forEach &#123;</span><br><span class="line">        it.placeRelative(<span class="number">0</span>, y)</span><br><span class="line">        y += it.height</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里用到了<code>Placeable.placeRelative</code>方法，它能够正确处理从右到左布局的镜像转换</p><p>一个简单的Column就写好了。试一下？</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">randomColor</span><span class="params">()</span></span> = Color(Random.nextInt(<span class="number">255</span>),Random.nextInt(<span class="number">255</span>),Random.nextInt(<span class="number">255</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">CustomLayoutTest</span><span class="params">()</span></span> &#123;</span><br><span class="line">    VerticalLayout() &#123;</span><br><span class="line">        (<span class="number">1.</span><span class="number">.5</span>).forEach &#123;</span><br><span class="line">            Box(modifier = Modifier.size(<span class="number">40.</span>dp).background(randomColor()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202111817149.png" alt="image-20220211181720062" style="zoom:50%;" /><p>嗯，工作基本正常。</p><p>接下来我们实现一个更复杂一点的：简易瀑布流</p><h4 id="自定义布局—简易瀑布流"><a href="#自定义布局—简易瀑布流" class="headerlink" title="自定义布局—简易瀑布流"></a>自定义布局—简易瀑布流</h4><p>先把基本的框架撸出来，在这里只实现纵向的，横向同理</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">WaterfallFlowLayout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> ()-&gt;<span class="type">Unit</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    columns: <span class="type">Int</span> = <span class="number">2</span>  <span class="comment">// 横向几列 </span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    Layout(</span><br><span class="line">        modifier = modifier,</span><br><span class="line">        content = content,</span><br><span class="line">    ) &#123; measurables: List&lt;Measurable&gt;, constrains: Constraints -&gt;</span><br><span class="line">        TODO()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们加入了参数<code>columns</code>用来指定有几列。由于瀑布流宽度是确定的，所以我们需要手动指定宽度</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> itemWidth = constrains.maxWidth / <span class="number">2</span></span><br><span class="line"><span class="keyword">val</span> itemConstraints = constrains.copy(minWidth = itemWidth, maxWidth = itemWidth)</span><br><span class="line"><span class="keyword">val</span> placeables = measurables.map &#123; it.measure(itemConstraints) &#125;</span><br></pre></td></tr></table></figure><p>在这里我们用新的 <code>itemConstraints</code> 对子微件的大小进行约束，固定了子微件的宽度</p><p>接下来就是摆放了。瀑布流的摆放方式其实就是看看当前哪一列最矮，就把当前微件摆到哪一列，不断重复就行</p><p>代码如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">WaterfallFlowLayout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modifier: <span class="type">Modifier</span> = Modifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    columns: <span class="type">Int</span> = <span class="number">2</span>,  <span class="comment">// 横向几列</span></span></span></span><br><span class="line"><span class="params"><span class="function">    content: @<span class="type">Composable</span> ()-&gt;<span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    Layout(</span><br><span class="line">        modifier = modifier,</span><br><span class="line">        content = content,</span><br><span class="line">    ) &#123; measurables: List&lt;Measurable&gt;, constrains: Constraints -&gt;</span><br><span class="line">        <span class="keyword">val</span> itemWidth = constrains.maxWidth / columns</span><br><span class="line">        <span class="keyword">val</span> itemConstraints = constrains.copy(minWidth = itemWidth, maxWidth = itemWidth)</span><br><span class="line">        <span class="keyword">val</span> placeables = measurables.map &#123; it.measure(itemConstraints) &#125;</span><br><span class="line">        <span class="comment">// 记录当前各列高度</span></span><br><span class="line">        <span class="keyword">val</span> heights = IntArray(columns)</span><br><span class="line">        layout(width = constrains.maxWidth, height = constrains.maxHeight)&#123;</span><br><span class="line">            placeables.forEach &#123; placeable -&gt;</span><br><span class="line">                <span class="keyword">val</span> minIndex = heights.minIndex()</span><br><span class="line">                placeable.placeRelative(itemWidth * minIndex, heights[minIndex])</span><br><span class="line">                heights[minIndex] += placeable.height</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里用到了一个自定义的拓展函数<code>minIndex</code>，作用是寻找<strong>数组中最小项的索引值</strong>，代码很简单，如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> IntArray.<span class="title">minIndex</span><span class="params">()</span></span> : <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> min = <span class="built_in">Int</span>.MAX_VALUE</span><br><span class="line">    <span class="keyword">this</span>.forEachIndexed &#123; index, e -&gt;</span><br><span class="line">        <span class="keyword">if</span> (e&lt;min)&#123;</span><br><span class="line">            min = e</span><br><span class="line">            i = index</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下（设置列数为3）：</p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202202112149060.png" alt="image-20220211214931940" style="zoom:50%;" /><h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>本文所有代码见：<a href="https://github.com/FunnySaltyFish/JetpackComposeStudy/tree/master/app/src/main/java/com/funny/compose/study/ui/post_layout">此处</a></p><p>现在的布局只是简单情况，然而事实上，很多时候往往涉及到其他内容。Modifier 的奥秘也等待我们进一步探索。再叙。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Jetpack Compose 正式版发布也已半年了，对我来说，应用到项目中也很久了&lt;small&gt;（参见本人开源项目：&lt;a href=&quot;https://github.com/FunnySaltyFish/FunnyTranslation&quot;&gt;译站&lt;/a&gt;）&lt;/small&gt;。 </summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>Jetpack Compose 中优雅完成数据持久化</title>
    <link href="https://blog.funnysaltyfish.fun/2022/01/25/jetpack-compose-data-saver/"/>
    <id>https://blog.funnysaltyfish.fun/2022/01/25/jetpack-compose-data-saver/</id>
    <published>2022-01-25T09:38:56.000Z</published>
    <updated>2022-02-12T03:51:47.355Z</updated>
    
    <content type="html"><![CDATA[<p>Compose出来也好久了，各种remember和LocalXXX.current也是用得越来越熟。如果能在保持上述写法一致性的情况下完成数据的持久化工作，不是显得挺优雅的吗？<br>基于此，我写出了开源库：<a href="https://github.com/FunnySaltyFish/ComposeDataSaver">ComposeDataSaver: 在Jetpack Compose中优雅完成数据持久化</a><br>简单一瞥：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// booleanExample 初始化值为false</span></span><br><span class="line"><span class="comment">// 之后会自动读取本地数据</span></span><br><span class="line"><span class="keyword">var</span> booleanExample <span class="keyword">by</span> rememberDataSaverState(KEY_BOOLEAN_EXAMPLE, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// 直接赋值即可完成持久化</span></span><br><span class="line">booleanExample = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>可还行？</p><h1 id="ComposeDataSaver"><a href="#ComposeDataSaver" class="headerlink" title="ComposeDataSaver"></a>ComposeDataSaver</h1><p>项目有以下特点：</p><ul><li>  简洁：近似原生的写法</li><li>  低耦合：抽象接口，不限制底层保存算法实现</li><li>  轻巧：默认不引入除Compose外任何第三方库</li><li>  灵活：支持基本的数据类型和自定义类型</li></ul><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7aa3a9c8ae9c4143a84141a36cbd4532~tplv-k3u1fbpfcp-zoom-1.image" alt="Example"></p><hr><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>在<code>settings.gradle</code>引入jitpack仓库位置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url <span class="string">&quot;https://jitpack.io&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在项目<code>build.gradle</code>引入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">        implementation <span class="string">&#x27;com.github.FunnySaltyFish.ComposeDataSaver:data-saver:v1.0.2</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>项目使用<code>DataSaverInterface</code>接口的实现类来保存数据，因此您需要先提供一个此类对象。</p><p>项目默认包含了使用<code>Preference</code>保存数据的实现类<code>DataSaverPreferences</code>，可如下初始化：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init preferences</span></span><br><span class="line"><span class="keyword">val</span> dataSaverPreferences = DataSaverPreferences().apply &#123;</span><br><span class="line">    setContext(context = applicationContext)</span><br><span class="line">&#125;</span><br><span class="line">CompositionLocalProvider(LocalDataSaver provides dataSaverPreferences)&#123;</span><br><span class="line">    ExampleComposable()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此后在<code>ExampleComposable</code>及其子微件内部可使用<code>LocalDataSaver.current</code>获取当前实例</p><p>对于基本数据类型（如String/Int/Boolean）：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// booleanExample 初始化值为false</span></span><br><span class="line"><span class="comment">// 之后会自动读取本地数据</span></span><br><span class="line"><span class="keyword">var</span> booleanExample <span class="keyword">by</span> rememberDataSaverState(KEY_BOOLEAN_EXAMPLE, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// 直接赋值即可完成持久化</span></span><br><span class="line">booleanExample = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>就这么简单！</p><h2 id="自定义存储框架"><a href="#自定义存储框架" class="headerlink" title="自定义存储框架"></a>自定义存储框架</h2><p>我们提供了基于 <a href="https://github.com/Tencent/MMKV">MMKV</a> 或者 <a href="https://developer.android.google.cn/jetpack/androidx/releases/datastore">DataStorePreference</a> 的简单实现</p><h3 id="MMKV"><a href="#MMKV" class="headerlink" title="MMKV"></a>MMKV</h3><ol><li>在上述依赖基础上，额外添加</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// <span class="keyword">if</span> you want to use mmkv</span><br><span class="line">implementation <span class="string">&quot;com.github.FunnySaltyFish.ComposeDataSaver:data-saver-mmkv:v1.0.2&quot;</span></span><br><span class="line">implementation <span class="string">&#x27;com.tencent:mmkv:1.2.12&#x27;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>如下初始化</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MMKV.initialize(applicationContext)</span><br><span class="line"><span class="keyword">val</span> dataSaverMMKV = DataSaverMMKV().apply &#123;</span><br><span class="line">    setKV(newKV = MMKV.defaultMMKV())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CompositionLocalProvider(LocalDataSaver provides dataSaverMMKV)&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="DataStorePreference"><a href="#DataStorePreference" class="headerlink" title="DataStorePreference"></a>DataStorePreference</h3><ol><li>在上述依赖基础上，额外添加</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// <span class="keyword">if</span> you want to use DataStore</span><br><span class="line">implementation <span class="string">&quot;com.github.FunnySaltyFish.ComposeDataSaver:data-saver-data-store-preferences:v1.0.2&quot;</span></span><br><span class="line">def data_store_version = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">implementation <span class="string">&quot;androidx.datastore:datastore:<span class="variable">$data_store_version</span>&quot;</span></span><br><span class="line">implementation <span class="string">&quot;androidx.datastore:datastore-preferences:<span class="variable">$data_store_version</span>&quot;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>如下初始化</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> Context.dataStore : DataStore&lt;Preferences&gt; <span class="keyword">by</span> preferencesDataStore(<span class="string">&quot;dataStore&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> dataSaverDataStorePreferences = DataSaverDataStorePreferences().apply &#123;</span><br><span class="line">    setDataStorePreferences(applicationContext.dataStore)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CompositionLocalProvider(LocalDataSaver provides dataSaverDataStorePreferences)&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="其他存储框架"><a href="#其他存储框架" class="headerlink" title="其他存储框架"></a>其他存储框架</h3><p>只需要实现<code>DataSaverInterface</code>类，并重写<code>saveData</code>和<code>readData</code>方法分别用于保存数据和读取数据</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DataSaverInterface</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">saveData</span><span class="params">(key:<span class="type">String</span>, <span class="keyword">data</span> : <span class="type">T</span>)</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">readData</span><span class="params">(key: <span class="type">String</span>, default : <span class="type">T</span>)</span></span> : T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后将LocalDataSaver提供的对象更改为您自己的类实例</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> dataStore = DataSaverDataStore()</span><br><span class="line">CompositionLocalProvider(LocalDataSaver provides dataStore)&#123;</span><br><span class="line">    ExampleComposable()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后续相同使用即可。</p><h2 id="保存自定义类型"><a href="#保存自定义类型" class="headerlink" title="保存自定义类型"></a>保存自定义类型</h2><p>默认的<code>DataSaverPreferences</code>并不提供自定义类型的保存（当尝试这样做时会报错）。尽管不建议持久化实体类，但您仍可以这样做。您可以选择以下方式实现这一目标。</p><ol><li>重写自己的<code>DataSaverInterface</code>实现类（见上）并实现相关的保存方法</li><li>将实体类序列化为其他基本类型（如String）再储存</li></ol><p>对于第二种方式，您需要为对应实体类添加转换器以实现保存时自动转换为String。方法如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Serializable</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleBean</span></span>(<span class="keyword">var</span> id:<span class="built_in">Int</span>, <span class="keyword">val</span> label:String)</span><br><span class="line"><span class="comment">// ------------ //</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在初始化时调用registerTypeConverters方法注册对应转换方法</span></span><br><span class="line"><span class="comment">// 该方法接收两个参数：实体类Class和对应的转换方法（Lambda表达式）</span></span><br><span class="line">registerTypeConverters(ExampleBean::<span class="keyword">class</span>.java) &#123;</span><br><span class="line">    <span class="keyword">val</span> bean = it <span class="keyword">as</span> ExampleBean</span><br><span class="line">    Json.encodeToString(bean)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整例子见<a href="/app/src/main/java/com/funny/composedatasaver/ExampleActivity.kt">示例项目</a></p><h2 id="更多设置"><a href="#更多设置" class="headerlink" title="更多设置"></a>更多设置</h2><ol><li>如果在某些情况下你不想频繁持久化保存，可设置<code>rememberDataSaverState</code>的<code>autoSave</code>参数为<code>false</code>，此时对象的赋值操作将不会执行持久化操作，您在需要保存的位置手动保存：<code>LocalDataSaver.current.saveData()</code></li></ol><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>新项目，希望大家喜欢。觉得好用不妨来个Star？！<br>虎年快到了，提前祝各位万事顺利、虎虎生风！<br>最后复读一下地址：<a href="https://github.com/FunnySaltyFish/ComposeDataSaver">FunnySaltyFish/ComposeDataSaver: 在Jetpack Compose中优雅完成数据持久化 (github.com)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Compose出来也好久了，各种remember和LocalXXX.current也是用得越来越熟。如果能在保持上述写法一致性的情况下完成数据的持久化工作，不是显得挺优雅的吗？&lt;br&gt;基于此，我写出了开源库：&lt;a href=&quot;https://github.com/Funny</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>Jetpack Compose LazyColumn列表项动画</title>
    <link href="https://blog.funnysaltyfish.fun/2021/12/23/jetpack-compose-lazy-column-item-anim/"/>
    <id>https://blog.funnysaltyfish.fun/2021/12/23/jetpack-compose-lazy-column-item-anim/</id>
    <published>2021-12-23T03:13:59.000Z</published>
    <updated>2022-03-28T02:37:06.940Z</updated>
    
    <content type="html"><![CDATA[<p>具体包括：列表项数据顺序变更时的轮换动画、添加/删除列表项时的小动画、侧滑删除动画</p><p>不废话，本文主要介绍的就是一个修饰符：<code>Modifier.animateItemPlacement()</code>。该修饰符首次出现于Jetpack Compose <strong>1.1.0-beta03</strong>版本（此版本于2021年11月17日发布），目前尚处于试验性阶段。但它能实现的效果是非常有趣的。</p><h3 id="顺序变更-动画"><a href="#顺序变更-动画" class="headerlink" title="顺序变更 动画"></a>顺序变更 动画</h3><p>简单看一个例子：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list <span class="keyword">by</span> remember &#123; mutableStateOf(listOf(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>)) &#125;</span><br><span class="line">  LazyColumn &#123;</span><br><span class="line">      item &#123;</span><br><span class="line">          Button(onClick = &#123; list = list.shuffled() &#125;) &#123;</span><br><span class="line">              Text(<span class="string">&quot;打乱顺序&quot;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      items(items = list, key = &#123; it &#125;) &#123;</span><br><span class="line">          Text(<span class="string">&quot;列表项：<span class="variable">$it</span>&quot;</span>, Modifier.animateItemPlacement())</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>运行效果如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202112181030545.gif" alt="Jetpack Compose-shuffle"></p><p>实现此效果如此简单！</p><h3 id="侧滑删除动画"><a href="#侧滑删除动画" class="headerlink" title="侧滑删除动画"></a>侧滑删除动画</h3><p>在Jetpack Compose中，实现侧滑删除需要用到<code>SwipeToDismiss</code>微件</p><p>简单例子如下：</p><p><em>数据类：</em></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>(<span class="keyword">val</span> id:<span class="built_in">Int</span>, <span class="keyword">val</span> name:String)</span><br></pre></td></tr></table></figure><p><em>微件</em></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> studentList <span class="keyword">by</span> remember &#123;</span><br><span class="line">        mutableStateOf( (<span class="number">1.</span><span class="number">.100</span>).map &#123; Student(it, <span class="string">&quot;Student <span class="variable">$it</span>&quot;</span>) &#125; )</span><br><span class="line">    &#125;</span><br><span class="line">    LazyColumn(</span><br><span class="line">        modifier = Modifier.fillMaxWidth(),</span><br><span class="line">        verticalArrangement = Arrangement.spacedBy(<span class="number">8.</span>dp)</span><br><span class="line">    ) &#123;</span><br><span class="line">        items(studentList, key = &#123;item: Student -&gt; item.id &#125;)&#123; item -&gt;</span><br><span class="line">            <span class="comment">// 侧滑删除所需State</span></span><br><span class="line">            <span class="keyword">val</span> dismissState = rememberDismissState()</span><br><span class="line">            <span class="comment">// 按指定方向触发删除后的回调，在此处变更具体数据</span></span><br><span class="line">            <span class="keyword">if</span>(dismissState.isDismissed(DismissDirection.StartToEnd))&#123;</span><br><span class="line">                studentList = studentList.toMutableList().also &#123;  it.remove(item) &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SwipeToDismiss(</span><br><span class="line">                state = dismissState,</span><br><span class="line">                <span class="comment">// animateItemPlacement() 此修饰符便添加了动画</span></span><br><span class="line">                modifier = Modifier.fillMaxWidth().animateItemPlacement(),</span><br><span class="line">                <span class="comment">// 下面这个参数为触发滑动删除的移动阈值</span></span><br><span class="line">                dismissThresholds = &#123; direction -&gt;</span><br><span class="line">                    FractionalThreshold(<span class="keyword">if</span> (direction == DismissDirection.StartToEnd) <span class="number">0.25f</span> <span class="keyword">else</span> <span class="number">0.5f</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">// 允许滑动删除的方向</span></span><br><span class="line">                directions = setOf(DismissDirection.StartToEnd),</span><br><span class="line">                <span class="comment">// &quot;背景 &quot;，即原来显示的内容被划走一部分时显示什么</span></span><br><span class="line">                background = &#123;</span><br><span class="line">                    <span class="comment">/*保证观看体验，暂时省略此处内容*/</span></span><br><span class="line">                &#125;</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// ”前景“ 显示的内容</span></span><br><span class="line">                <span class="comment">/*省略一部分不重要修饰*/</span></span><br><span class="line">                Text(item.name, Modifier.padding(<span class="number">8.</span>dp), fontSize = <span class="number">28.</span>sp)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202112181049286.gif" alt="Jetpack Compose-swipeToDismiss"></p><p><em>上述代码来自于 <a href="https://stackoverflow.com/questions/70066048/swipetodismiss-inside-lazycolumn-with-animation/70073933#70073933">android - SwipeToDismiss inside LazyColumn with animation - Stack Overflow</a></em></p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>animateItemPlacement</code>修饰符仅在LazyColumn和LazyRow中有效，并且必须<strong>指定key</strong>参数。除重排外，由更改<code>alignment</code>或者<code>arrangement</code>引起的位置改变也会被添加动画。</p><p>此修饰符有一个可选参数：<code>animationSpec: FiniteAnimationSpec&lt;IntOffset&gt;</code>，你可以修改此参数以更改动画效果。</p><h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>这篇文章其实很早之前就想写了，但是一直拖到现在。其实文章写的东西说白了就是介绍个API，但是这个API很有用，而且目前也没有中文资料，于是我就写了。做点自己的贡献吧。</p><p>文章所有代码均可在<a href="https://github.com/FunnySaltyFish/JetpackComposeStudy/tree/master/app/src/main/java/com/funny/compose/study/ui/posta">此处</a>找到，除上述提到的还放了一个Google的官方例子。有兴趣的可以看看。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;具体包括：列表项数据顺序变更时的轮换动画、添加/删除列表项时的小动画、侧滑删除动画&lt;/p&gt;
&lt;p&gt;不废话，本文主要介绍的就是一个修饰符：&lt;code&gt;Modifier.animateItemPlacement()&lt;/code&gt;。该修饰符首次出现于Jetpack Compose</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>Jetpack Compose 通用加载微件的实现</title>
    <link href="https://blog.funnysaltyfish.fun/2021/12/23/jetpack-compose-loading-widget/"/>
    <id>https://blog.funnysaltyfish.fun/2021/12/23/jetpack-compose-loading-widget/</id>
    <published>2021-12-23T03:10:07.000Z</published>
    <updated>2021-12-23T03:13:20.456Z</updated>
    
    <content type="html"><![CDATA[<p>加载数据在Android开发中应该算是非常频繁的操作了，因此简单在Jetpack Compose中实现一个通用的加载微件</p><p>效果如下：</p><p><strong>加载中（转圈圈）</strong></p><table><thead><tr><th>加载中</th><th>加载完成</th></tr></thead><tbody><tr><td><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfe7e51a5b5d4cf4b24f75246def758d~tplv-k3u1fbpfcp-zoom-1.image"></td><td><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2ef0a17ff4f47bb85222d3c08b88295~tplv-k3u1fbpfcp-zoom-1.image"></td></tr></tbody></table><p>另外加载失败后显示失败并可以点击重试</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66aa4f07ba6f49d7893431ec23f8a814~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>实现这个微件其实非常简单，无非就是根据不同的状态加载不同页面</p><h5 id="加载状态Bean"><a href="#加载状态Bean" class="headerlink" title="加载状态Bean"></a>加载状态Bean</h5><p>首先把加载的状态抽象出来，写个数据类</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> sealed class LoadingState&lt;out R&gt; &#123;</span><br><span class="line">     object Loading : LoadingState&lt;Nothing&gt;()</span><br><span class="line">     data class Failure(val error : Throwable) : LoadingState&lt;Nothing&gt;()</span><br><span class="line">     data class Success&lt;T&gt;(val data : T) : LoadingState&lt;T&gt;()</span><br><span class="line"> ​</span><br><span class="line">     val isLoading</span><br><span class="line">         get() = this is Loading</span><br><span class="line">     val isSuccess</span><br><span class="line">         get() = this is Success&lt;*&gt;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>此处借鉴了朱江大佬写的玩安卓Compose版本，在此感谢</p><h5 id="微件"><a href="#微件" class="headerlink" title="微件"></a>微件</h5><p>然后就是加载了。考虑到加载一般耗时，所以用协程。</p><p>写成微件大概就是下面这个样子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> private const val TAG = &quot;LoadingWidget&quot;</span><br><span class="line"> ​</span><br><span class="line"> /**</span><br><span class="line">  * 通用加载微件</span><br><span class="line">  * @author [FunnySaltyFish](https://blog.funnysaltyfish.fun/)</span><br><span class="line">  * @param modifier Modifier 整个微件包围在Box中，此处修饰此Box</span><br><span class="line">  * @param loader  加载函数，返回值为正常加载出的结果</span><br><span class="line">  * @param loading 加载中显示的页面，默认为转圈圈</span><br><span class="line">  * @param failure 加载失败显示的页面，默认为文本，点击可以重新加载（retry即为重新加载的函数）</span><br><span class="line">  * @param success 加载成功后的页面，参数[T]即为返回的结果</span><br><span class="line">  */</span><br><span class="line"> @Composable</span><br><span class="line"> fun &lt;T&gt; LoadingContent(</span><br><span class="line">     modifier: Modifier = Modifier,</span><br><span class="line">     loader : suspend ()-&gt;T,</span><br><span class="line">     loading : @Composable ()-&gt;Unit = &#123; DefaultLoading() &#125;,</span><br><span class="line">     failure : @Composable (error : Throwable, retry : ()-&gt;Unit)-&gt;Unit = &#123; error, retry-&gt;</span><br><span class="line">         DefaultFailure(error, retry)</span><br><span class="line">     &#125;,</span><br><span class="line">     success : @Composable (data : T?)-&gt;Unit</span><br><span class="line"> ) &#123;</span><br><span class="line">     var key by remember &#123;</span><br><span class="line">         mutableStateOf(false)</span><br><span class="line">     &#125;</span><br><span class="line">     val state : LoadingState&lt;T&gt; by produceState&lt;LoadingState&lt;T&gt;&gt;(initialValue = LoadingState.Loading, key)&#123;</span><br><span class="line">         value = try &#123;</span><br><span class="line">             Log.d(TAG, &quot;LoadingContent: loading...&quot;)</span><br><span class="line">             LoadingState.Success(loader())</span><br><span class="line">         &#125;catch (e: Exception)&#123;</span><br><span class="line">             LoadingState.Failure(e)</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     Box(modifier = modifier)&#123;</span><br><span class="line">         when(state)&#123;</span><br><span class="line">             is LoadingState.Loading -&gt; loading()</span><br><span class="line">             is LoadingState.Success&lt;T&gt; -&gt; success((state as LoadingState.Success&lt;T&gt;).data)</span><br><span class="line">             is LoadingState.Failure -&gt; failure((state as LoadingState.Failure).error)&#123;</span><br><span class="line">                 key = !key</span><br><span class="line">                 Log.d(TAG, &quot;LoadingContent: newKey:$key&quot;)</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>基于produceState加载并保存数据，然后根据不同的加载状态显示不同的页面。<br>官方对此函数的翻译如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return an observable [snapshot][androidx.compose.runtime.snapshots.Snapshot] [State] that</span></span><br><span class="line"><span class="comment"> * produces values over time from [key1].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * [producer] is launched when [produceState] enters the composition and is cancelled when</span></span><br><span class="line"><span class="comment"> * [produceState] leaves the composition. If [key1] changes, a running [producer] will be</span></span><br><span class="line"><span class="comment"> * cancelled and re-launched for the new source. [producer] should use [ProduceStateScope.value]</span></span><br><span class="line"><span class="comment"> * to set new values on the returned [State].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The returned [State] conflates values; no change will be observable if</span></span><br><span class="line"><span class="comment"> * [ProduceStateScope.value] is used to set a value that is [equal][Any.equals] to its old value,</span></span><br><span class="line"><span class="comment"> * and observers may only see the latest value if several values are set in rapid succession.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * [produceState] may be used to observe either suspending or non-suspending sources of external</span></span><br><span class="line"><span class="comment"> * data, for example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@sample</span> androidx.compose.runtime.samples.ProduceState</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@sample</span> androidx.compose.runtime.samples.ProduceStateAwaitDispose</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>翻译过来就是：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个可观察的[snapshot][androidx.compose.runtime.snapshots.Snapshot] [State] 对象，它的值由[key1]随时间变化产生.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * [producer] 在 [produceState] 进入 composition 后会被启动，当[produceState] 离开 composition 时被取消. 如果 [key1] 改变, 当前正在运行的 [producer] 将被取消并根据新来源重启. </span></span><br><span class="line"><span class="comment"> * [producer] 应当使用 [ProduceStateScope.value] ，在返回的 [State] 中设置 value 的值.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回的 [State] 与 value 一致; 如若新的值与旧value相等[Any.equals] ，则此变化不会被观察到</span></span><br><span class="line"><span class="comment"> * 如果在短时间内多个新值被赋予，则观察着可能仅能观察到最新的值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * [produceState] 可被用在 suspending / non-suspending 的外部数据来源中，如:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@sample</span> androidx.compose.runtime.samples.ProduceState</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@sample</span> androidx.compose.runtime.samples.ProduceStateAwaitDispose</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>除开数据加载外，上面的代码也给出了几个默认页面。分别有默认的加载页面（转圈圈）和默认的错误页面（点击重试）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> @Composable</span><br><span class="line"> fun DefaultLoading() &#123;</span><br><span class="line">     CircularProgressIndicator()</span><br><span class="line"> &#125;</span><br><span class="line"> ​</span><br><span class="line"> @Composable</span><br><span class="line"> fun DefaultFailure(error: Throwable, retry : ()-&gt;Unit) &#123;</span><br><span class="line">     Text(text = stringResource(id = R.string.loading_error), modifier = Modifier.clickable(onClick = retry))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>此微件使用起来也很简单直接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> LoadingContent(</span><br><span class="line">     modifier = Modifier.align(CenterHorizontally) ,</span><br><span class="line">     loader = (vm.sponsorService::getAllSponsor) </span><br><span class="line"> ) &#123; list -&gt;</span><br><span class="line">     list?.let&#123;</span><br><span class="line">         Column &#123;</span><br><span class="line">             SponsorList(it)</span><br><span class="line">             Text(&quot;加载完成&quot;)</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整代码在这里：<br>加载微件：<a href="https://github.com/FunnySaltyFish/FunnyTranslation/blob/compose/translate/src/main/java/com/funny/translation/translate/ui/widget/LoadingWidget.kt">FunnyTranslation/LoadingWidget.kt</a><br>使用示例：<a href="https://github.com/FunnySaltyFish/FunnyTranslation/blob/d747a153a8ec0ed4c14ad9b2156f93aac1401380/translate/src/main/java/com/funny/translation/translate/ui/thanks/ThanksScreen.kt">FunnyTranslation/ThanksScreen.kt</a></p><p>这只是一个简单方案，由衷欢迎各位探讨。  </p><p>最后再自荐一下我的开源项目（就是上面那个链接），Jetpack Compose实现的翻译软件。不妨点个star，万一什么地方有用呢（逃~</p><p>参考资料：<br><a href="https://juejin.cn/post/7010382907084636168">【开源项目】简单易用的Compose版StateLayout,了解一下~ - 掘金 (juejin.cn)</a></p><h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><p>在于掘金用户@<a href="https://juejin.cn/user/3491704662136541">Petterp</a> 探讨后，他给出了一个可定制化程度更高、适用范围更广的实现。大家可以参见：<a href="https://juejin.cn/post/7042110419439190024">链接</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;加载数据在Android开发中应该算是非常频繁的操作了，因此简单在Jetpack Compose中实现一个通用的加载微件&lt;/p&gt;
&lt;p&gt;效果如下：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;加载中（转圈圈）&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;加</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>基于Jetpack Compose打造一款翻译APP</title>
    <link href="https://blog.funnysaltyfish.fun/2021/11/11/jetpack-compose-funny-trans/"/>
    <id>https://blog.funnysaltyfish.fun/2021/11/11/jetpack-compose-funny-trans/</id>
    <published>2021-11-11T15:18:35.000Z</published>
    <updated>2022-03-28T02:37:06.945Z</updated>
    
    <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p><a href="https://www.coolapk.com/apk/com.funny.translation">FunnyTranslation</a> 是基于Jetpack Compose写成的翻译软件。<strong>它首先是个可以用的软件，其次也是个开源项目。</strong></p><p>开源地址：<a href="https://github.com/FunnySaltyFish/FunnyTranslation">FunnySaltyFish/FunnyTranslation: 基于Jetpack Compose开发的翻译软件，支持多引擎、插件化~ | Jetpack Compose+MVVM+协程+Room (github.com)</a></p><h4 id="运行截图"><a href="#运行截图" class="headerlink" title="运行截图"></a>运行截图</h4><table><thead><tr><th>图片</th><th>图片</th></tr></thead><tbody><tr><td><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202111102032441.jpg" alt="Screenshot_2021-11-07-22-37-33-814_com.funny.tran" style="zoom:33%;" /></td><td><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202111102032313.jpg" alt="Screenshot_2021-11-07-22-39-18-201_com.funny.tran" style="zoom:33%;" /></td></tr><tr><td><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202111102033517.jpg" alt="Screenshot_2021-11-07-22-40-16-339_com.funny.tran" style="zoom:33%;" /></td><td><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202111102033976.jpg" alt="IMG_20211107_223720" style="zoom:33%;" /></td></tr></tbody></table><p>上面截图显示的所有UI都是基于Jetpack Compose搭建的</p><h4 id="挑点啥说一说"><a href="#挑点啥说一说" class="headerlink" title="挑点啥说一说"></a>挑点啥说一说</h4><p>项目开始时觉得没什么，但是真的写起来却发现不少坑。下面简单挑一个例子。</p><h5 id="导航栏内容与底部同步"><a href="#导航栏内容与底部同步" class="headerlink" title="导航栏内容与底部同步"></a>导航栏内容与底部同步</h5><p>软件的导航栏是基于Row自己定义的，摘录部分如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExperimentalAnimationApi</span></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">CustomNavigation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    screens : <span class="type">Array</span>&lt;<span class="type">TranslateScreen</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    currentScreen: <span class="type">TranslateScreen</span> = screens[<span class="number">0</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">    onItemClick: (<span class="type">TranslateScreen</span>) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    Row(</span><br><span class="line">        modifier = Modifier</span><br><span class="line">            .background(MaterialTheme.colors.background)</span><br><span class="line">            .padding(start=<span class="number">8.</span>dp,end=<span class="number">8.</span>dp,bottom = <span class="number">4.</span>dp,top = <span class="number">2.</span>dp)</span><br><span class="line">            .fillMaxWidth(),</span><br><span class="line">        verticalAlignment = Alignment.CenterVertically,</span><br><span class="line">        horizontalArrangement = Arrangement.SpaceAround</span><br><span class="line">    ) &#123;</span><br><span class="line">        screens.forEach&#123; screen-&gt;</span><br><span class="line">            CustomNavigationItem(item = screen, isSelected = currentScreen==screen) &#123;</span><br><span class="line">                onItemClick(screen)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UI实现并不复杂，问题在于用它导航的时候</p><p>首先是点击Icon跳转到对应页面，这一部分<strong>理论上</strong>并不复杂，用<code>navController.navigate(screen.route)</code>就能达到最简单的效果</p><p>然后第一个问题出现了：每次进行navigate的时候，都会重新创建对应的Screen，导致之前页面输入的内容啥的都会被清空；而且每一次点开对应页面就会有一个新的，导致返回的时候需要疯狂点击回退，在不同页面间反复横跳……这肯定不行</p><p>怎么办呢？参考官方文档，说是加上<code>launchSingleTop=true</code>即可，也就是改成下面这样</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">navController.navigate(screen.route)&#123;</span><br><span class="line">    launchSingleTop = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后……然后居然还是不行！我不得其解，终于在过了几天后找到了有效的写法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">navController.navigate(screen.route)&#123;</span><br><span class="line">    <span class="comment">//当底部导航导航到在非首页的页面时，执行手机的返回键 回到首页</span></span><br><span class="line">    popUpTo(navController.graph.startDestinationId)&#123;</span><br><span class="line">        saveState = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从名字就能看出来 跟activity的启动模式中的SingleTop模式一样 避免在栈顶创建多个实例</span></span><br><span class="line">    launchSingleTop = <span class="literal">true</span></span><br><span class="line">    <span class="comment">//切换状态的时候保存页面状态</span></span><br><span class="line">    restoreState = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这应该是从一篇博客上看到的，具体哪篇现在也找不到了。在此表示感谢！</p><p>上面的问题解决了，新的问题又来了：点击返回键时，导航栏也应该跟着变动，回到主页面。这一部分的需求又该怎么实现呢？</p><p>最终在开源项目里面一顿乱翻，终于找到了一个解决方案：在<code>NavController.OnDestinationChangedListener</code>回调中使用<code>hierarchy</code>进行匹配，让页面内容与底部导航栏始终保持同步。相关代码如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> selectedItem = remember &#123; mutableStateOf&lt;TranslateScreen&gt;(TranslateScreen.MainScreen) &#125;</span><br><span class="line"></span><br><span class="line">   DisposableEffect(<span class="keyword">this</span>) &#123;</span><br><span class="line">       <span class="keyword">val</span> listener = NavController.OnDestinationChangedListener &#123; _, destination, _ -&gt;</span><br><span class="line">           <span class="keyword">when</span> &#123;</span><br><span class="line">               destination.hierarchy.any &#123; it.route == TranslateScreen.MainScreen.route &#125; -&gt; &#123;</span><br><span class="line">                   selectedItem.value = TranslateScreen.MainScreen</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// ...省略类似的几个</span></span><br><span class="line">               destination.hierarchy.any &#123; it.route == TranslateScreen.ThanksScreen.route &#125; -&gt; &#123;</span><br><span class="line">                   selectedItem.value = TranslateScreen.ThanksScreen</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       addOnDestinationChangedListener(listener)</span><br><span class="line"></span><br><span class="line">       onDispose &#123;</span><br><span class="line">           removeOnDestinationChangedListener(listener)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>顺便用<code>BackHandler</code>实现了退出时二次确认：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BackHandler(enabled = <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (navController.previousBackStackEntry == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">val</span> curTime = System.currentTimeMillis()</span><br><span class="line">            <span class="keyword">if</span>(curTime - activityVM.lastBackTime &gt; <span class="number">2000</span>)&#123;</span><br><span class="line">                scope.launch &#123; scaffoldState.snackbarHostState.showSnackbar(FunnyApplication.resources.getString(R.string.snack_quit)) &#125;</span><br><span class="line">                activityVM.lastBackTime = curTime</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                exitAppAction()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;AppNavigation: back&quot;</span>)</span><br><span class="line">            <span class="comment">//currentScreen = TranslateScreen.MainScreen</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这部分完整代码在这：<a href="https://github.com/FunnySaltyFish/FunnyTranslation/blob/compose/translate/src/main/java/com/funny/translation/translate/TransActivity.kt">FunnyTranslation/TransActivity.kt at compose · FunnySaltyFish/FunnyTranslation (github.com)</a></p><p>这样类似的地方在应用开发时还有很多，我相信这里的各位能有同感，就不在这搞吐槽大会了。不过既然尝试了一门新技术，就得做好万事碰壁自己探索的准备。这样也才有点Coder的精神嘛~</p><h4 id="然后呢"><a href="#然后呢" class="headerlink" title="然后呢"></a>然后呢</h4><p>应用目前还在完善，但基本功能确实可以用了，希望各位不吝赐教。</p><p>我在写的时候感觉很多小需求很少有中文资料做整理的，于是自己开了个<a href="https://juejin.cn/column/7024350372680433672">专栏</a>，希望能把这些记录下来，供后来者参阅。</p><p>代码现在有些地方写的不太合理，比如加载数据的部分，确实还需要进一步修改。欢迎参与贡献！</p><p>最后再复读一遍地址：<a href="https://github.com/FunnySaltyFish/FunnyTranslation">https://github.com/FunnySaltyFish/FunnyTranslation</a></p><p>如果觉得项目有用的话，欢迎star~</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://www.coolapk.com/apk/com.funny.translation&quot;&gt;FunnyTrans</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>Jetpack Compose 输入法的弹出与隐藏</title>
    <link href="https://blog.funnysaltyfish.fun/2021/10/29/jetpack-compose-soft-keyboard/"/>
    <id>https://blog.funnysaltyfish.fun/2021/10/29/jetpack-compose-soft-keyboard/</id>
    <published>2021-10-29T05:14:43.000Z</published>
    <updated>2021-10-29T05:15:45.574Z</updated>
    
    <content type="html"><![CDATA[<p><em>本文基于Jetpack Compose1.0.4</em></p><p>Jetpack Compose 提供了 <code>SoftwareKeyboardController</code>用于控制软键盘的显示与隐藏，可在Composable中通过<code>LocalSoftwareKeyboardController.current</code>获取</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="隐藏"><a href="#隐藏" class="headerlink" title="隐藏"></a>隐藏</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> keyboard = LocalSoftwareKeyboardController.current</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">onClick = &#123;</span><br><span class="line">    keyboard?.hide()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该操作会试图关闭软键盘，如果因为各种原因软键盘暂时无法关闭，则此操作会被忽略</p><h4 id="打开"><a href="#打开" class="headerlink" title="打开"></a>打开</h4><p>打开软键盘涉及到焦点的获取</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下代码均在 @Composable 函数中</span></span><br><span class="line"><span class="comment">// 焦点请求器</span></span><br><span class="line"><span class="keyword">val</span> focusRequester = remember &#123;</span><br><span class="line">    FocusRequester()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 为需要获取焦点的TextField添加此Modifier</span></span><br><span class="line">BasicTextField(</span><br><span class="line">    modifier = Modifier</span><br><span class="line">        .fillMaxWidth()</span><br><span class="line">        .focusRequester(focusRequester)</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 请求焦点</span></span><br><span class="line">Button(onClick = &#123;</span><br><span class="line">    focusRequester.requestFocus()</span><br><span class="line">    keyboard?.show()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>该操作会试图打开软键盘，如果因为各种原因软键盘暂时无法被打开，则此操作会被忽略</p><h3 id="关于此系列"><a href="#关于此系列" class="headerlink" title="关于此系列"></a>关于此系列</h3><p>此系列<strong>并非完整的系列教程，仅针对Jetpack Compose使用中的具体场景给出对应最小化代码</strong>。目前Jetpack Compose中文资料非常少，希望我能在这方面做出自己的贡献。</p><ul><li>如果要参阅完整项目，可以看我开源的</li></ul><p><a href="https://github.com/FunnySaltyFish/FunnyTranslation/">FunnySaltyFish/FunnyTranslation: 基于Jetpack Compose开发的翻译软件，支持多引擎、插件化~ | Jetpack Compose+MVVM+协程+Room (github.com)</a></p><ul><li>获取系列最新更新：<a href="https://funnysaltyfish.github.io/">FunnySaltyFish’s Blog - FunnySaltyFish的小站</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;em&gt;本文基于Jetpack Compose1.0.4&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Jetpack Compose 提供了 &lt;code&gt;SoftwareKeyboardController&lt;/code&gt;用于控制软键盘的显示与隐藏，可在Composable中通过&lt;code&gt;Lo</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>我们开启爱发电啦</title>
    <link href="https://blog.funnysaltyfish.fun/2021/10/27/start-aifadian/"/>
    <id>https://blog.funnysaltyfish.fun/2021/10/27/start-aifadian/</id>
    <published>2021-10-27T13:28:15.000Z</published>
    <updated>2021-10-27T13:33:59.892Z</updated>
    
    <content type="html"><![CDATA[<h2 id="发电"><a href="#发电" class="headerlink" title="发电"></a>发电</h2><p>为了支持项目更好地发展，自2021年10月27日起，FunnyTranslation启动爱发电。你可以在<a href="https://afdian.net/@funnysaltyfish?tab=home">这里</a>为项目出一份力！</p><p>感谢各位小伙伴的支持！你的每一次发电都会被应用永远记录！</p><h2 id="爱你，Mua"><a href="#爱你，Mua" class="headerlink" title="爱你，Mua~"></a>爱你，Mua~</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;发电&quot;&gt;&lt;a href=&quot;#发电&quot; class=&quot;headerlink&quot; title=&quot;发电&quot;&gt;&lt;/a&gt;发电&lt;/h2&gt;&lt;p&gt;为了支持项目更好地发展，自2021年10月27日起，FunnyTranslation启动爱发电。你可以在&lt;a href=&quot;https://a</summary>
      
    
    
    
    
    <category term="其他" scheme="https://blog.funnysaltyfish.fun/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>在win11安装WSA并直接调试App</title>
    <link href="https://blog.funnysaltyfish.fun/2021/10/21/win11-wsa-explore/"/>
    <id>https://blog.funnysaltyfish.fun/2021/10/21/win11-wsa-explore/</id>
    <published>2021-10-21T09:38:48.000Z</published>
    <updated>2022-03-28T02:37:06.940Z</updated>
    
    <content type="html"><![CDATA[<p>2021年10月20日，微软”千呼万唤始出来“地发布了对WSA的初步支持，win11具备了原生运行android apk的能力</p><p>废话之前，先上图</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211723184.png"></p><p>此窗口可正常拖动、缩放大小，在任务栏独立显示</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211724861.png"></p><p>目前（2021年10月21日）该功能还是预览阶段。</p><p>话不多说，开搞</p><h3 id="安装WSA"><a href="#安装WSA" class="headerlink" title="安装WSA"></a>安装WSA</h3><p><strong>此部分整理自酷安，在此感谢各位大佬</strong></p><p>首先需要确保你的计算机是<strong>win11</strong>最新版本且处于<strong>beta</strong>预览通道</p><ol><li>打开WSA 微软商店链接： <a href="https://www.microsoft.com/store/productId/9P3395VX91NR">这里</a></li></ol><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211724051.png"></p><p>目前仅有美区支持，故选择确定</p><p>登录微软账号后获取子应用并安装</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725505.png"></p><ol start="2"><li>复制打开后的的链接，到 <a href="https://store.rg-adguard.net/">安装包抓包网址</a> 输入上述商店链接，右边要选择<strong>Slow</strong>通道</li></ol><p>(选择Slow通道是因为目前仅有Beta有)</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725673.png" alt="image-20211021160930124"></p><ol start="3"><li>找到最下面名为<br>“MicrosoftCorporationII.WindowsSubsystemForAndroid_***_msixbundle” 的包进行下载</li></ol><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725898.png" alt="image-20211021161024423"></p><ol start="4"><li>下载完毕后以<strong>管理员身份</strong>运行powershell，输入命令安装：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-appxpackage d:\...(刚刚下载文件的路径)</span><br></pre></td></tr></table></figure><p>这时候进度条可能不会变化，耐心等待即可</p><ul><li>如果安装有问题：缺少框架，在上述页面下载Microsoft.UI.Xaml.2.6_2.62108.18004.0_x64__8wekyb3d8bbwe.BlockMap，进行命令行安装</li></ul><ol start="5"><li><p>在菜单栏找到刚刚安装的Windows SubSystem for Android，打开</p></li><li><p>点击右上角的图标，选择刚刚下载的文件</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725630.png"></p></li></ol><ul><li><p>如果说未虚拟化，在<code>设置-应用-可选功能-更多windows功能</code> 开启 <strong>虚拟机平台</strong>并重启</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725774.png" alt="image-20211021161623272"></p></li></ul><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725363.png" alt="image-20211021161651293"></p><p>然后就可以打开这个子系统了</p><h3 id="安装应用"><a href="#安装应用" class="headerlink" title="安装应用"></a>安装应用</h3><p>打开刚刚安装的Windows Subsystem for Android，开启开发人员模式并刷新下面的ip地址</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725181.png"></p><p>打开cmd，使用adb连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb connect 127.0.0.1:58526</span><br></pre></td></tr></table></figure><p>这个ip是上面显示出来的ip</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/Snipaste_2021-10-21_15-34-38.png"></p><p>连接成功后，就可以用adb安装软件了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install APK路径</span><br></pre></td></tr></table></figure><p>安装完后可以在菜单看见安装的应用</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725576.png" alt="image-20211021162540434"></p><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>都连接到ADB了，打开Android Studio就能调试了</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725493.png"></p><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>这种方式有几个缺点</p><ul><li>应用dpi和窗口大小比较奇怪</li><li>Android系统为11，如果你需要Android12的适配还是得模拟器</li><li>功能上不如AS自带的模拟器全</li></ul><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><p>当然也有优点</p><ul><li><p>占用内存小</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://web.funnysaltyfish.fun/temp_img/202110211725987.png"></p></li><li><p>更流畅</p></li><li><p>无需额外模拟器</p></li><li><p>可自由拉伸窗口，检测屏幕适配情况</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;2021年10月20日，微软”千呼万唤始出来“地发布了对WSA的初步支持，win11具备了原生运行android apk的能力&lt;/p&gt;
&lt;p&gt;废话之前，先上图&lt;/p&gt;
&lt;p&gt;&lt;img src= &quot;data:image/gif;base64,R0lGODdhAQABAPAAA</summary>
      
    
    
    
    
    <category term="探索" scheme="https://blog.funnysaltyfish.fun/tags/%E6%8E%A2%E7%B4%A2/"/>
    
    <category term="Android" scheme="https://blog.funnysaltyfish.fun/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Python3.10稳定版特性速览</title>
    <link href="https://blog.funnysaltyfish.fun/2021/10/05/python-3-10-taste/"/>
    <id>https://blog.funnysaltyfish.fun/2021/10/05/python-3-10-taste/</id>
    <published>2021-10-05T14:25:59.000Z</published>
    <updated>2021-10-05T14:30:00.029Z</updated>
    
    <content type="html"><![CDATA[<p>Python 3.10正式发布，你尝鲜了吗？</p><blockquote><p>本文参考自 Python官方文档 ： <a href="https://www.python.org/downloads/release/python-3100/">Python Release Python 3.10.0 | Python.org</a></p></blockquote><p>在正值国庆假期人山人海的2021年10月4号，Python官方<a href="https://www.python.org/downloads/release/python-3100/">正式发布了Python3.10.0</a>。作为一只假期期间宅着不动的coding人，自然是第一时间体验了一波。相较于之前的版本，该版本有以下主要变更。</p><h3 id="新的-Union-Type表达"><a href="#新的-Union-Type表达" class="headerlink" title="新的 Union Type表达"></a>新的 Union Type表达</h3><p>新版本简化了 Union Type 的使用 ，改为更为简洁的<code>|</code> </p><p>旧版：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line">a: <span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>] = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>新的版本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a: <span class="built_in">str</span> | <span class="built_in">int</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>二者完全等价：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>] == <span class="built_in">int</span> | <span class="built_in">str</span> <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p>这类变化在其他地方也相似：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 旧版:</span></span><br><span class="line"><span class="comment"># def f(list: List[Union[int, str]], param: Optional[int]) -&gt; Union[float, str]</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params"><span class="built_in">list</span>: <span class="type">List</span>[<span class="built_in">int</span> | <span class="built_in">str</span>], param: <span class="built_in">int</span> | <span class="literal">None</span></span>) -&gt; <span class="built_in">float</span> | <span class="built_in">str</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">f([<span class="number">1</span>, <span class="string">&quot;abc&quot;</span>], <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 旧版： </span></span><br><span class="line"><span class="comment"># typing.List[typing.Union[str, int]]</span></span><br><span class="line">typing.<span class="type">List</span>[<span class="built_in">str</span> | <span class="built_in">int</span>]</span><br><span class="line"><span class="built_in">list</span>[<span class="built_in">str</span> | <span class="built_in">int</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 旧版： </span></span><br><span class="line"><span class="comment"># typing.Dict[str, typing.Union[int, float]]</span></span><br><span class="line">typing.<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span> | <span class="built_in">float</span>]</span><br><span class="line"><span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span> | <span class="built_in">float</span>]</span><br></pre></td></tr></table></figure><p>该特性也可用于 <code>isinstance</code>和<code>issubclass</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="built_in">isinstance</span>(<span class="string">&quot;FunnySaltyFish&quot;</span>, <span class="built_in">int</span>|<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># True </span></span><br><span class="line"><span class="built_in">issubclass</span>(<span class="built_in">str</span>, <span class="built_in">str</span>|<span class="built_in">int</span>)</span><br></pre></td></tr></table></figure><h3 id="zip-可选严格模式"><a href="#zip-可选严格模式" class="headerlink" title="zip 可选严格模式"></a>zip 可选严格模式</h3><p>zip新增可选参数<code>strict</code>， 当该选项为True时，传入zip的两个可迭代项长度必须相等，否则将抛出 <code>ValueError</code></p><p>旧版（及不加此参数），当二者长度不等时，以长度较小的为准</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">names = [<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>]</span><br><span class="line">numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">z = <span class="built_in">zip</span>(names,numbers)</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> z:</span><br><span class="line">    <span class="built_in">print</span>(each)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># (&#x27;a&#x27;, 1)</span></span><br><span class="line"><span class="comment"># (&#x27;b&#x27;, 2)</span></span><br><span class="line"><span class="comment"># (&#x27;c&#x27;, 3)</span></span><br></pre></td></tr></table></figure><p>设置strict为True</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line">z = <span class="built_in">zip</span>(names,numbers,strict=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">d:\projects\python\learn\Py310探索.py <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">      <span class="number">3</span> numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">      <span class="number">4</span> z = <span class="built_in">zip</span>(names,numbers,strict=<span class="literal">True</span>)</span><br><span class="line">----&gt; <span class="number">5</span> <span class="keyword">for</span> each <span class="keyword">in</span> z:</span><br><span class="line">      <span class="number">6</span>     <span class="built_in">print</span>(each)</span><br><span class="line"></span><br><span class="line">ValueError: <span class="built_in">zip</span>() argument <span class="number">2</span> <span class="keyword">is</span> shorter than argument <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="带括号的上下文管理器"><a href="#带括号的上下文管理器" class="headerlink" title="带括号的上下文管理器"></a>带括号的上下文管理器</h3><p>with可以加括号了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> (CtxManager() <span class="keyword">as</span> example):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> (</span><br><span class="line">    CtxManager1(),</span><br><span class="line">    CtxManager2()</span><br><span class="line">):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> (CtxManager1() <span class="keyword">as</span> example,</span><br><span class="line">      CtxManager2()):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> (CtxManager1(),</span><br><span class="line">      CtxManager2() <span class="keyword">as</span> example):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> (</span><br><span class="line">    CtxManager1() <span class="keyword">as</span> example1,</span><br><span class="line">    CtxManager2() <span class="keyword">as</span> example2</span><br><span class="line">):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pathlib</span><br><span class="line">p = pathlib.Path()</span><br><span class="line">p1 = p/<span class="string">&quot;text1.txt&quot;</span> <span class="comment"># 内容：文本1的内容</span></span><br><span class="line">p2 = p/<span class="string">&quot;text2.txt&quot;</span> <span class="comment"># 内容：文本2的内容</span></span><br><span class="line"><span class="keyword">with</span>(</span><br><span class="line">    p1.<span class="built_in">open</span>(encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f1,</span><br><span class="line">    p2.<span class="built_in">open</span>(encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f2</span><br><span class="line">):</span><br><span class="line">    <span class="built_in">print</span>(f1.read(), f2.read(), sep=<span class="string">&quot;\n&quot;</span>) </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 文本1的内容</span></span><br><span class="line">    <span class="comment"># 文本2的内容</span></span><br></pre></td></tr></table></figure><h3 id="显式类型别名"><a href="#显式类型别名" class="headerlink" title="显式类型别名"></a>显式类型别名</h3><p>使用 TypeAlias 显式标注类型别名，提高可读性</p><p>旧的方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="built_in">int</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plus_int</span>(<span class="params">a:x,b:x</span>) -&gt; x:</span></span><br><span class="line">    <span class="keyword">return</span> a+b</span><br></pre></td></tr></table></figure><p>可以看到，x很容易被搞混</p><p>新的方式：使用 TypeAlias表明这是个别名 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypeAlias</span><br><span class="line">x : TypeAlias = <span class="built_in">int</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plus_int</span>(<span class="params">a:x,b:x</span>) -&gt; x:</span></span><br><span class="line">    <span class="keyword">return</span> a+b</span><br></pre></td></tr></table></figure><h3 id="match…case语句"><a href="#match…case语句" class="headerlink" title="match…case语句"></a>match…case语句</h3><p>对，就是其他语言的<code>switch-case</code>，python终于提供了支持，还是加强版的</p><p>完整语法参见：<a href="https://www.python.org/dev/peps/pep-0634/#id25">PEP 634 – Structural Pattern Matching: Specification | Python.org</a></p><p>举几个例子：</p><p>基本的类型匹配：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">day = <span class="number">6</span></span><br><span class="line">match day:</span><br><span class="line">    case <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;星期一&quot;</span>)</span><br><span class="line">    case <span class="number">6</span> | <span class="number">7</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;周末&quot;</span>)</span><br><span class="line">    case _ : </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;其他情况&quot;</span>)</span><br></pre></td></tr></table></figure><p>subject：这在处理命令行参数的时候特别有用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @copyright : [FunnySaltyFish](https://funnysaltyfish.github.io)</span></span><br><span class="line"><span class="string">    @date : 2021/10/05 21:08:42</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;save 1.txt&quot;</span></span><br><span class="line"><span class="comment"># 试着把command改成 list / copy 1.txt 2.txt 看看效果</span></span><br><span class="line">match command.split(<span class="string">&quot; &quot;</span>):</span><br><span class="line">    case [<span class="string">&quot;list&quot;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;列出文件~&quot;</span>)</span><br><span class="line">    case [<span class="string">&quot;save&quot;</span>, file_name]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;保存文件到 <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line">    case [<span class="string">&quot;copy&quot;</span>,source,target]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;拷贝 <span class="subst">&#123;source&#125;</span> -&gt; <span class="subst">&#123;target&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>也可以匹配对象：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">Person</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, <span class="built_in">id</span>: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span>(<span class="params">Person</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">a = Student(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># a = Student(2)</span></span><br><span class="line"><span class="comment"># a = Teacher(&quot;FunnySaltyFish&quot;)</span></span><br><span class="line">match a:</span><br><span class="line">    case Student(<span class="built_in">id</span> = <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;这是位学生，且id正好是2&quot;</span>)</span><br><span class="line">    case Student():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;这是学生，id为<span class="subst">&#123;a.<span class="built_in">id</span>&#125;</span>&quot;</span>)</span><br><span class="line">    case Teacher():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;这是老师, 姓名为<span class="subst">&#123;a.name&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>当然也可以匹配字典：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span> : <span class="string">&quot;李四&quot;</span>, <span class="comment"># 张三</span></span><br><span class="line">    <span class="string">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">    <span class="string">&quot;hobby&quot;</span> : <span class="string">&quot;阅读&quot;</span></span><br><span class="line">&#125; </span><br><span class="line">match d:</span><br><span class="line">    case &#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>, **args&#125;:</span><br><span class="line">        <span class="comment"># **收集其他参数</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;这是张三&quot;</span>, args) <span class="comment"># 这是张三 &#123;&#x27;age&#x27;: 18, &#x27;hobby&#x27;: &#x27;阅读&#x27;&#125;</span></span><br><span class="line">    case &#123;<span class="string">&quot;name&quot;</span> : name , <span class="string">&quot;age&quot;</span> : age, <span class="string">&quot;hobby&quot;</span>: hobby&#125;:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;我叫<span class="subst">&#123;name&#125;</span>, 今年<span class="subst">&#123;age&#125;</span>岁, 喜欢<span class="subst">&#123;hobby&#125;</span>&quot;</span>) <span class="comment">#我叫李四,今年18岁，喜欢阅读</span></span><br></pre></td></tr></table></figure><p>更复杂的还有结合Guard、匹配捕获等使用，具体可以参见：<a href="https://www.python.org/dev/peps/pep-0635/#id15">PEP 635 – Structural Pattern Matching: Motivation and Rationale | Python.org</a> 和 <a href="https://www.python.org/dev/peps/pep-0636/">PEP 636 – Structural Pattern Matching: Tutorial | Python.org</a></p><h3 id="更友好的报错提示"><a href="#更友好的报错提示" class="headerlink" title="更友好的报错提示"></a>更友好的报错提示</h3><p>现在，当你的括号、引号未闭合时，python会抛出更加清晰明了的错误</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span> = <span class="string">&quot;未闭合的str</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">File &quot;</span>d:\projects\python\learn\Py310探索.py<span class="string">&quot;, line 90</span></span><br><span class="line"><span class="string">    str = &quot;</span>未闭合的<span class="built_in">str</span></span><br><span class="line">          ^</span><br><span class="line">SyntaxError: unterminated string literal (detected at line <span class="number">90</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">  File <span class="string">&quot;d:\projects\python\learn\Py310探索.py&quot;</span>, line <span class="number">91</span></span><br><span class="line">    arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line">          ^</span><br><span class="line">SyntaxError: <span class="string">&#x27;[&#x27;</span> was never closed</span><br></pre></td></tr></table></figure><h3 id="其他一些更新："><a href="#其他一些更新：" class="headerlink" title="其他一些更新："></a>其他一些更新：</h3><h4 id="distutils-被弃用"><a href="#distutils-被弃用" class="headerlink" title="distutils 被弃用"></a>distutils 被弃用</h4><p>推荐使用 setuptools</p><h4 id="需要-OpenSSL-1-1-1-及以上版本"><a href="#需要-OpenSSL-1-1-1-及以上版本" class="headerlink" title="需要  OpenSSL 1.1.1 及以上版本"></a>需要  OpenSSL 1.1.1 及以上版本</h4><h4 id="移除-Py-UNICODE编码API"><a href="#移除-Py-UNICODE编码API" class="headerlink" title="移除 Py_UNICODE编码API"></a>移除 Py_UNICODE编码API</h4><h4 id="PyUnicodeObject的wstr被弃用，并将在之后移除"><a href="#PyUnicodeObject的wstr被弃用，并将在之后移除" class="headerlink" title="PyUnicodeObject的wstr被弃用，并将在之后移除"></a>PyUnicodeObject的wstr被弃用，并将在之后移除</h4><p>完。摸鱼去了。</p><blockquote><p>作者：FunnySaltyFish<br>主页：<a href="https://funnysaltyfish.github.io/">https://funnysaltyfish.github.io/</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Python 3.10正式发布，你尝鲜了吗？&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本文参考自 Python官方文档 ： &lt;a href=&quot;https://www.python.org/downloads/release/python-3100/&quot;&gt;Python Rele</summary>
      
    
    
    
    
    <category term="Python" scheme="https://blog.funnysaltyfish.fun/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Jitpack.io ERROR No build artifacts found一路踩坑的解决【Gradle 7.0+,Kotlin 1.5+】</title>
    <link href="https://blog.funnysaltyfish.fun/2021/07/26/jitpack-build-error-solve/"/>
    <id>https://blog.funnysaltyfish.fun/2021/07/26/jitpack-build-error-solve/</id>
    <published>2021-07-26T10:15:04.000Z</published>
    <updated>2021-07-26T10:18:57.942Z</updated>
    
    <content type="html"><![CDATA[<p>前段时间上传我的项目<a href="https://github.com/FunnySaltyFish/CMaterialColors/">CMaterialColors</a>到Jitpack时一直出现错误，最早报出的错误是：</p><blockquote><p>Found artifact: com.funny.cmaterialcolors:release:1.0.0<br>Found artifact: com.funny.cmaterialcolors:release:<br>2021-06-15T08:52:13.4704949Z<br>Exit code: 0<br>ERROR: No build artifacts found</p></blockquote><p>实话说当时非常无语，经过几次失败的尝试后我决定去看看完整的报错日志，然后发现了中间其实就有报错：</p><blockquote><p>An exception occurred applying plugin request [id: ‘com.android.application’]<br>Failed to apply plugin ‘com.android.internal.application’.<br>Android Gradle plugin requires Java 11 to run. You are currently using Java 1.8.<br>     You can try some of the following options:<br>       - changing the IDE settings.<br>       - changing the JAVA_HOME environment variable.<br>       - changing <code>org.gradle.java.home</code> in <code>gradle.properties</code>.</p></blockquote><p>意思是要去修改默认的Java编译环境，查阅Jitpack官方英文<a href="https://github.com/jitpack/jitpack.io/blob/master/BUILDING.md">文档</a>，找到了如下解决措施：</p><blockquote><p>You can create a jitpack.yml file in the root of your repository and override the build commands:</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdk:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openjdk9</span></span><br></pre></td></tr></table></figure><p>翻译成中文就是：</p><ul><li>在<strong>项目根目录</strong>创建文件<code>jitpack.yml</code></li><li>在里面添加上述文本即可指定编译用的Java版本</li></ul><p>于是，在解决完了这个问题后，我怀着信心满满的心情再次提交，而这一次……<br>然并卵，错误还是存在……</p><p>老实说这个错误真是非常迷惑的。我又尝试了一些方法，均未果。然后没办法，继续回去看文档呗。<br>我项目里面用的是<code>maven-publish</code>插件，官方文档说执行的命令是</p><blockquote><p>./gradlew build publishToMavenLocal</p></blockquote><p>然后在终端里面试了试，发现居然报错了！<br>然后又是按对应的报错改Bug，直到本地可以正常执行此命令<br>改完之后信心满满的提交，结果新的错误产生了……</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Could not resolve compiler classpath. Check <span class="keyword">if</span> Kotlin Gradle plugin repository is configured <span class="keyword">in</span> project <span class="string">&#x27;:app&#x27;</span>.</span><br><span class="line"></span><br><span class="line">FAILURE: Build failed with an exception.</span><br><span class="line"></span><br><span class="line">* What went wrong:</span><br><span class="line">Could not determine the dependencies of task <span class="string">&#x27;:app:compileReleaseKotlin&#x27;</span>.</span><br><span class="line">&gt; Could not resolve all files <span class="keyword">for</span> configuration <span class="string">&#x27;:app:kotlinCompilerClasspath&#x27;</span>.</span><br><span class="line">   &gt; Cannot resolve external dependency org.jetbrains.kotlin:kotlin-compiler-embeddable:1.5.10 because no repositories are defined.</span><br><span class="line">     Required by:</span><br><span class="line">         project :app</span><br></pre></td></tr></table></figure><p>我TM！！！<br>网上搜根本搜不到对应的解决措施，没办法一点点改呗。<br>又试了几次，还是不行。<br>这时想到了一个办法，我开始去翻Github，找与我的项目使用的依赖库相似的项目（kotlin 1.5，Gradle 7.0，Compose 1.0.0-rc01），然后对照它的项目文件一个个看。<br>最后找到了差异，我的<code>lib/build.gradle</code>里面少写了这一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// kotlin</span><br><span class="line">implementation <span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk8:<span class="variable">$kotlin_version</span>&quot;</span></span><br></pre></td></tr></table></figure><p>终于，在版本都累加到<code>1.0.21</code>后，我终终终终终于提交成功了！<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/9fdcfa0d460e44bea18538ff9999a8cf.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="终于"></p><p>那一刻，真的，难以言表！！！</p><p>最后吐个槽，各位博主大大抄袭文章能不能有个限度，nm各个文章都在用着早已被废弃的插件，jdk11的问题都没得人指出。简直了。。。</p><p><strong>如果你需要参考对应文件，可以点击这个开源库：<a href="https://github.com/FunnySaltyFish/CMaterialColors/">CMaterialColors</a></strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;前段时间上传我的项目&lt;a href=&quot;https://github.com/FunnySaltyFish/CMaterialColors/&quot;&gt;CMaterialColors&lt;/a&gt;到Jitpack时一直出现错误，最早报出的错误是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;F</summary>
      
    
    
    
    
    <category term="Jitpack" scheme="https://blog.funnysaltyfish.fun/tags/Jitpack/"/>
    
  </entry>
  
  <entry>
    <title>Jetpack Compose异步加载图片的实现</title>
    <link href="https://blog.funnysaltyfish.fun/2021/07/14/jetpack-compose-sync-load-image/"/>
    <id>https://blog.funnysaltyfish.fun/2021/07/14/jetpack-compose-sync-load-image/</id>
    <published>2021-07-14T11:25:27.000Z</published>
    <updated>2021-07-14T11:29:52.771Z</updated>
    
    <content type="html"><![CDATA[<p>本文使用两种方式，实现Compose中图片的异步加载</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Android开发中异步加载图片是非常常见的需求。本文将带你实现这一需求。<br>本文将分为如下两个方面：</p><ol><li>自己写函数</li><li>用开源库</li></ol><hr><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="借助Glide库自己写"><a href="#借助Glide库自己写" class="headerlink" title="借助Glide库自己写"></a>借助Glide库自己写</h3><p>Glide开源库基本上成为了Android中加载图片的首选，其简单易用的API和强大的缓存能力让这一过程变得十分方便。<br>自然在Jetpack Compose中也可以使用。</p><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><p>在模块中的<code>build.gradle</code>中加入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&#x27;com.github.bumptech.glide:glide:4.12.0&#x27;</span></span><br><span class="line">annotationProcessor <span class="string">&#x27;com.github.bumptech.glide:compiler:4.12.0&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="编写函数"><a href="#编写函数" class="headerlink" title="编写函数"></a>编写函数</h4><p>如何让Glide把图片加载到Compose组件上去呢？我们可以利用其提供的<code>into(Target)</code>指定自定义的target，再搭配上<code>mutableState&lt;Bitmap&gt;</code>的返回值，即可实现在图片加载完成后Compose自动更新<br>图片加载时一般会有一个默认的<code>loading</code>图，我们可以如法炮制，让Glide先帮我们加载一张本地图片，然后再去加载网络图片即可。<br>编写的函数如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用Glide库加载网络图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> [FunnySaltyFish](https://funnysaltyfish.github.io)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-07-14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context Context 合理的Context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url String 加载的图片URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> defaultImageId Int 默认加载的本地图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> MutableState&lt;Bitmap?&gt; 加载完成（失败为null）的Bitmap-State</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loadImage</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    context: <span class="type">Context</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    url: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@DrawableRes</span> defaultImageId: <span class="type">Int</span> = R.drawable.load_holder</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: MutableState&lt;Bitmap?&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> TAG = <span class="string">&quot;LoadImage&quot;</span></span><br><span class="line">    <span class="keyword">val</span> bitmapState: MutableState&lt;Bitmap?&gt; = mutableStateOf(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为请求加上 Headers ，提高访问成功率</span></span><br><span class="line">    <span class="keyword">val</span> glideUrl = GlideUrl(url,LazyHeaders.Builder().addHeader(<span class="string">&quot;User-Agent&quot;</span>,<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.67&quot;</span>).build())</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先加载本地图片</span></span><br><span class="line">    Glide.with(context)</span><br><span class="line">        .asBitmap()</span><br><span class="line">        .load(defaultImageId)</span><br><span class="line">        .into(<span class="keyword">object</span> : CustomTarget&lt;Bitmap&gt;() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceReady</span><span class="params">(resource: <span class="type">Bitmap</span>, transition: <span class="type">Transition</span>&lt;<span class="type">in</span> <span class="type">Bitmap</span>&gt;?)</span></span> &#123;</span><br><span class="line">                <span class="comment">//自定义Target，在加载完成后将图片资源传递给bitmapState</span></span><br><span class="line">                bitmapState.value = resource</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLoadCleared</span><span class="params">(placeholder: <span class="type">Drawable</span>?)</span></span> &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//然后再加载网络图片</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Glide.with(context)</span><br><span class="line">            .asBitmap()</span><br><span class="line">            .load(glideUrl)</span><br><span class="line">            .into(<span class="keyword">object</span> : CustomTarget&lt;Bitmap&gt;() &#123;</span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceReady</span><span class="params">(resource: <span class="type">Bitmap</span>, transition: <span class="type">Transition</span>&lt;<span class="type">in</span> <span class="type">Bitmap</span>&gt;?)</span></span> &#123;</span><br><span class="line">                    <span class="comment">//自定义Target，在加载完成后将图片资源传递给bitmapState</span></span><br><span class="line">                    bitmapState.value = resource</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLoadCleared</span><span class="params">(placeholder: <span class="type">Drawable</span>?)</span></span> &#123;&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (glideException: GlideException) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;loadImage: <span class="subst">$&#123;glideException.rootCauses&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bitmapState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h4><p>简单的例子如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">LoadPicture</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    url : <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> imageState = loadImage(</span><br><span class="line">        context = LocalContext.current,</span><br><span class="line">        url = url,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    Card(modifier = Modifier</span><br><span class="line">        .padding(<span class="number">4.</span>dp)</span><br><span class="line">        .clickable &#123; &#125;) &#123;</span><br><span class="line">        <span class="comment">//如果图片加载成功</span></span><br><span class="line">        imageState.value?.let &#123;</span><br><span class="line">            Image(</span><br><span class="line">                bitmap = it.asImageBitmap(),</span><br><span class="line">                contentDescription = <span class="string">&quot;&quot;</span>,</span><br><span class="line">                modifier = Modifier</span><br><span class="line">                    .padding(<span class="number">4.</span>dp)</span><br><span class="line">                    .fillMaxWidth()</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">LazyColumn &#123;</span><br><span class="line">    <span class="keyword">val</span> urls = arrayListOf&lt;String&gt;()</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">500.</span><span class="number">.550</span>)&#123;urls.add(<span class="string">&quot;https://nyc3.digitaloceanspaces.com/food2fork/food2fork-static/featured_images/<span class="variable">$i</span>/featured_image.png&quot;</span>)&#125;</span><br><span class="line">    itemsIndexed(urls)&#123; _ , url -&gt; LoadPicture(url = url)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下图所示：<br><strong>加载中</strong></p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210714190357323.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="加载中"><br><strong>加载完毕</strong><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210714190734214.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="加载成功"><br><code>P.S.：别忘了声明网络权限哦！</code></p><h3 id="借助开源框架"><a href="#借助开源框架" class="headerlink" title="借助开源框架"></a>借助开源框架</h3><p>事实上，谷歌在其<a href="https://developer.android.google.cn/jetpack/compose/libraries">开发文档</a>中也给出了示例，用的是开源库<a href="https://github.com/google/accompanist">Accompanist</a><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210714191039630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="谷歌的官方例子"><br>所以我们也可以用这个</p><h4 id="简单的例子"><a href="#简单的例子" class="headerlink" title="简单的例子"></a>简单的例子</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&quot;com.google.accompanist:accompanist-coil:0.13.0&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> [FunnySaltyFish](https://funnysaltyfish.github.io)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-07-14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url 加载的链接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">LoadPicture2</span><span class="params">(url:<span class="type">String</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">val</span> painter = rememberCoilPainter(url)</span><br><span class="line"></span><br><span class="line">    Box &#123;</span><br><span class="line">        Image(</span><br><span class="line">            painter = painter,</span><br><span class="line">            contentDescription = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">when</span> (painter.loadState) &#123;</span><br><span class="line">            <span class="keyword">is</span> ImageLoadState.Loading -&gt; &#123;</span><br><span class="line">                <span class="comment">// 显示一个加载中的进度条</span></span><br><span class="line">                CircularProgressIndicator(Modifier.align(Alignment.Center))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">is</span> ImageLoadState.Error -&gt; &#123;</span><br><span class="line">                <span class="comment">// 如果发生了什么错误，你可以在这里写</span></span><br><span class="line">                Text(text = <span class="string">&quot;发生错误&quot;</span>, color = MaterialColors.RedA200)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; Text(text = <span class="string">&quot;未知情况&quot;</span>, color = MaterialColors.PurpleA400)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210714191350243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210714191350753.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="加载中"></p><p><code>P.S.：如果想更好的看到加载的情况，可以在模拟器设置中将网络类型设置为较慢的类型</code></p><h4 id="一些限制"><a href="#一些限制" class="headerlink" title="一些限制"></a>一些限制</h4><p>个人感觉，这种方式有以下的问题：</p><ul><li>滑动加载时不如Glide流畅</li><li>对Kotlin版本有要求，如（截止文章写作时）最新的<code>0.13.0</code>版就必须用<code>kotlin1.5</code>及以上版本，否则就会编译出错</li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.youtube.com/watch?v=ktOWiLx83bQ&list=PLgCYzUzKIBE_I0_tU5TvkfQpnmrP_9XV8&index=20">视频</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本文使用两种方式，实现Compose中图片的异步加载&lt;/p&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;Android开发中异步加载图片是非常常见的需求。本文将带你实现这一需求</summary>
      
    
    
    
    
    <category term="Jetpack Compose" scheme="https://blog.funnysaltyfish.fun/tags/Jetpack-Compose/"/>
    
  </entry>
  
  <entry>
    <title>从C到Python</title>
    <link href="https://blog.funnysaltyfish.fun/2021/06/01/from-c-to-python/"/>
    <id>https://blog.funnysaltyfish.fun/2021/06/01/from-c-to-python/</id>
    <published>2021-06-01T00:00:00.000Z</published>
    <updated>2021-10-21T12:17:33.121Z</updated>
    
    <content type="html"><![CDATA[<h2 id="从C到Python"><a href="#从C到Python" class="headerlink" title="从C到Python"></a>从C到Python</h2><p>本文适合于那些有过一定C语言基础并希望学习Python的人，仅在简明指出二者的过渡。</p><p>首先请记住：Python入门<strong>非常容易</strong>，所以在阅读本文时，请不必抱有任何心理压力！<strong>看不懂的跳过就行，日后自然会理解</strong></p><hr><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ol><li>目前Python主流版本有2.X和3.X，本文使用的版本为<code>Python 3.8.5</code></li><li>C环境则为 gcc 8.1.0</li><li>如对应知识点下面有小字，则为补充及说明内容，您可按需阅读</li></ol><h3 id="宏观"><a href="#宏观" class="headerlink" title="宏观"></a>宏观</h3><p>下面从大体上阐释二者的部分区别</p><ol><li>Python代码写起来比C语言<strong>简明得多</strong></li><li>Python是一门<strong>面向对象</strong>的语言，C语言则是<strong>面向过程</strong></li><li>Python是一门解释型语言，C则是编译型语言</li></ol><p>上面的话有个概念就好，不必死磕。</p><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>在C语言中，变量分为声明和定义，且需要指出详细的类型，如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//变量声明</span></span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">float</span> f;</span><br><span class="line">   <span class="keyword">double</span> d;</span><br><span class="line">   <span class="keyword">char</span> c;</span><br><span class="line">   <span class="keyword">long</span> l;</span><br><span class="line">   <span class="keyword">short</span> s;</span><br></pre></td></tr></table></figure><p>Python作为解释型语言，变量无需指定类型，赋值即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var_string = <span class="string">&quot;这是字符串变量&quot;</span></span><br><span class="line">var_number = <span class="number">1</span></span><br><span class="line">var_list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">var_tuple = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">var_set = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">var_dict = &#123;<span class="string">&quot;key&quot;</span>:<span class="string">&quot;value&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>上述例子展示了python 六种基本数据类型<br>从中也可以获取关于Python3的几个特点：</p><ul><li>变量的名字符合 <strong>小写字母+下划线+数字</strong> 的组合</li><li>语句末尾不需要分号</li><li>天然支持中文 <em>（准确来说是Unicode编码）</em></li></ul><p>由于Python是动态语言，不同类型的对象可以赋值给同一个变量，如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;先是字符串&quot;</span></span><br><span class="line">a = <span class="number">1.0</span></span><br></pre></td></tr></table></figure><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><h4 id="数字-Number"><a href="#数字-Number" class="headerlink" title="数字 Number"></a>数字 Number</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python3 支持 int、float、bool、complex（复数）</span></span><br><span class="line">a = <span class="number">45</span></span><br><span class="line">b = <span class="number">3.0</span></span><br><span class="line">c = <span class="literal">True</span></span><br><span class="line">d = <span class="number">4</span>+<span class="number">7j</span></span><br></pre></td></tr></table></figure><p>上面的<code>#</code>表示单行注释，类似于C的<code>//</code></p><h4 id="字符串-String"><a href="#字符串-String" class="headerlink" title="字符串 String"></a>字符串 String</h4><p>字符串，你可以拿字符数组<code>char[]/char*</code>理解，但是强大的多</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">text1 = <span class="string">&quot;普通字符串&quot;</span></span><br><span class="line">text2 = <span class="string">r&quot;原始字符串，里面是什么就输出什么&quot;</span></span><br><span class="line">text3 = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">多行字符串</span></span><br><span class="line"><span class="string">里面的</span></span><br><span class="line"><span class="string">东西</span></span><br><span class="line"><span class="string">可以换行写</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>要理解<code>r&quot;&quot;</code>，可以参照下面的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">normal = <span class="string">&quot;这是第一行\n这是第二行&quot;</span></span><br><span class="line">raw = <span class="string">r&quot;这是第一行\n这也是第一行&quot;</span></span><br><span class="line"><span class="built_in">print</span>(normal) <span class="comment">#这是第一行</span></span><br><span class="line">              <span class="comment">#这是第二行</span></span><br><span class="line"><span class="built_in">print</span>(raw)    <span class="comment">#这是第一行\n这也是第一行</span></span><br></pre></td></tr></table></figure><p>可以用 <strong>+</strong> 连接两个字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;Hello&quot;</span>+<span class="string">&quot; &quot;</span>+<span class="string">&quot;World!&quot;</span></span><br><span class="line"><span class="built_in">print</span>(text) <span class="comment">#Hello World!</span></span><br></pre></td></tr></table></figure><p>用  <strong>*</strong> 将其重复</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;一部分&quot;</span></span><br><span class="line">text *= <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(text) <span class="comment">#自行运行尝试</span></span><br></pre></td></tr></table></figure><h4 id="列表-List"><a href="#列表-List" class="headerlink" title="列表 List"></a>列表 List</h4><p>类似于数组，但具有下面的特性</p><ul><li>长度无限</li><li>里面可以随便装任何类型的对象<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>,<span class="string">&quot;字符串&quot;</span>,<span class="literal">True</span>]</span><br><span class="line">number = l[<span class="number">0</span>] <span class="comment">#1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>如果指定的index不存在，则会报错<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l[<span class="number">3</span>]</span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#   File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span></span><br><span class="line"><span class="comment"># IndexError: list index out of range</span></span><br></pre></td></tr></table></figure>可以用 <strong>append</strong> 方法添加一个元素<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l.append(<span class="string">&quot;新元素&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(l) <span class="comment">#[1, &#x27;字符串&#x27;, True, &#x27;新元素&#x27;]</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>extend</strong>添加多个</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l.extend([<span class="string">&quot;第一个&quot;</span>,<span class="string">&quot;第二个&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(l) <span class="comment">#[1, &#x27;字符串&#x27;, True, &#x27;新元素&#x27;, &#x27;第一个&#x27;, &#x27;第二个&#x27;]</span></span><br></pre></td></tr></table></figure><p><strong>pop</strong> 删除某个元素并返回被删的那个</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">l.pop()</span><br><span class="line"><span class="string">&#x27;第二个&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l</span><br><span class="line">[<span class="number">1</span>, <span class="string">&#x27;字符串&#x27;</span>, <span class="literal">True</span>, <span class="string">&#x27;新元素&#x27;</span>, <span class="string">&#x27;第一个&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l.pop(<span class="number">3</span>)</span><br><span class="line"><span class="string">&#x27;新元素&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l</span><br><span class="line">[<span class="number">1</span>, <span class="string">&#x27;字符串&#x27;</span>, <span class="literal">True</span>, <span class="string">&#x27;第一个&#x27;</span>]</span><br></pre></td></tr></table></figure><p>上面的 <code>&gt;&gt;&gt;</code>代表在Python交互式环境中，安装完Python后即可使用</p><p>其余复杂细节之后再讲</p><h4 id="元组-Tuple"><a href="#元组-Tuple" class="headerlink" title="元组 Tuple"></a>元组 Tuple</h4><p>类似于列表，但是长度固定，且内容不可被修改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;tuple_test = (<span class="string">&quot;第一个&quot;</span>,<span class="string">&quot;第二个&quot;</span>,<span class="string">&quot;第三个&quot;</span>)</span><br><span class="line">&gt;&gt;&gt;<span class="built_in">print</span>(tuple_test[<span class="number">2</span>])</span><br><span class="line">第三个</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tuple_test[<span class="number">2</span>] = <span class="string">&quot;试图修改&quot;</span> </span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">&#x27;tuple&#x27;</span> <span class="built_in">object</span> does <span class="keyword">not</span> support item assignment</span><br></pre></td></tr></table></figure><p>未完待续</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;从C到Python&quot;&gt;&lt;a href=&quot;#从C到Python&quot; class=&quot;headerlink&quot; title=&quot;从C到Python&quot;&gt;&lt;/a&gt;从C到Python&lt;/h2&gt;&lt;p&gt;本文适合于那些有过一定C语言基础并希望学习Python的人，仅在简明指出二者的过渡。</summary>
      
    
    
    
    <category term="教程" scheme="https://blog.funnysaltyfish.fun/categories/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="教程" scheme="https://blog.funnysaltyfish.fun/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="Python" scheme="https://blog.funnysaltyfish.fun/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Flutter卡在Running ‘gradle assembleDebug‘最完整解决</title>
    <link href="https://blog.funnysaltyfish.fun/2021/05/27/flutter-gradle-assembleDebug-fix/"/>
    <id>https://blog.funnysaltyfish.fun/2021/05/27/flutter-gradle-assembleDebug-fix/</id>
    <published>2021-05-27T14:03:41.000Z</published>
    <updated>2021-05-27T14:10:32.831Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>结合csdn+博客园+github+Stack Overflow+自己尝试，解决该问题！<br>今天突发奇想试一下flutter，按照网上教程配置完后（flutter doctor）全部合格，运行却卡在了Running ‘gradle assembleDebug’。打开任务管理器，AS的网络占用相当之低，一会就为0。找了各种方法，最后搞出了这一套<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124455645.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul><li>准备一个可以完成编译和运行的Android项目（项目A）</li><li>打开你的Flutter项目（项目B）</li><li>Flutter的安装目录</li></ul><h2 id="多处修改"><a href="#多处修改" class="headerlink" title="多处修改"></a>多处修改</h2><p>打开A项目的build.gradle，记住里面的gradle版本号<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124455504.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>继续打开此项目的app/build.gradle，记住如下数据<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124738217.png" alt="在这里插入图片描述"><br>继续打开此项目的gradle/wrapper/gradle-wrapper.properties,记住最下面的url</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124455515.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>打开B项目<br>修改compile sdk与A相同<br>修改build.gradle，包括如下四个地方<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124455513.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731125121188.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/google&#x27;</span> &#125;</span><br><span class="line">maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/jcenter&#x27;</span> &#125;</span><br><span class="line">maven &#123; url <span class="string">&#x27;http://maven.aliyun.com/nexus/content/groups/public&#x27;</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>（第一处地方请根据Android Studio提示来，没提示就不用改）</p><p>继续打开该项目下的gradle/wrapper/gradle-wrapper.properties，修改url与A项目相同</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124455511.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>接下来打开<code>Flutter安装目录</code><br>\flutter\packages\flutter_tools\gradle\resolve_dependencies.gradle<br>修改如下<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731124442683.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">maven &#123;</span><br><span class="line">    url <span class="string">&quot;https://storage.flutter-io.cn/download.flutter.io&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续打开安装目录下\flutter\packages\flutter_tools\gradle\flutter.gradle<br>修改如下地方<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/2020073112572950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>其中第三个地方</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAVEN_REPO      = <span class="string">&quot;https://storage.flutter-io.cn/download.flutter.io&quot;</span>;</span><br></pre></td></tr></table></figure><p>修改完成！</p><h2 id="运行命令"><a href="#运行命令" class="headerlink" title="运行命令"></a>运行命令</h2><p>在AS中打开Flutter项目，首先<strong>Tools-flutter-flutter clean</strong><br>完成后，在终端中<strong>分三次输入</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> android</span><br><span class="line">./gradlew clean</span><br><span class="line">./gradlew build</span><br></pre></td></tr></table></figure><p>（上面的命令如果提示 .不是有效命令 ，去除./即可）</p><p>期间会下载一些东西，等待即可<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731130322788.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20200731130322790.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>完成</p><h2 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h2><p>直接debug项目，几秒钟之内完成运行！！！！！！！！</p><p>完结撒花！<br>若对您有帮助，请在评论区回复！！！！！！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;结合csdn+博客园+github+Stack Overflow+自己尝试，解决该问题！&lt;br&gt;今天突发奇想试一下flutter，按照网上教</summary>
      
    
    
    
    <category term="Bug Fix" scheme="https://blog.funnysaltyfish.fun/categories/Bug-Fix/"/>
    
    
    <category term="Flutter" scheme="https://blog.funnysaltyfish.fun/tags/Flutter/"/>
    
    <category term="bug修复" scheme="https://blog.funnysaltyfish.fun/tags/bug%E4%BF%AE%E5%A4%8D/"/>
    
  </entry>
  
  <entry>
    <title>学了python不知干啥？爬爬虫！（7）代理的使用</title>
    <link href="https://blog.funnysaltyfish.fun/2021/05/26/python-spider-lesson-7/"/>
    <id>https://blog.funnysaltyfish.fun/2021/05/26/python-spider-lesson-7/</id>
    <published>2021-05-26T08:53:57.000Z</published>
    <updated>2021-06-14T03:44:14.333Z</updated>
    
    <content type="html"><![CDATA[<p>多线程批量翻译</p><blockquote><p>合理爬取，不恶意扩大站点压力<br>本文章仅作示例，请勿用作非法用途</p></blockquote><hr><p>在Python爬虫过程中，常常会遇见因为各种原因被服务器拒绝访问的情况。有时候设置User-Agent能够解决问题，但如果遇到服务器校验ip访问次数来判断爬虫的情况，这样简单的做法就无能为力了。往往这种时候，采用代理ip间接访问能取得不错的成效。<br>那么，什么是代理呢？</p><hr><h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>让我们假想这样一个场景，你是一个广告员，负责给一个老奶奶打广告并获拿到她的反馈留言。老奶奶每天见到你很心烦，看见你多次来就不见你了。这时候你想到了另一个办法，你找到老奶奶的儿子孙子外甥侄子……把将自己的广告内容告诉他们，让他们跟老奶奶复述，然后由他们将得到的反馈结果告诉你，从而间接完成自己的目的。当这样的过程中发生在爬虫时，那些爬取过程中的“中间人”，就是代理。</p><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>常见的HTTP代理分为三个类型，即<strong>透明代理IP、匿名代理IP、高匿名代理IP</strong>，它们的具体区别见下：</p><blockquote><p>1)透明代理(Transparent Proxy)：透明代理虽然可以直接“隐藏”客户端的 IP 地址，但是还是可以从来查到客户端的 IP 地址。</p></blockquote><blockquote><p>2)匿名代理(Anonymous Proxy)：匿名代理能提供隐藏客户端 IP 地址的功能。使用匿名代理，服务器能知道客户端使用用了代理，当无法知道客户端真实 IP 地址。</p></blockquote><blockquote><p>3)高匿代理(Elite Proxy 或 High Anonymity Proxy):高匿代理既能让服务器不清楚客户端是否在使用代理，也能保证服务器获取不到客户端的真实 IP 地址。</p></blockquote><h3 id="代理的选择"><a href="#代理的选择" class="headerlink" title="代理的选择"></a>代理的选择</h3><blockquote><p>普通匿名代理能隐藏客户机的真实 IP，但会改变我们的请求信息，服务器端有可能会认为我们使用了代理。不过使用此种代理时，虽然被访问的网站不能知道客户端的 IP 地址，但仍然可以知道你在使用代理，当然某些能够侦测 IP 的网页仍然可以查到客户端的 IP。<br>而高度匿名代理不改变客户机的请求，这样在服务器看来就像有个真正的客户浏览器在访问它，这时客户的真实IP是隐藏的，服务器端不会认为我们使用了代理。<br>因此，爬虫程序需要使用到代理 IP 时，尽量选择普通匿名代理和高匿名代理。另外，如果要保证数据不被代理服务器知道，推荐使用 HTTPS 协议的代理。</p></blockquote><p>上面的描述未免有些理论化，我们实际使用试一下吧~</p><hr><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="获取代理ip"><a href="#获取代理ip" class="headerlink" title="获取代理ip"></a>获取代理ip</h3><p>在互联网搜索，有大量的服务商提供了代理服务。对于专业性较强、访问要求率较高的场景，建议选择收费服务；在这里只做演示，我们随意选择<a href="https://www.89ip.cn/1">一家代理提供商</a>的免费代理<br>打开页面，能看到如下代理ip列表<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210520233829414.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>由于不是本篇重点，爬取此页面的代理列表对应过程省略，如果不太明白如何爬取，可以我参考之前的文章。<br>编写代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span>(<span class="params">url</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.get(url,headers=headers).text</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ip_list</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        url 代理IP页面</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 通用正则匹配的格式是 (IP,端口,地区) 地区有可能包含换行和空格</span></span><br><span class="line">    ip_proxy_re = re.<span class="built_in">compile</span>(</span><br><span class="line">        <span class="string">r&#x27;(\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)\s*&lt;/td&gt;\s*&lt;td&gt;\s*(\d&#123;1,&#125;)\s*&lt;/td&gt;\s*&lt;[^\u4E00-\u9FA5]+&gt;([\u4E00-\u9FA5]*\s*[\u4E00-\u9FA5]*\s*[\u4E00-\u9FA5]*)\s*&lt;&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = get_html(url)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回的IP 就是 正则匹配的结果(IP,端口,地区) 地区有可能包含换行和空格</span></span><br><span class="line">    ip_list = ip_proxy_re.findall(data)</span><br><span class="line">    <span class="keyword">return</span> ip_list</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上述代码运行的结果为：</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210520233919729.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>输出的每一项结果包含 ip地址、端口、地区</p><h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>有了代理ip，接下来就是使用了。requests库提供了很方便的办法：仅需要在对应请求中加入 <strong>proxies</strong> 参数即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_with_ip</span>(<span class="params">url:<span class="built_in">str</span>,ip:<span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;带ip访问，其中ip形如 127.0.0.1:8080</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    proxies = &#123;<span class="string">&quot;http&quot;</span>:ip&#125;</span><br><span class="line">    <span class="keyword">return</span> requests.get(url,headers=headers,proxies=proxies)</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>如何才能知道是不是真的在用代理ip访问而不是自己的ip在访问呢？我们可以采取如下办法：<br>访问一个<strong>查看ip的网址</strong>，然后获取<strong>网址得到的访问ip</strong>，进行验证即可<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210521000541304.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>编写代码如下。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>将上述过程结合起来，我们写出了下面的代码。代码首先获取ip列表，并在之后尝试使用这些ip访问网址。值得注意的是，因为获取到的免费代理<strong>不一定稳定</strong>，代码中添加了<strong>超时和错误处理</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    代理ip使用</span></span><br><span class="line"><span class="string">    文章列表见 https://blog.csdn.net/qq_43596067/article/details/117003258</span></span><br><span class="line"><span class="string">    请注意，由于代理ip质量和时效不稳定，此份代码不一定保证能够运行，请酌情修改</span></span><br><span class="line"><span class="string">    @copyright : FunnySaltyFish</span></span><br><span class="line"><span class="string">    @date : 2021/05/20 23:22:11</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span>(<span class="params">url</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.get(url,headers=headers).text</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ip_list</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        url 代理IP页面</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 通用正则匹配的格式是 (IP,端口,地区) 地区有可能包含换行和空格</span></span><br><span class="line">    ip_proxy_re = re.<span class="built_in">compile</span>(</span><br><span class="line">        <span class="string">r&#x27;(\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)\s*&lt;/td&gt;\s*&lt;td&gt;\s*(\d&#123;1,&#125;)\s*&lt;/td&gt;\s*&lt;[^\u4E00-\u9FA5]+&gt;([\u4E00-\u9FA5]*\s*[\u4E00-\u9FA5]*\s*[\u4E00-\u9FA5]*)\s*&lt;&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = get_html(url)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取ip列表时发生错误，原因是：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回的IP 就是 正则匹配的结果(IP,端口,地区) 地区有可能包含换行和空格</span></span><br><span class="line">    ip_list = ip_proxy_re.findall(data)</span><br><span class="line">    <span class="keyword">return</span> ip_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_with_ip</span>(<span class="params">url:<span class="built_in">str</span>,ip:<span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;带ip访问，其中ip形如 127.0.0.1:8080</span></span><br><span class="line"><span class="string">        访问错误时返回&quot;&quot;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    proxies = &#123;</span><br><span class="line">        <span class="string">&quot;http&quot;</span>:ip,</span><br><span class="line">        <span class="string">&quot;https&quot;</span>:ip,</span><br><span class="line">    &#125;</span><br><span class="line">    html = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        html = requests.get(url,headers=headers,proxies=proxies,timeout=<span class="number">10</span>).text</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;访问错误！原因是：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">ip</span>):</span></span><br><span class="line">    html = get_with_ip(</span><br><span class="line">        <span class="string">&quot;https://ip.tool.chinaz.com/&quot;</span>,</span><br><span class="line">        ip</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> html == <span class="string">&quot;&quot;</span>: <span class="comment">#访问错误</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">&quot;域名(.+)的信息&quot;</span>)</span><br><span class="line">    match = pattern.search(html)</span><br><span class="line">    <span class="keyword">if</span> match <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> match.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ip_list = get_ip_list(<span class="string">&quot;https://www.89ip.cn/1&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;获取到的ip列表为：&quot;</span>)</span><br><span class="line">    pprint.pprint(ip_list)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> ip_list:</span><br><span class="line">        ip = <span class="string">f&quot;<span class="subst">&#123;each[<span class="number">0</span>]&#125;</span>:<span class="subst">&#123;each[<span class="number">1</span>]&#125;</span>&quot;</span> <span class="comment"># 拼接ip和端口</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;尝试使用ip[<span class="subst">&#123;ip&#125;</span>]访问……&quot;</span>)</span><br><span class="line">        shown_ip = validate(ip)</span><br><span class="line">        <span class="keyword">if</span> shown_ip != <span class="string">&quot;&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;采用的ip地址是：<span class="subst">&#123;ip&#125;</span> 爬取后网站显示的ip地址是：<span class="subst">&#123;shown_ip&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>【请注意，由于代理ip质量和时效不稳定，此份代码不一定保证能够运行，请酌情修改】</strong><br>下面是笔者测试时的运行情况：<br>–部分访问错误：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210521171431849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>–部分访问成功<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210521171431820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210521171431779.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li>爬虫所使用的的HTTP代理是什么？<a href="https://blog.csdn.net/yingpu618/article/details/107820814">https://blog.csdn.net/yingpu618/article/details/107820814</a></li></ul><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><ul><li><a href="/2021/05/26/python-spider-lesson-catalog/">系列文章完整目录</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;多线程批量翻译&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;合理爬取，不恶意扩大站点压力&lt;br&gt;本文章仅作示例，请勿用作非法用途&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;p&gt;在Python爬虫过程中，常常会遇见因为各种原因被服务器拒绝访问的情况。有时候设置User-Ag</summary>
      
    
    
    
    <category term="Python爬虫教程" scheme="https://blog.funnysaltyfish.fun/categories/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Python" scheme="https://blog.funnysaltyfish.fun/tags/Python/"/>
    
    <category term="爬虫" scheme="https://blog.funnysaltyfish.fun/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>学了python不知干啥？爬爬虫！（6）爱词霸翻译（内容详尽，从打开网页手把手完成JS逆向并写出代码）</title>
    <link href="https://blog.funnysaltyfish.fun/2021/05/26/python-spider-lesson-6/"/>
    <id>https://blog.funnysaltyfish.fun/2021/05/26/python-spider-lesson-6/</id>
    <published>2021-05-26T08:51:21.000Z</published>
    <updated>2021-06-14T03:43:41.767Z</updated>
    
    <content type="html"><![CDATA[<p>多线程批量翻译</p><blockquote><p>合理爬取，不恶意扩大站点压力<br>本文章仅作示例，请勿用作非法用途</p></blockquote><hr><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;前几篇教程的爬取，我们一直局限于静态网站，且请求仅限于get。但在实际的开发过程中，动态内容才往往是爬取的核心。在本节内容中，我将带你一步步分析<a href="https://www.iciba.com/">爱词霸</a>的翻译结果获取过程，并伪装请求实现单词翻译。<br>&emsp;&emsp;本篇内容为本人原创，转载请注明！<br>&emsp;&emsp;请注意，<strong>本篇内容仅限于学习交流，切勿用于商业用途！</strong><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417210225461.png#pic_center" alt="结果"></p><hr><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="网络加载过程"><a href="#网络加载过程" class="headerlink" title="网络加载过程"></a>网络加载过程</h3><p>&emsp;&emsp;首先打开<a href="https://www.iciba.com/fy">爱词霸</a>，并使用 F12 打开开发者工具 <small><em>【此处使用浏览器为Edge，如使用其他浏览器请参照对应教程打开此界面】</em> </small> 。<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417162427533.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>为了动态分析翻译过程，我们需要切换到 <strong>网络(Network)</strong> 标签页<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/2021041716255944.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>输入任意单词，点击翻译按钮，你将会看到如下请求结果：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417171652787.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>这就是动态翻译的请求。在此条请求上<strong>右键-复制链接地址</strong><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417171850950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>得到如下结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://ifanyi.iciba.com/index.php?c=trans&amp;m=fy&amp;client=6&amp;auth_user=key_ciba&amp;sign=0020c1fc11e96d3a</span><br></pre></td></tr></table></figure><p>目前的链接有许多参数尚未明确，我们先留着，之后再做分析。<br>切换到预览标签页并展开结果，我们惊喜地发现，翻译结果就藏在对应的<strong>json</strong>中。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417172006899.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417172006903.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;目标就是模拟这个请求，那么下一步我们需要弄清楚这里面的参数究竟各代表什么。<br>&emsp;&emsp;切换到标头页，在这里我们可以查看详细的请求头</p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417172236684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;可以看到，除了明显的get请求外，该请求还携带有表单参数。分析字段不难发现，post的表单带有此次翻译的单词信息。其中，<strong>from和to分别是源语言和目标语言，q即为翻译的单词</strong>。<br>&emsp;&emsp;我们需要弄清楚其他参数是什么意思。此处采用对比的方法。<br>&emsp;&emsp;再次翻译另一个单词，得到第二组请求地址和请求头</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://ifanyi.iciba.com/index.php?c=trans&amp;m=fy&amp;client=6&amp;auth_user=key_ciba&amp;sign=09467500f66fb4a7</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417172236750.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;上下对比可知，两次请求的url中，仅有<strong>sign</strong>参数发生改变。可以猜测正是此参数起到加密作用。下一步我们就需要搞清楚，这个参数是怎么来的。<br>&emsp;&emsp;我们进入重头戏：<strong>源码分析！</strong></p><hr><h3 id="JS源码分析"><a href="#JS源码分析" class="headerlink" title="JS源码分析"></a>JS源码分析</h3><p>&emsp;&emsp;现在我们的目标是找sign，那么最直白的思路就很显然了：看看源代码那些地方出现了”sign”，那些就是比较可疑的地方。<br>&emsp;&emsp;切换到<strong>源代码</strong>标签，使用快捷键<strong>Ctrl+Shift+F</strong>或按下图找到<strong>全局搜索</strong>面板<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417173210828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述">先尝试一下直接搜索sign<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417173319380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>得到了9个结果，先进入第一个排查。<br>使用“优质打印”格式化代码以便于后面的分析。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417173436554.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>使用<strong>Ctrl+F</strong>打开页内搜索，尝试查找“sign”<br>但是结果很不理想，有相当大的一部分是关于assign的，不利于结果的分析。<br>我们大概推测，sign在代码执行过程中应该是某个对象的参数。因此改用”\.sign”重新搜索<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417173720868.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>逐个排查，发现这几个<strong>signature</strong>有较大概率是我们的目标。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417173829502.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>是不是呢？验证一下就知道了。<br>在源代码左侧的行号旁单击鼠标打上断点，程序就会在运行到此处时暂停。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417182814797.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>重新点击翻译按钮，得到运行结果<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417182839959.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>观察上图，从变量的值我们可以看到，在这行代码执行前就已经产生了sign<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417182936815.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;不难看出，变量<strong>r</strong>可能就是封装好的请求内容，而<strong>e</strong>则是对应链接。<br>&emsp;&emsp;那么我们的关注点就在<strong>变量e</strong>上，而变量e已经带有了对应的sign。于是我们从旁边的<strong>调用堆栈</strong>标签找到在断点执行位置的上一处，观察此处的代码和变量值<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417183235511.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417183444428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417183444406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br><strong>变量r</strong>的值引起了我们的注意，这一串字符非常符合刚刚看到的<strong>sign</strong>的特征。究竟是不是，我们让代码恢复执行，看看结果。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417183627965.png#pic_center" alt="在这里插入图片描述"><br>最终的请求url中的<strong>sign</strong>参数正是此处的<strong>r</strong>！<br>于是为<strong>r</strong>赋值的这一行代码就非常重要了，摘录如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">takeResult: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> t = p.a.parse(e)</span><br><span class="line">                  , r = c()(<span class="string">&quot;6key_cibaifanyicjbysdlove1&quot;</span>.concat(t.q.replace(<span class="regexp">/(^\s*)|(\s*$)/g</span>, <span class="string">&quot;&quot;</span>))).toString().substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">                <span class="keyword">return</span> g(<span class="string">&quot;/index.php?c=trans&amp;m=fy&amp;client=6&amp;auth_user=key_ciba&amp;sign=&quot;</span>.concat(r), &#123;</span><br><span class="line">                    <span class="attr">baseURL</span>: <span class="string">&quot;//ifanyi.iciba.com&quot;</span>,</span><br><span class="line">                    <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">                    <span class="attr">headers</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">data</span>: e</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;从这里的js代码可得知，<strong>r</strong>是调用<strong>c()函数</strong>得到的结果，传入的参数是一个固定字符串 <code>“6key_cibaifanyicjbysdlove1”</code> 再拼接上翻译的单词，之后调用 <code>replace(/(^\s*)|(\s*$)/g, &quot;&quot;))</code> 的结果。下一步就是看看，这个c()究竟是个什么东西？<br>&emsp;&emsp;切换标签为<strong>控制台</strong>页，输入c()<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417184359353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>发现它返回的是一个函数，点击上面的输出结果，可以跳转到对应的源代码位置<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417184442573.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;这是一个陌生的函数。进行到这一步，让我们回顾一下，我们输入的参数是明文，出来的却是英文字符组成的字符串。我们可以猜测，此处的函数作用就是对参数进行某种加密或哈希算法。<br>&emsp;&emsp;翻阅这个js文件，可以发现大量的<strong>位运算</strong>操作，这正是加密中常用的操作。因此我们可以就此猜测，这个文件就是一个库文件，功能就是实现常见的字符串加密算法。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/2021041718495455.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>到这里思路换了个方向。我们不妨暂时跳出分析代码的过程，看看JS中有没有这样的库存在。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417185037435.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>搜索的结果几乎全部指向了<strong>CryptoJS</strong>这个第三方库，那我们去Github看看它的源代码<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417185137656.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>尝试搜索刚刚代码中出现的 <code>_createHelper</code> 字段。<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/2021041718524599.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>在 <code>core.js</code> 下，我们发现了这一段：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417185313782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>与刚才的<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417185332876.png#pic_center" alt="在这里插入图片描述"><br>一模一样！！！</p><h3 id="寻找具体算法"><a href="#寻找具体算法" class="headerlink" title="寻找具体算法"></a>寻找具体算法</h3><p>简单搜索得知，<strong>CryptoJS</strong>提供了种类丰富的加密算法。要找到此处用的是哪一种就有很多办法。这里我们选择：<strong>黑箱理论</strong>。</p><blockquote><p>黑箱理论，是指对特定的系统开展研究时，人们把系统作为一个看不透的黑色箱子，研究中不涉及系统内部的结构和相互关系，仅从其输入输出的特点了解该系统规律，用黑箱方法得到的对一个系统规律的认识。</p></blockquote><p>寻找一个特定的输入：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417185757621.png#pic_center" alt="在这里插入图片描述"><br>在调试模式下选中生成参数的部分代码，就可以看到此次运行的结果<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417185813154.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>上面这一次的运行结果如下：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417200408602.png#pic_center" alt="在这里插入图片描述"></p><p>随便打开一个用于加密的<a href="http://encode.chahuo.com/">网站</a>，经过不断尝试，在尝试到<strong>MD5</strong>的时候，得到了一模一样的结果：<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210417200430587.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">18dc7242de5f73cae3b299a6c8eba326</span><br></pre></td></tr></table></figure><p>如此就确定了加密方式：<strong>MD5！</strong><br>一切就绪，下一步自然就是编写代码啦！开干！</p><h3 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h3><p>上面分析得很到位了，每一个参数都给了详尽的解释，此处就不再赘述。参见代码和注释即可。</p><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    爱词霸 单词翻译。仅用于学习与交流</span></span><br><span class="line"><span class="string">    @copyright : FunnySaltyFish</span></span><br><span class="line"><span class="string">    @date : 2021/04/17 20:38:45</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_result</span>(<span class="params">word,source=<span class="string">&quot;zh&quot;</span>,to=<span class="string">&quot;en&quot;</span></span>):</span></span><br><span class="line">    <span class="comment"># 伪装请求头</span></span><br><span class="line">    <span class="comment"># 不知道为什么要有这一行的可以看 https://blog.csdn.net/qq_43596067/article/details/105889267</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 计算sign参数</span></span><br><span class="line">    sign = get_signature(word)[<span class="number">0</span>:<span class="number">16</span>]</span><br><span class="line">    <span class="comment"># 组装url</span></span><br><span class="line">    url = <span class="string">f&quot;https://ifanyi.iciba.com/index.php?c=trans&amp;m=fy&amp;client=6&amp;auth_user=key_ciba&amp;sign=<span class="subst">&#123;sign&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># post表单 数据</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;from&quot;</span>:source,</span><br><span class="line">        <span class="string">&quot;to&quot;</span>:to,</span><br><span class="line">        <span class="string">&quot;q&quot;</span>:word</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 获得的json文本</span></span><br><span class="line">    result = requests.post(url=url,headers=headers,data=data)</span><br><span class="line">    <span class="keyword">return</span> result.text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_signature</span>(<span class="params">word:<span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="comment"># 按js代码写出来的拼接字符串</span></span><br><span class="line">    raw = <span class="string">&quot;6key_cibaifanyicjbysdlove1&quot;</span>+word.replace(<span class="string">r&quot;(^\s*)|(\s*$)&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> md5(raw.encode(<span class="string">&quot;utf-8&quot;</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_json</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="comment"># 简单解析获得翻译结果</span></span><br><span class="line">    <span class="comment"># 针对其他一些翻译结果 ， 您可以自行修改</span></span><br><span class="line">    result = json.loads(text)</span><br><span class="line">    <span class="keyword">return</span> result[<span class="string">&quot;content&quot;</span>][<span class="string">&quot;out&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    word = <span class="string">&quot;你好&quot;</span></span><br><span class="line">    raw = get_result(word)</span><br><span class="line">    translation = parse_json(raw)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;【<span class="subst">&#123;word&#125;</span>】的翻译结果是【<span class="subst">&#123;translation&#125;</span>】&quot;</span>)</span><br></pre></td></tr></table></figure><center>✿✿ヽ(°▽°)ノ✿  完结撒花  ✿✿ヽ(°▽°)ノ✿</center><center><a href="/2021/05/26/python-spider-lesson-catalog">回到目录</a></center>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;多线程批量翻译&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;合理爬取，不恶意扩大站点压力&lt;br&gt;本文章仅作示例，请勿用作非法用途&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    <category term="Python爬虫教程" scheme="https://blog.funnysaltyfish.fun/categories/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Python" scheme="https://blog.funnysaltyfish.fun/tags/Python/"/>
    
    <category term="爬虫" scheme="https://blog.funnysaltyfish.fun/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>学了python不知干啥？爬爬虫！（5）requests库的使用+错误处理</title>
    <link href="https://blog.funnysaltyfish.fun/2021/05/26/python-spider-lesson-5/"/>
    <id>https://blog.funnysaltyfish.fun/2021/05/26/python-spider-lesson-5/</id>
    <published>2021-05-26T08:49:12.000Z</published>
    <updated>2021-06-14T03:41:44.833Z</updated>
    
    <content type="html"><![CDATA[<p>多线程批量翻译</p><blockquote><p>合理爬取，不恶意扩大站点压力<br>本文章仅作示例，请勿用作非法用途</p></blockquote><hr><p><strong>本篇并没有完成实际项目，而是讲述更加普遍化的处理方式。如果只是希望复制粘贴的，现在可以选择离开了</strong></p><hr><h2 id="Requests初探"><a href="#Requests初探" class="headerlink" title="Requests初探"></a>Requests初探</h2><p>&emsp;&emsp;在前几次的爬虫中，我们一直使用urllib来完成需求；今天我们尝试一个新的第三方库：<em>requests</em><br>&emsp;&emsp;在它的<a href="https://requests.readthedocs.io/zh_CN/latest/index.html">官网</a>中，对它有如下介绍</p><blockquote><p>Requests 完全满足今日 web 的需求。<br>Keep-Alive &amp; 连接池<br>国际化域名和 URL<br>带持久 Cookie 的会话<br>浏览器式的 SSL 认证<br>自动内容解码<br>基本/摘要式的身份认证<br>优雅的 key/value Cookie<br>自动解压<br>Unicode 响应体<br>HTTP(S) 代理支持<br>文件分块上传<br>流下载<br>连接超时<br>分块请求<br>支持 .netrc</p></blockquote><p>不需要全部看懂，总之只需要知道：很强、很易用就对了！</p><ul><li>要学习requests库的基本用法，您可以点击<a href="https://requests.readthedocs.io/zh_CN/latest/user/quickstart.html#id2">这里</a>来查看官方文档*</li></ul><h3 id="小试身手"><a href="#小试身手" class="headerlink" title="小试身手"></a>小试身手</h3><p>最近2077很火，我们就去贴凑个热闹，看看大家对他的讨论<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107172127408.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p><a href="http://jump2.bdimg.com/f?ie=utf-8&kw=%E8%B5%9B%E5%8D%9A%E6%9C%8B%E5%85%8B2077">这里</a>就是本次我们要爬取的目标啦</p><p>使用之前要用pip安装</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install requests</span><br></pre></td></tr></table></figure><p>先写一个最简单的get请求看一看？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span>(<span class="params">url</span>):</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">basic_html = get_html(<span class="string">&quot;https://tieba.baidu.com/f?kw=%E8%B5%9B%E5%8D%9A%E6%9C%8B%E5%85%8B2077&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(basic_html)</span><br></pre></td></tr></table></figure><p>从上面的代码不难发现，使用requests请求非常简单。事实上，对于常见的请求类型，requests都提供了简单的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.put(<span class="string">&#x27;http://httpbin.org/put&#x27;</span>, data = &#123;<span class="string">&#x27;key&#x27;</span>:<span class="string">&#x27;value&#x27;</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.delete(<span class="string">&#x27;http://httpbin.org/delete&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.head(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.options(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;接下来，通过使用.text方法，我们可以直接获取到对应源代码，requests会自动根据内容推断对应编码并完成转换的过程。<br>&emsp;&emsp;当然，如果你希望手动指定编码，也是可以的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.encoding = <span class="string">&#x27;ISO-8859-1&#x27;</span> <span class="comment">#手动更改编码</span></span><br></pre></td></tr></table></figure><p>那么这样是否就可以获取到我们想要的内容了呢？答案很残酷：NO！<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107154306563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;既然简单的不行，那么加点请求头试试看？<br>&emsp;&emsp;在requests中，加入请求头的方法也十分简洁，只需要设置headers参数即可<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107155537781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>但这个时候报了一个很奇怪的错<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107155554943.png#pic_center" alt="在这里插入图片描述"><br>查了查，发现是Cookie里面有拉丁文字符<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/2021010716081255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>把它删了后，再爬一次<br><del>当当当当！</del><br><del>依然获取不到 ~<br><small><em>（按理说百度贴吧应该是个静态页面，而且比较容易获取到，进行到这一步的时候我也很绝望，看来是升级了……）</em><small/></del> </p><p>&emsp;&emsp;当你print结果的时候，你会发现输出并没有你所需要的；但是，当你将结果写入文本再打开时，你才能看见全貌<br><em>（cao！！！）</em><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107163520737.png#pic_center" alt="在这里插入图片描述"><br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107163601594.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>既然爬取到了，那么就可以进行后续的解析和保存工作了。这一部分前面已经讲过不少，这次就不赘述了。<br>而这次我们要关心的，是爬取的过程，是否已经完美无缺了？答案很显然，不是。</p><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="HTTP状态码"><a href="#HTTP状态码" class="headerlink" title="HTTP状态码"></a>HTTP状态码</h3><p>&emsp;&emsp;让我们回到这个response<br>&emsp;&emsp;Response有一个属性：<code>status_code</code>，用来告诉你这次访问的情况，如果一切顺利，那么它的值会是200，就像下面这样<br><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107164315210.png#pic_center" alt="在这里插入图片描述"></p><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107164322177.png#pic_center" alt="在这里插入图片描述"><br>&emsp;&emsp;在以往的教程中，我们一直假定一切安好，而没有考虑过不安好的情况。这在一个完备的爬虫程序中，很明显是不可取的。那么接下来，我们就要好好考虑一下了。</p><p>什么是HTTP状态码呢？</p><blockquote><p>当浏览者访问一个网页时，浏览者的浏览器会向网页所在服务器发出请求。当浏览器接收并显示网页前，此网页所在的服务器会返回一个包含HTTP状态码的信息头（server header）用以响应浏览器的请求。</p></blockquote><blockquote><p>下面是常见的HTTP状态码：<br>-200 - 请求成功<br>-301 - 资源（网页等）被永久转移到其它URL<br>-404 - 请求的资源（网页等）不存在<br>-500 - 内部服务器错误</p></blockquote><p>如果发送了一个错误请求(一个 4XX 客户端错误，或者 5XX 服务器错误响应)，我们可以通过 Response.raise_for_status() 来抛出异常：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bad_r = requests.get(<span class="string">&#x27;http://httpbin.org/status/404&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bad_r.status_code</span><br><span class="line"><span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bad_r.raise_for_status()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;requests/models.py&quot;</span>, line <span class="number">832</span>, <span class="keyword">in</span> raise_for_status</span><br><span class="line">    <span class="keyword">raise</span> http_error</span><br><span class="line">requests.exceptions.HTTPError: <span class="number">404</span> Client Error</span><br></pre></td></tr></table></figure><p>而当其为200时，调用该方法则什么也不会发生</p><h3 id="请求时间"><a href="#请求时间" class="headerlink" title="请求时间"></a>请求时间</h3><p>&emsp;&emsp;另一个值得注意的点是请求时间，对于大批量爬虫，如果因为服务器问题让部分爬虫长时间未得到响应而使主程序一直僵持，产生的结果是难以预料的。所以，应当有必要设置一个阈值，使得链接在超过这个时间仍然没有响应后自动断开。<br>&emsp;&emsp;对应的方法，是设置timeout</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">&#x27;http://github.com&#x27;</span>, timeout=<span class="number">0.001</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">requests.exceptions.Timeout: HTTPConnectionPool(host=<span class="string">&#x27;github.com&#x27;</span>, port=<span class="number">80</span>): Request timed out. (timeout=<span class="number">0.001</span>)</span><br></pre></td></tr></table></figure><p>此处设置的timeout为0.001秒，以模拟超时连接时发生错误的情况；实际项目中，应该按需要设置</p><blockquote><p>注意<br>timeout 仅对连接过程有效，与响应体的下载无关。 timeout 并不是整个下载响应的时间限制，而是如果服务器在 timeout 秒内没有应答，将会引发一个异常（更精确地说，是在 timeout 秒内没有从基础套接字上接收到任何字节的数据时）</p></blockquote><p>在考虑了上述的因素之后，我们的代码应该写成:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span>(<span class="params">url</span>):</span></span><br><span class="line">    html = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36 Edg/87.0.664.60&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.get(url,headers=headers,timeout=<span class="number">5</span>)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">    <span class="keyword">except</span> exceptions.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;发生HTTP错误，原因是：&quot;</span>,e,sep=<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> exceptions.Timeout <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;访问超时，原因是：&quot;</span>,e,sep=<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;未知错误，原因是：&quot;</span>,e,sep=<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        html = response.text</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line">basic_html = get_html(<span class="string">&quot;https://tieba.baidu.com/f?kw=%E8%B5%9B%E5%8D%9A%E6%9C%8B%E5%85%8B2077&amp;ie=utf-8&amp;pn=50&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> basic_html != <span class="string">&quot;&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;访问成功&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img-blog.csdnimg.cn/20210107171355113.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNTk2MDY3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>这样，程序才会有良好的健壮性。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li>我的水平不高，所讲之处难免有所漏洞，还望指正</li><li><a href="/2021/05/26/python-spider-lesson-catalog/">系列文章完整目录</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;多线程批量翻译&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;合理爬取，不恶意扩大站点压力&lt;br&gt;本文章仅作示例，请勿用作非法用途&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;本篇并没有完成实际项目，而是讲述更加普遍化的处理方式。如果只是希望复制粘贴的，现</summary>
      
    
    
    
    <category term="Python爬虫教程" scheme="https://blog.funnysaltyfish.fun/categories/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Python" scheme="https://blog.funnysaltyfish.fun/tags/Python/"/>
    
    <category term="爬虫" scheme="https://blog.funnysaltyfish.fun/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
</feed>
