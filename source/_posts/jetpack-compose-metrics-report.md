---
title: Jetpack Compose æ€§èƒ½ä¼˜åŒ–å‚è€ƒï¼šç¼–è¯‘æŒ‡æ ‡
tags:
  - Jetpack Compose
cover: /images/bg_jetpack_compose.jpeg
date: 2023-01-08 13:21:12
---

æœ¬æ–‡è¯‘è‡ªï¼š<https://chris.banes.dev/composable-metrics/>  
åŸæ ‡é¢˜ï¼šComposable Metrics  
è¯‘ï¼šFunnySaltyFish

æœ¬æ–‡ä¸ºæ–‡ç« ã€Š[å¦‚ä½•åœ¨ Jetpack Compose ä¸­è°ƒè¯•é‡ç»„](https://juejin.cn/post/7110208846051672095)ã€‹ä¸­é™„å½•çš„æ–‡ç« ï¼Œè¯‘è€…åŒæ ·è¿›è¡Œäº†ç¿»è¯‘ã€‚é™äºè¯‘è€…æ°´å¹³ï¼Œä¸å…æœ‰è°¬è¯¯ä¹‹å¯èƒ½ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚  

***

å½“ä¸€ä¸ªå›¢é˜Ÿå¼€å§‹ä½¿ç”¨ [Jetpack Compose](https://developer.android.com/jetpack/compose) æ—¶ï¼Œä»–ä»¬ä¸­çš„å¤§å¤šæ•°äººæœ€ç»ˆä¼šå‘ç°å°‘äº†ä¸€å—æ‹¼å›¾ï¼šå¦‚ä½•æµ‹é‡å¯ç»„åˆé¡¹ï¼ˆComposableï¼‰çš„æ€§èƒ½ã€‚

åœ¨ Jetpack Compose [1.2.0](https://developer.android.com/jetpack/androidx/releases/compose-compiler#version_12_2)ä¸­ï¼ŒCompose ç¼–è¯‘å™¨æ·»åŠ äº†ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨æ„å»ºæ—¶è¾“å‡ºå„ç§ä¸æ€§èƒ½ç›¸å…³çš„æŒ‡æ ‡ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿçª¥è§†å¹•åï¼Œçœ‹çœ‹æ½œåœ¨çš„æ€§èƒ½é—®é¢˜åœ¨å“ªäº›åœ°æ–¹ã€‚åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢æ–°çš„æŒ‡æ ‡ï¼Œçœ‹çœ‹æˆ‘ä»¬èƒ½æ‰¾åˆ°ä»€ä¹ˆã€‚

åœ¨å¼€å§‹é˜…è¯»ä¹‹å‰éœ€è¦äº†è§£çš„ä¸€äº›äº‹é¡¹ï¼š

-   æœ€ç»ˆå†™å®Œåçš„ç»“æœæ˜¾ç¤ºï¼Œè¿™æ˜¯ä¸€ç¯‡*å¾ˆé•¿* çš„åšæ–‡ï¼Œæ¶µç›–äº† Compose çš„è®¸å¤šå·¥ä½œåŸç†ã€‚æ‰€ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« å¯èƒ½å¾—èŠ±ç‚¹æ—¶é—´ã€‚

<!---->

-   æœ¬æ–‡ä»…ä»…è®¾ç«‹äº†ä¸€äº›é¢„æœŸï¼Œåˆ°ç»“å°¾ä¹Ÿæ²¡æœ‰çœŸæ­£åšæˆä»€ä¹ˆâ€œæ˜æ˜¾çš„æˆæ•ˆâ€ğŸ˜…ã€‚ä½†æ˜¯ï¼Œå¸Œæœ›æ‚¨èƒ½æ›´å¥½åœ°äº†è§£æ‚¨åœ¨è®¾è®¡ä¸Šçš„é€‰æ‹©å°†å¦‚ä½•å½±å“ Compose çš„å·¥ä½œæ–¹å¼ã€‚

<!---->

-   å¦‚æœæ‚¨æ²¡æœ‰ç«‹å³ç†è§£è¿™é‡Œçš„æ‰€æœ‰å†…å®¹ï¼Œè¯·ä¸è¦æ„Ÿåˆ°éš¾è¿‡â€”â€”è¿™æ˜¯ä¸€ä¸ª*é«˜çº§* ä¸»é¢˜ï¼å¦‚æœæ‚¨æœ‰ä»€ä¹ˆç–‘æƒ‘ï¼Œæˆ‘å·²å°è¯•åˆ—å‡ºç›¸å…³èµ„æºä»¥ä¾›è¿›ä¸€æ­¥é˜…è¯»ã€‚

<!---->

-   æˆ‘ä»¬åœ¨è¿™é‡Œæ£é¼“çš„ä¸€äº›äº‹æƒ…å¯ä»¥è¢«è®¤ä¸ºæ˜¯â€œç»†å¾®ä¼˜åŒ–â€ã€‚ä¸ä»»ä½•æ¶‰åŠä¼˜åŒ–çš„ä»»åŠ¡ä¸€æ ·ï¼š**é¦–å…ˆprofileï¼ˆåˆ†æï¼‰å’Œtestï¼ˆæµ‹è¯•ï¼‰ï¼** æ–°çš„[JankStats åº“](https://developer.android.com/studio/profile/jankstats)æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åˆ‡å…¥ç‚¹ã€‚å¦‚æœæ‚¨åœ¨çœŸå®è®¾å¤‡ä¸Šçš„æ€§èƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸Šé¢æ‚¨å¯èƒ½æ— éœ€åšå¤ªå¤šäº‹æƒ…ã€‚

æœ‰äº†è¿™ä¸ªï¼Œè®©æˆ‘ä»¬å¼€å§‹å§......ğŸ

## **å¯ç”¨æŒ‡æ ‡**

æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ˜¯é€šè¿‡ä¸€äº›ç¼–è¯‘å™¨æ ‡å¿—å¯ç”¨æ–°çš„ç¼–è¯‘å™¨æŒ‡æ ‡ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºï¼Œåœ¨æ‰€æœ‰æ¨¡å—ä¸Šå¯ç”¨å®ƒçš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨å…¨å±€ å¼€/å…³ å¼€å…³ã€‚

åœ¨æ‚¨çš„æ ¹ç›®å½•`build.gradle`ä¸­ï¼Œæ‚¨å¯ä»¥ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š

```
Â subprojects {
Â  Â   tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
Â  Â  Â  Â   kotlinOptions {if (project.findProperty("myapp.enableComposeCompilerReports") == "true") {
Â  Â  Â  Â  Â  Â  Â  Â   freeCompilerArgs += ["-P","plugin:androidx.compose.compiler.plugins.kotlin:reportsDestination=" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   project.buildDir.absolutePath + "/compose_metrics"]
Â  Â  Â  Â  Â  Â  Â  Â   freeCompilerArgs += ["-P","plugin:androidx.compose.compiler.plugins.kotlin:metricsDestination=" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   project.buildDir.absolutePath + "/compose_metrics"]}}}
Â }
```

æ¯å½“æ‚¨åœ¨`myapp.enableComposeCompilerReports`å±æ€§è¢«å¯ç”¨çš„æƒ…å†µä¸‹è¿è¡Œ Gradle æ„å»ºæ—¶ï¼Œè¿™éƒ½ä¼šå¯ç”¨å¿…è¦çš„ Kotlin ç¼–è¯‘å™¨æ ‡å¿—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
Â ./gradlew assembleRelease -Pmyapp.enableComposeCompilerReports=true
```

ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š

-   **è¯·åœ¨releaseç‰ˆæœ¬ä¸Šè¿è¡Œå®ƒï¼Œè¿™å¾ˆé‡è¦ã€‚** æˆ‘ä»¬ç¨åä¼šçœ‹åˆ°ä¸ºä»€ä¹ˆã€‚

<!---->

-   æ‚¨å¯ä»¥æ ¹æ®éœ€è¦é‡å‘½åè¯¥`myapp.enableComposeCompilerReports`å±æ€§ã€‚

<!---->

-   æ‚¨å¯èƒ½ä¼šå‘ç°æ‚¨éœ€è¦åŒæ—¶ä½¿ç”¨ `--rerun-tasks` é€‰é¡¹è¿è¡Œä¸Šè¿°å‘½ä»¤ï¼Œä»¥ç¡®ä¿ Compose ç¼–è¯‘å™¨å³ä½¿åœ¨æœ‰ç¼“å­˜çš„æƒ…å†µä¸‹ä¹Ÿæ­£å¸¸è¿è¡Œã€‚

ç›¸åº”æŒ‡æ ‡å’Œç»“æœæŠ¥å‘Šå°†è¢«å†™å…¥æ¯ä¸ªæ¨¡å—çš„æ„å»ºç›®å½•ä¸­çš„`compose_metrics`æ–‡ä»¶å¤¹ã€‚ä¸€èˆ¬æƒ…å†µæ¥è¯´ï¼Œå®ƒå°†ä½äº`<module_dir>/build/compose_metrics`. å¦‚æœæ‚¨æ‰“å¼€å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ‚¨ä¼šçœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/786759026ff14b3ba046091c5e93d16e~tplv-k3u1fbpfcp-zoom-1.image)

Compose ç¼–è¯‘å™¨æŒ‡æ ‡çš„è¾“å‡º

*æ³¨æ„ï¼šä»æŠ€æœ¯ä¸Šè®²ï¼ŒæŠ¥å‘Š (* *`module.json`* *) å’ŒæŒ‡æ ‡ï¼ˆå…¶ä»– 3 ä¸ªæ–‡ä»¶ï¼‰æ˜¯å•ç‹¬å¯ç”¨çš„ã€‚æˆ‘å·²å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªæ ‡å¿—å¹¶å°†å®ƒä»¬è®¾ç½®ä¸ºè¾“å‡ºåˆ°åŒä¸€ç›®å½•ä»¥æ–¹ä¾¿ä½¿ç”¨ã€‚å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ‹†åˆ†å®ƒä»¬ã€‚*


## **è§£é‡ŠæŠ¥å‘Š**

å¦‚ä¸Šæ‰€ç¤ºï¼Œæ¯ä¸ªæ¨¡å—æœ‰ 4 ä¸ªæ–‡ä»¶è¾“å‡ºï¼š

-   `module-module.json`ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›æ•´ä½“ç»Ÿè®¡æ•°æ®ã€‚

<!---->

-   `module-composables.txt`ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‡½æ•°å£°æ˜çš„è¯¦ç»†è¾“å‡ºã€‚

<!---->

-   `module-composables.csv`ï¼Œè¿™æ˜¯æ–‡æœ¬æ–‡ä»¶çš„è¡¨æ ¼ç‰ˆæœ¬

<!---->

-   `module-classes.txt`ï¼Œå…¶ä¸­åŒ…å«ä»å¯ç»„åˆé¡¹å¼•ç”¨çš„ç±»çš„ç¨³å®šæ€§ä¿¡æ¯ã€‚

è¿™ç¯‡åšæ–‡ä¸ä¼šæ·±å…¥æ¢è®¨æ‰€æœ‰æ–‡ä»¶çš„å†…å®¹ã€‚ä¸ºæ­¤ï¼Œæˆ‘å»ºè®®é€šè¯»â€œè§£é‡Š Compose ç¼–è¯‘å™¨æŒ‡æ ‡â€æ–‡æ¡£ï¼Œä¹Ÿæ˜¯æœ¬ç¯‡çš„å‚è€ƒæ–‡æ¡£ï¼š

> [androidx/compiler-metrics.md at androidx-main Â· androidx/androidx](https://github.com/androidx/androidx/blob/androidx-main/compose/compiler/design/compiler-metrics.md)

ç›¸åï¼Œæˆ‘å°†ä¾æ¬¡è¿‡ä¸€ä¸‹ä¸Šé¢æ–‡æ¡£ä¸­â€œæ³¨æ„äº‹é¡¹â€éƒ¨åˆ†ä¸­åˆ—å‡ºçš„ä¿¡æ¯çš„è¦ç‚¹ğŸ‘‘ [ï¼Œ](https://chris.banes.dev/composable-metrics/Things%20To%20Look%20Out%20For)å¹¶çœ‹çœ‹æˆ‘çš„[Tivi åº”ç”¨ç¨‹åº](https://github.com/chrisbanes/tivi)çš„æŸä¸ªæ¨¡å—æ˜¯ä¸ªä»€ä¹ˆæƒ…å†µã€‚

æˆ‘è¦ç ”ç©¶çš„`ui-showdetails`æ¨¡å—æ˜¯åŒ…å«â€œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯â€é¡µé¢çš„æ‰€æœ‰ UI çš„æ¨¡å—ã€‚å®ƒæ˜¯æˆ‘åœ¨ [2020 å¹´ 4 æœˆ](https://github.com/chrisbanes/tivi/commit/28629cf397f2c62b80a0eb74954439066ee4356e) è½¬æˆ Jetpack Compose çš„é¦–æ‰¹æ¨¡å—ä¹‹ä¸€ï¼Œæ‰€ä»¥æˆ‘ç¡®ä¿¡è¿˜æœ‰ä¸€äº›éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼

å¥½çš„ï¼Œæ‰€ä»¥é¦–å…ˆè¦æ³¨æ„çš„æ˜¯...

## æ˜¯`restartable`**ä½†ä¸æ˜¯**`skippable` çš„å‡½æ•°

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰æœ¯è¯­ â€œ*å¯é‡å¯ï¼ˆrestartableï¼‰* â€ å’Œ â€œ*å¯è·³è¿‡ï¼ˆskippableï¼‰* â€ã€‚

åœ¨å­¦ä¹  Compose æ—¶ï¼Œæ‚¨ä¼šå­¦ä¹ åˆ°[é‡ç»„](https://developer.android.com/jetpack/compose/mental-model#recomposition)â€”â€”å®ƒæ˜¯ Compose å·¥ä½œæ–¹å¼çš„åŸºç¡€ï¼š

> *é‡ç»„æ˜¯å½“è¾“å…¥æ”¹å˜æ—¶å†æ¬¡è°ƒç”¨ä½ çš„å¯ç»„åˆå‡½æ•°çš„è¿‡ç¨‹ã€‚å½“å‡½æ•°çš„è¾“å…¥å‘ç”Ÿå˜åŒ–æ—¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚å½“ Compose åŸºäºæ–°è¾“å…¥è¿›è¡Œé‡æ„æ—¶ï¼Œå®ƒåªè°ƒç”¨å¯èƒ½å·²æ›´æ”¹çš„å‡½æ•°æˆ– lambdaï¼Œå¹¶è·³è¿‡å…¶ä½™éƒ¨åˆ†ã€‚*

### **å¯é‡å¯**

â€œ*å¯é‡å¯*â€çš„å‡½æ•°æ˜¯é‡ç»„çš„åŸºç¡€ã€‚å½“ Compose æ£€æµ‹åˆ°å‡½æ•°è¾“å…¥å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ å®ƒä¾¿ä½¿ç”¨æ–°è¾“å…¥*é‡æ–°å¯åŠ¨*ï¼ˆé‡æ–°invokeï¼‰æ­¤å‡½æ•°ã€‚

æ›´è¿›ä¸€æ­¥åœ°çœ‹çœ‹ Compose çš„å·¥ä½œåŸç†ï¼Œå¯é‡å¯çš„å‡½æ•°æ ‡å¿—ç€compositionâ€œèŒƒå›´â€çš„è¾¹ç•Œã€‚[Snapshot](https://dev.to/zachklipp/introduction-to-the-compose-snapshot-system-19cn) (æ¯”å¦‚ `MutableState`)è¢«è¯»å–åˆ°çš„â€œèŒƒå›´â€å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå®šä¹‰äº†åœ¨ å¿«ç…§ï¼ˆsnapshotï¼‰æ›´æ”¹æ—¶è¢«é‡æ–°è¿è¡Œçš„ä»£ç å—ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œå¿«ç…§æ›´æ”¹å°†å°½å¯èƒ½ä»…è§¦å‘æœ€è¿‘çš„ å‡½æ•°/lambda é‡å¯ï¼Œä½¿å¾—è¢«é‡æ–°è¿è¡Œçš„ä»£ç æœ€å°‘åŒ–ã€‚å¦‚æœå®¿ä¸»ä»£ç å—æ— æ³•é‡å¯ï¼Œåˆ™ Compose éœ€è¦éå†æ ‘ä»¥æ‰¾åˆ°æœ€è¿‘çš„ç¥–å…ˆå¯é‡å¯çš„â€œèŒƒå›´â€ã€‚è¿™å¯èƒ½æ„å‘³ç€å¾ˆå¤šå‡½æ•°éœ€è¦é‡æ–°è¿è¡Œã€‚å®é™…ä¸Šï¼Œå‡ ä¹æ‰€æœ‰`@Composable`å‡½æ•°éƒ½å¯ä»¥é‡å¯ã€‚

### **å¯è·³è¿‡**

å¦‚æœ Compose å‘ç°è‡ªä¸Šæ¬¡è°ƒç”¨ä»¥æ¥å‚æ•°æœªæ›´æ”¹ï¼Œåˆ™å®ƒå¯ä»¥å®Œå…¨è·³è¿‡è°ƒç”¨æ­¤å‡½æ•°ï¼Œåˆ™å¯ç»„åˆå‡½æ•°æ˜¯â€œ*å¯è·³è¿‡çš„â€ã€‚* è¿™å¯¹äºâ€œé¡¶çº§â€å¯ç»„åˆé¡¹çš„æ€§èƒ½å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒä»¬å¾€å¾€ä½äº `Composableæ ‘`çš„æœ€ä¸Šé¢ä¸€éƒ¨åˆ†ã€‚å¦‚æœ Compose å¯ä»¥è·³è¿‡â€œé¡¶çº§â€è°ƒç”¨ï¼Œåˆ™ä¹Ÿä¸éœ€è¦è°ƒç”¨å…¶ä¹‹ä¸‹ä»»ä½•å‡½æ•°ã€‚

åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©å°½å¯èƒ½å¤šçš„å¯ç»„åˆé¡¹å¯è·³è¿‡ï¼Œä»¥å…è®¸ Compose '*æ™ºèƒ½é‡ç»„'ã€‚*

è›‹ç–¼çš„äº‹æƒ…æ˜¯ï¼Œå‚æ•°å€¼æ˜¯å¦*å‘ç”Ÿå˜åŒ–* æ˜¯æ€ä¹ˆå®šä¹‰çš„â€”â€”æˆ‘ä»¬éœ€è¦å¼•å…¥å¦å¤–ä¸¤ä¸ªæœ¯è¯­ï¼šç¨³å®šæ€§ï¼ˆStablilityï¼‰å’Œä¸å˜æ€§ï¼ˆImmutabilityï¼‰ã€‚

### **ç¨³å®šæ€§ï¼ˆStablilityï¼‰å’Œä¸å˜æ€§ï¼ˆImmutabilityï¼‰**

å¯é‡å¯å’Œå¯è·³è¿‡æ˜¯ **Compose å‡½æ•°** çš„å±æ€§ï¼Œè€Œä¸å˜æ€§å’Œç¨³å®šæ€§æ˜¯**å¯¹è±¡å®ä¾‹**çš„å±æ€§ï¼Œå°¤æŒ‡ä¼ é€’ç»™å¯ç»„åˆå‡½æ•°çš„å¯¹è±¡ã€‚

**ä¸å¯å˜**çš„å¯¹è±¡æ„å‘³ç€â€œæ‰€æœ‰publicå±æ€§å’Œå­—æ®µåœ¨æ„é€ å®ä¾‹åéƒ½ä¸ä¼šæ›´æ”¹â€ã€‚è¿™ä¸ªç‰¹å¾æ„å‘³ç€ Compose å¯ä»¥å¾ˆå®¹æ˜“åœ°æ£€æµ‹åˆ°ä¸¤ä¸ªå®ä¾‹ä¹‹é—´çš„â€œå˜åŒ–â€ã€‚

å¦ä¸€æ–¹é¢ï¼Œ**ç¨³å®š**çš„å¯¹è±¡ä¸ä¸€å®šæ˜¯ä¸å¯å˜çš„ã€‚ä¸€ä¸ªç¨³å®šçš„ç±»å¯ä»¥ä¿å­˜å¯å˜æ•°æ®ï¼Œä½†æ‰€æœ‰å¯å˜æ•°æ®éƒ½éœ€è¦åœ¨å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥ Composeï¼Œä»¥ä¾¿åœ¨å¿…è¦æ—¶è¿›è¡Œé‡ç»„ã€‚

å½“ Compose æ£€æµ‹åˆ°æ‰€æœ‰å‡½æ•°å‚æ•°éƒ½æ˜¯ç¨³å®šæˆ–ä¸å¯å˜æ—¶ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶å¯ç”¨è®¸å¤šä¼˜åŒ–ï¼Œè¿™ä¹Ÿæ­£æ˜¯å‡½æ•°èƒ½å¤Ÿè¢«è·³è¿‡çš„å…³é”®ã€‚Compose ä¼šå°è¯•è‡ªåŠ¨æ¨æ–­ä¸€ä¸ªç±»æ˜¯ä¸å¯å˜çš„è¿˜æ˜¯ç¨³å®šçš„ï¼Œä½†æœ‰æ—¶å®ƒæ— æ³•æ­£ç¡®æ¨æ–­ã€‚å½“å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç±»ä¸Šä½¿ç”¨`@Immutable`å’Œ`@Stable`æ³¨è§£

ç®€è¦è§£é‡Šäº†è¿™äº›æœ¯è¯­åï¼Œè®©æˆ‘ä»¬å¼€å§‹æ¢ç´¢æŒ‡æ ‡æ•°æ®ã€‚

### **æ¢ç´¢æŒ‡æ ‡æ•°æ®**

æˆ‘ä»¬å°†ä»`module.json`æ–‡ä»¶å¼€å§‹ä»¥äº†è§£æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ï¼š

```
Â {
Â  Â   "skippableComposables": 64,
Â  Â   "restartableComposables": 76,
Â  Â   "readonlyComposables": 0,
Â  Â   "totalComposables": 76
Â }
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ¨¡å—åŒ…å« 76 ä¸ªå¯ç»„åˆé¡¹ï¼šå®ƒä»¬éƒ½æ˜¯*å¯é‡å¯* çš„ï¼Œå…¶ä¸­ 64 ä¸ªæ˜¯*å¯è·³è¿‡* çš„ï¼Œå‰©ä¸‹ 12 ä¸ªåˆ™æ˜¯*å¯é‡å¯* ä½†ä¸å¯ *è·³è¿‡* çš„å‡½æ•°ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦æ‰¾å‡ºå…·ä½“çš„å¯¹åº”å…³ç³»ã€‚æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼šæŸ¥çœ‹`composables.txt`æ–‡ä»¶ï¼Œæˆ–è€…å¯¼å…¥`composables.csv`æ–‡ä»¶å¹¶å°†å…¶å½“åšç”µå­è¡¨æ ¼æŸ¥çœ‹ã€‚æˆ‘ä»¬ç¨åä¼šæŸ¥çœ‹æ–‡æœ¬æ–‡ä»¶ï¼Œæ‰€ä»¥ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç”µå­è¡¨æ ¼ã€‚

å°† CSV å¯¼å…¥æ‚¨é€‰æ‹©çš„ç”µå­è¡¨æ ¼å·¥å…·åï¼Œæ‚¨å°†å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

ï¼ˆåŸä½œè€…é™„çš„é“¾æ¥å¤±æ•ˆäº†â€¦â€¦ï¼‰

åœ¨è¿‡æ»¤Composableåˆ—è¡¨åï¼ˆå·¥ä½œè¡¨ä¸Šæœ‰ä¸€ä¸ªâ€œä¸å¯è·³è¿‡â€çš„è¿‡æ»¤è§†å›¾ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾æ‰¾åˆ°ä¸å¯è·³è¿‡çš„å‡½æ•°ï¼š

```
Â ShowDetails()
Â ShowDetailsScrollingContent()
Â PosterInfoRow()
Â BackdropImage()
Â AirsInfoPanel()
Â Genres()
Â RelatedShows()
Â NextEpisodeToWatch()
Â InfoPanels()
Â SeasonRow()
```

### **ä½¿å‡½æ•°å¯è·³è¿‡**

ç°åœ¨æˆ‘ä»¬çš„å·¥ä½œæ˜¯ä¾æ¬¡æŸ¥çœ‹ä¸Šè¿°çš„æ¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ç¡®å®šå®ƒä»¬ä¸å¯è·³è¿‡çš„åŸå› ã€‚å¦‚æœæˆ‘ä»¬å›åˆ°æ–‡æ¡£ï¼Œå®ƒä¸Šé¢è¿™æ ·å†™åˆ°ï¼š

> *å¦‚æœæ‚¨çœ‹åˆ°ä¸€ä¸ªå¯é‡å¯ä½†ä¸å¯è·³è¿‡çš„å‡½æ•°ï¼Œè¿™å¹¶ä¸æ€»æ˜¯ä¸€ä»¶åäº‹ï¼›åä¹‹ï¼Œæœ‰æ—¶ï¼Œè¿™å‘Šè¯‰æˆ‘ä»¬è¯¥åšåšä¸‹é¢è¿™ä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š* *1ã€‚é€šè¿‡ç¡®ä¿å‡½æ•°çš„æ‰€æœ‰å‚æ•°ç¨³å®šæ¥ä½¿å‡½æ•°å¯è·³è¿‡* *2. é€šè¿‡* *`@NonRestartableComposable`* *å°†å‡½æ•°æ ‡è®°ä¸ºä¸å¯é‡å¯å‡½æ•°*

ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºç¬¬ä¸€ä»¶äº‹ã€‚æ‰€ä»¥è®©æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹`composables.txt`æ–‡ä»¶ï¼Œå¹¶æ‰¾åˆ°ä¸å¯è·³è¿‡çš„Composableä¹‹ä¸€ï¼š`AirsInfoPanel()`ï¼š

```
Â restartable scheme("[androidx.compose.ui.UiComposable]") fun AirsInfoPanel(
Â   unstable show: TiviShow
Â   stable modifier: Modifier? = @static Companion
Â )
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°æœ‰ 2 ä¸ªå‚æ•°ï¼š`modifier`å‚æ•°æ˜¯ 'stable' (ğŸ‘)ï¼Œä½†`show`å‚æ•°æ˜¯ 'unstable' (ğŸ‘)ï¼Œè¿™å¾ˆå¯èƒ½å°±æ˜¯å¯¼è‡´ Compose ç¡®å®šè¯¥å‡½æ•°ä¸å¯è·³è¿‡çš„åŸå› ã€‚ä½†æ˜¯ç°åœ¨é—®é¢˜å˜æˆäº†ï¼šä¸ºä»€ä¹ˆ Compose ç¼–è¯‘å™¨ä¼šè®¤ä¸º`TiviShow`æ˜¯ä¸ç¨³å®šçš„ï¼Ÿå®ƒåªæ˜¯ä¸€ä¸ªåªåŒ…å«ä¸å¯å˜æ•°æ®çš„æ•°æ®ç±»è€Œå·²å•Šã€‚ğŸ¤”

### **classes.txt**

ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å‚è€ƒæ­¤å¤„å¼•ç”¨çš„`module-classes.txt`æ–‡ä»¶ä»¥æ·±å…¥äº†è§£è¯¥ç±»è¢«æ¨æ–­ä¸ºä¸ç¨³å®šçš„åŸå› ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¯¥æ–‡ä»¶çš„è¾“å‡ºä¼¼ä¹é›¶é›¶æ•£æ•£çš„ã€‚åœ¨æŸäº›æ¨¡å—ä¸­ï¼Œæˆ‘å¯ä»¥çœ‹åˆ°å¿…è¦çš„è¾“å‡ºï¼›ä½†å¯¹äºæœ‰äº›æ¨¡å—ï¼Œå®ƒç”šè‡³å¯èƒ½æ˜¯ä¸ªç©ºæ–‡ä»¶ï¼ˆè¿™ä¸ªæ¨¡å—å°±æ˜¯ï¼‰ã€‚

ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥æ¢ä¸ªä¸åŒæ¨¡å—çš„ç¤ºä¾‹çœ‹çœ‹ã€‚å®ƒçœ‹èµ·æ¥å°±è›®æœ‰ç”¨çš„ï¼š

```
Â unstable class WatchedViewState {
Â   unstable val user: TraktUser?
Â   stable val authState: TraktAuthState
Â   stable val isLoading: Boolean
Â   stable val isEmpty: Boolean
Â   stable val selectionOpen: Boolean
Â   unstable val selectedShowIds: Set<Long>
Â   stable val filterActive: Boolean
Â   stable val filter: String?
Â   unstable val availableSorts: List<SortOption>
Â   stable val sort: SortOption
Â   unstable val message: UiMessage?
Â   <runtime stability> = Unstable
Â }
```

ä»`classes.txt`è¾“å‡ºçš„åˆ¤æ–­æ¥çœ‹ï¼ŒCompose ç¼–è¯‘å™¨ä¼¼ä¹åªèƒ½æ¨æ–­ å¯ç”¨äº† composeçš„æ¨¡å—ä¸‹çš„ç±» çš„ä¸å˜æ€§å’Œç¨³å®šæ€§ã€‚Tivi ä¸­çš„å¤§å¤šæ•°Modelç±»éƒ½æ„å»ºåœ¨æ ‡å‡†çš„ Kotlin æ¨¡å—ä¸­ï¼ˆå³æ²¡æœ‰åŒ…å« Android æˆ– Composeï¼‰ï¼Œç„¶ååœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚å¯¹äºä»å¤–éƒ¨åº“ï¼ˆæ¯”å¦‚`ViewModel`ï¼‰ä½¿ç”¨çš„ç±»ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ç±»ä¼¼çš„æƒ…å†µã€‚

ä¸å¹¸çš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„å·¥ä½œï¼Œæˆ‘ä»¬ç°åœ¨ä¼¼ä¹æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒCompose ä½¿ç”¨çš„æ³¨é‡Šï¼ˆæ¯”å¦‚`@Stable`ï¼‰å°†èƒ½è¢«åˆ†ç¦»åˆ°ä¸€ä¸ªçº¯ Kotlin åº“ä¸­ï¼Œå…è®¸æˆ‘ä»¬åœ¨æ›´å¤šåœ°æ–¹ä½¿ç”¨å®ƒä»¬ï¼ˆå¦‚æœ‰å¿…è¦ï¼Œç”šè‡³å¯ä»¥æ˜¯ Java åº“ï¼‰ã€‚

### **æŠŠç±»åŒ…è£…ä¸€ä¸‹**

å¦‚æœæ‚¨å‘ç°æ‚¨çš„å¯ç»„åˆé¡¹æˆäº†æ€§èƒ½ä¸Šçš„ç»Šè„šçŸ³ï¼Œä¸”å¯ç”¨å¯è·³è¿‡æ€§æ˜¯å®ç°æ— å¡é¡¿çš„å…³é”®æ—¶ï¼Œæ‚¨å¯ä»¥å°†è¢«é”™è¯¯æ¨æ–­çš„ã€å®é™…ç¨³å®šçš„å¯¹è±¡åŒ…è£…èµ·æ¥ï¼Œä¾‹å¦‚ï¼š

```
Â @Stable
Â class StableHolder<T>(val item: T) {operator fun component1(): T = item
Â }
Â â€‹
Â @Immutable
Â class ImmutableHolder<T>(val item: T) {operator fun component1(): T = item
Â }
```

ç¼ºç‚¹æ˜¯æ‚¨éœ€è¦åœ¨å¯ç»„åˆå£°æ˜ä¸­è¿™æ ·ä½¿ç”¨å®ƒä»¬ï¼š

```
Â @Composable
Â private fun AirsInfoPanel(
Â  Â   show: StableHolder<ShowUiModel>,
Â  Â   modifier: Modifier = Modifier,
Â )
```

ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œæ¢ç´¢è®¸å¤šå›¢é˜Ÿæ¨èçš„æ¨¡å¼ï¼šUI ç›¸å…³çš„ Model ç±»ã€‚

### **UI** **Model ç±»**

è¿™äº› Model ç±»æ˜¯é’ˆå¯¹æ¯ä¸ªâ€œå±å¹•â€æ„å»ºçš„ï¼ŒåŒ…å«æ˜¾ç¤º UI æ‰€éœ€çš„æœ€å°‘ä¿¡æ¯ã€‚é€šå¸¸ï¼Œæ‚¨`ViewModel`ä¼šå°†æ•°æ®å±‚æ¨¡å‹æ˜ å°„åˆ°è¿™äº› UI æ¨¡å‹ä¸­ï¼Œä»¥ä¾¿æ‚¨çš„ UI æ˜“äºä½¿ç”¨ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥å†™åœ¨æ‚¨çš„å¯ç»„åˆé¡¹æ—è¾¹ï¼Œè¿™æ„å‘³ç€ Compose ç¼–è¯‘å™¨å¯ä»¥æ¨æ–­å‡ºå®ƒéœ€è¦çš„æ‰€æœ‰å†…å®¹ï¼›æˆ–è€…å³ä½¿å…¶ä»–æ‰€æœ‰æ–¹æ³•éƒ½æ²¡ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ `@Immutable`or `@Stable`ã€‚

è¿™æ­£æ˜¯æˆ‘åœ¨ä»¥ä¸‹PRä¸­å®ç°çš„ï¼š

> <https://github.com/chrisbanes/tivi/pull/910>

åœ¨æˆ‘çš„æ•°æ®å±‚ï¼ˆæ¯”å¦‚æ•°æ®åº“å•¥çš„ï¼‰ä¸­ï¼Œæˆ‘ä»¬ä¸å†ç›´æ¥ä½¿ç”¨`TiviShow`ä½œä¸ºæ¨¡å‹ï¼Œè€Œæ˜¯å°†æ˜¾ç¤ºæ•°æ®æ˜ å°„åˆ°ä»…åŒ…å« UI æ‰€éœ€çš„å¿…è¦ä¿¡æ¯çš„`ShowUiModel` ä¸­ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œè¿™è¿˜ä¸è¶³ä»¥è®© Compose ç¼–è¯‘å™¨æ¨æ–­`ShowUiModel`ä¸ºå¯è·³è¿‡ ğŸ˜”ï¼š

```
Â restartable scheme("[androidx.compose.ui.UiComposable]") fun AirsInfoPanel(
Â   unstable show: ShowUiModel
Â   stable modifier: Modifier? = @static Companion
Â )
```

åŒæ ·ä¸å¹¸çš„æ˜¯ï¼ŒæŒ‡æ ‡ä¸­æ²¡æœ‰ä»»ä½•æ˜æ˜¾çš„ä¸œè¥¿å¯ä»¥è¯´æ˜ä¸ºä»€ä¹ˆè¯¥ç±»ä¼šè¢«æ¨æ–­ä¸ºä¸ç¨³å®šã€‚åœ¨æŸ¥çœ‹äº†`composables.txt`æ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†åï¼Œæˆ‘æ³¨æ„åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¹Ÿè¢«è®¤ä¸ºæ˜¯ä¸ç¨³å®šçš„ï¼š

```
Â restartable scheme("[androidx.compose.ui.UiComposable]") fun Genres( Â  
Â   unstable genres: List<Genre>
Â )
```

æˆ‘çš„æ–°`ShowUiModel`ç±»æ˜¯ä¸€ä¸ªæ•°æ®ç±»ï¼Œå®ƒåŒ…å«è®¸åŸå§‹ç±»å‹å’Œæšä¸¾ç±»ï¼Œä½†ä¸€ä¸ªå±æ€§ç•¥æœ‰ä¸åŒï¼Œå› ä¸ºå®ƒåŒ…å«æšä¸¾åˆ—è¡¨ï¼š`genre: List<Genre>`. ä¼¼ä¹ Compose ç¼–è¯‘å™¨ä¸æŠŠListå½“åšç¨³å®šçš„ï¼ˆ[public issue](https://issuetracker.google.com/issues/199496149)ï¼‰ã€‚

æˆ‘å‘ç°å¼ºåˆ¶è®© Compose è®¤ä¸º`ShowUiModel`æ˜¯ç¨³å®šçš„å”¯ä¸€æ–¹æ³•æ˜¯ï¼šä½¿ç”¨`@Immutable`æˆ–`@Stable`æ³¨è§£ã€‚å› ä¸ºå…¶æ‰€æœ‰å±æ€§å‡ä¸å¯å˜ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨`@Immutable`ï¼Œ

```
Â @Immutable
Â internal data class ShowUiModel(// ...
Â )
```

ä¹‹åï¼Œ`AirsInfoPanel()`ç»ˆäºè¢«è®¤ä¸ºæ˜¯å¯ä»¥è·³è¿‡çš„äº†ğŸ˜…ï¼š

```
Â restartable skippable scheme("[androidx.compose.ui.UiComposable]") fun AirsInfoPanel(
Â   stable show: ShowUiModel
Â   stable modifier: Modifier? = @static Companion
Â )
```

### å†çœ‹çœ‹

åœ¨å¹²å®Œè¿™äº›ä¹‹åï¼Œæ‚¨å¯èƒ½ä¼šè®¤ä¸ºæˆ‘ä»¬åœ¨æ¨¡å—çš„æ•´ä½“ç»Ÿè®¡æ•°æ®æ–¹é¢åšå‡ºäº†å¾ˆå¤§çš„æ”¹å˜ã€‚ä¸å¹¸çš„æ˜¯ï¼Œäº‹å®å¹¶éå¦‚æ­¤ï¼š

```
Â {
Â  Â   "skippableComposables": 66,
Â  Â   "restartableComposables": 76,
Â  Â   "readonlyComposables": 0,
Â  Â   "totalComposables": 76,
Â  Â   "knownStableArguments": 890,
Â  Â   "knownUnstableArguments": 30,"unknownStableArguments": 1
Â }
```

ä½œä¸ºæé†’ï¼Œæˆ‘ä»¬æ˜¯ ä»*64 ä¸ª*å¯è·³è¿‡çš„ç»„åˆå¼€å§‹çš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†è¿™ä¸ªæ•°å­—å¢åŠ äº†...... **2**â€”â€”åˆ°*66* ğŸ™ƒã€‚

> *å¤§å‹åº”ç”¨ç¨‹åºè¶³ä»¥åŒ…å«æ•°ç™¾ä¸ª* *UI* *æ¨¡å—ï¼Œè¿™ä½¿å¾—åœ¨æ¯ä¸ªæ¨¡å—ä¸­åˆ›å»º UI æ¨¡å‹æ˜¯ä¸ç°å®çš„ã€‚*

è¿˜æœ‰ä¸€äº›å…¶ä»–æœ‰è¶£çš„ç»Ÿè®¡æ•°æ®ã€‚Compose å·²è®¤ä¸ºæœ‰ 890 ä¸ªç¨³å®šçš„å¯ç»„åˆå‡½æ•°å‚æ•°ï¼ˆè¿™å¾ˆå¥½ï¼‰ï¼Œä½†ä»æœ‰**30**ä¸ªè¢« Compose è§†ä¸ºä¸ç¨³å®šã€‚

åœ¨æ£€æŸ¥äº†é‚£äº›â€œä¸ç¨³å®šâ€çš„å‚æ•°åï¼Œæˆ‘å‘ç°å‡ ä¹æ‰€æœ‰çš„å‚æ•°éƒ½å¯ä»¥å®‰å…¨åœ°ç”¨ä½œä¸å¯å˜çš„Stateã€‚è¿™ä¸ªé—®é¢˜ä¼¼ä¹å’Œä¹‹å‰ä¸€æ ·ï¼Œä½†æœ‰å…¶ä»–é—®é¢˜ï¼šå¤§å¤šæ•°ç±»å‹æ¥è‡ªå¤–éƒ¨åº“ã€‚

å¯¹äºæ¥è‡ªå¤–éƒ¨åº“çš„ç®€å•æ•°æ®ç±»ï¼Œæˆ‘ä»¬*å¯ä»¥* åƒä»¥å‰ä¸€æ ·é‚£ä¹ˆå¹²ï¼Œå¹¶å°†å®ƒä»¬æ˜ å°„åˆ°æœ¬åœ° UI æ¨¡å‹ç±»ï¼ˆè™½ç„¶è¿™å¾ˆè´¹åŠ›ï¼‰ã€‚ç„¶è€Œï¼Œå¤§å¤šæ•°åº”ç”¨ç¨‹åºæœ€ç»ˆä¼šå‘ç°æœ‰äº›ç±»æ— æ³•åœ¨æœ¬åœ°è½»æ¾æ˜ å°„ã€‚åœ¨`ui-showdetails`æ¨¡å—ä¸­ï¼Œæˆ‘æœ‰äº›æ¥è‡ª [ThreeTen-bp](https://www.threeten.org/threetenbp/) çš„æ—¶é—´ç›¸å…³çš„ç±»:`OffsetDateTime`å’Œ`LocalDate`. æˆ‘ä¸æ˜¯ç‰¹åˆ«æƒ³åœ¨æœ¬åœ°é‡å†™æ—¥æœŸ/æ—¶é—´åº“ï¼

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è°ˆè®ºçš„è¿˜ä»…ä»…æ˜¯**ä¸€ä¸ªmodule**çš„snapshotã€‚Tivi æ˜¯ä¸€ä¸ªç›¸å½“å°çš„åº”ç”¨ç¨‹åºï¼Œä½†å®ƒä»ç„¶åŒ…å« 12 ä¸ª UI æ¨¡å—ã€‚å¤§å‹åº”ç”¨ç¨‹åºå¯ä»¥åŒ…å«æ•°ç™¾ä¸ª UI æ¨¡å—ï¼Œè¿™ä½¿å¾—åœ¨æ¯ä¸ªæ¨¡å—ä¸­åˆ›å»ºæœ¬åœ° UI æ¨¡å‹æ˜¯ä¸ç°å®çš„ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨è¿™ç¯‡åšæ–‡å¼€å¤´æåˆ°çš„é‚£æ ·ï¼Œæ‚¨åªéœ€è¦åœ¨æ‚¨å·²ç¡®å®šæ€§èƒ½å­˜åœ¨é—®é¢˜çš„åœ°æ–¹æ‰è€ƒè™‘è¿™ä¸€ç‚¹ã€‚

### æ¢æ¡è·¯èµ°

åˆ°è¿™æ—¶æˆ‘æ‰é‡æ–°å›å»çœ‹æ–‡æ¡£ï¼Œå¹¶å¼€å§‹çœ‹ç¬¬äºŒä¸ªå»ºè®®ï¼š

> *é€šè¿‡å°†å‡½æ•°æ ‡è®°ä¸º* *`@NonRestartableComposable`*

ä¹ä¸€çœ‹ï¼Œè¿™ä¸ªå»ºè®®æ›´åƒæ˜¯ä¸€ç§æƒå®œä¹‹è®¡ï¼ˆæˆ–æœ«è·¯ä¹‹ç­–ï¼‰ï¼Œè€Œä¸æ˜¯åƒç¬¬ä¸€ä¸ªå»ºè®®é‚£æ ·å»ä¿®å¤ç±»ç¨³å®šæ€§ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æ³¨é‡Šçš„æ–‡æ¡£æ˜¯æ€ä¹ˆè¯´çš„ï¼š

> *æ­¤æ³¨è§£ [é˜²æ­¢] é‚£äº›å…è®¸å‡½æ•°è·³è¿‡æˆ–é‡å¯çš„ä»£ç è¢«ç”Ÿæˆã€‚è¿™å¯¹äº ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªå¯ç»„åˆå‡½æ•°ã€è‡ªèº«å‡ ä¹ä¸åšä»€ä¹ˆã€å¹¶ä¸”æœ¬èº«ä¸å¤ªå¯èƒ½å¤±æ•ˆçš„å°å‡½æ•° æ¥è¯´å¯èƒ½æ˜¯å¯å–çš„ã€‚*

å¦‚æœæˆ‘ä»¬å¾€å›æƒ³æƒ³ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®© Composable *å¯é‡å¯* **å’Œ** *å¯è·³è¿‡*ï¼Œæ‰€ä»¥ä»…è¯»è¿™ä¸ªæ³¨é‡Šå¹¶ä¸å¤ªå¤Ÿã€‚ä¸è¿‡ï¼ŒCompose Metrics æŒ‡å—æä¾›äº†æ›´å¤šä¿¡æ¯ï¼š

> *å¦‚æœComposableå‡½æ•°ä¸ç›´æ¥è¯»å–ä»»ä½•Stateå˜é‡ï¼Œé‚£ä¹ˆ [ä½¿ç”¨è¿™ä¸ªæ³¨è§£] æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œ[å› ä¸º] æ­¤é‡å¯ä½œç”¨åŸŸä¸å¤ªå¯èƒ½è¢«ä½¿ç”¨ã€‚*

é‚£ä¹ˆè¿™ä¸ªæ³¨é‡Šå¯¹æˆ‘ä»¬æœ‰å¸®åŠ©å—ï¼Ÿæ˜¯ä¹Ÿä¸æ˜¯ã€‚æ­¤æ³¨è§£ä¼¼ä¹è®© Compose ç¼–è¯‘å™¨å®Œå…¨å¿½ç•¥äº†æ‰€æœ‰å¯ç»„åˆå‡½æ•°çš„è‡ªåŠ¨é‡å¯ï¼Œä»è€Œå¦å®šäº†è®©æˆ‘ä»¬çš„å‡½æ•°*å¯é‡å¯* å’Œ*å¯è·³è¿‡* çš„åˆè¡·ã€‚æˆ‘ç›¸ä¿¡è¿™æ„å‘³ç€ä»»ä½•çŠ¶æ€æ›´æ”¹éƒ½éœ€è¦ Compose Runtime æ‰¾åˆ°ç¥–å…ˆé‡å¯èŒƒå›´ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢çš„æ–‡æ¡£è¯´è¦é¿å…å®ƒä»¬ç”¨äºè¯»å–Stateçš„å‡½æ•°ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥å¹²å˜›å‘¢ï¼Ÿå†™å°±è¿‘çš„ UI Model ç±»éœ€è¦æ·»åŠ å¤§é‡çš„ä¸œè¥¿ï¼Œå› æ­¤å¯¹äºå¾ˆå¤šå›¢é˜Ÿæ¥è¯´ï¼Œè¿™æ¡è·¯ä¸å¤§å¯è¡Œã€‚ä¸è¿‡ï¼Œæˆ‘å€’ç¡®å®åœ¨ [Compose Issue Tracker](https://issuetracker.google.com/issues/216791427)ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªæˆ‘éå¸¸å–œæ¬¢çš„è§£å†³æ–¹æ¡ˆï¼šå…è®¸å°†å‡½æ•°çš„å‚æ•°æ ‡è®°ä¸º`@Stable`. è¿™å°†ä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿå¯¹Composableå‡½æ•°çš„å‚æ•°å¼ºåˆ¶æŒ‡å®šç¨³å®šæ€§/ä¸å˜æ€§ï¼Œå³ä½¿å¯¹äºå¤–éƒ¨å‚æ•°ç±»å‹ä¹Ÿæ˜¯å¦‚æ­¤ï¼š

```
@Composable
fun AirsInfoPanel(
    @Stable show: TiviShow,
    modifier: Modifier = Modifier,
)
```

ç›®å‰ï¼Œå®ƒè¿˜**ä¸èƒ½ç”¨**ã€‚

## **`@dynamic`** **çš„é»˜è®¤å‚æ•°è¡¨è¾¾å¼**

ä» Metrics æ–‡æ¡£ä¸­ï¼Œè¦æ³¨æ„çš„ç¬¬äºŒä»¶äº‹æ˜¯`@dynamic`çš„é»˜è®¤å‚æ•°è¡¨è¾¾å¼ã€‚å¤§é‡Composableä½¿ç”¨é»˜è®¤å‚æ•°æ¥æä¾›çµæ´»çš„ APIã€‚æˆ‘æœ€è¿‘å†™äº†ä¸€ç¯‡å…³äº Slot API çš„æ–‡ç« ï¼Œå®ƒå°±ä¾èµ–äºé»˜è®¤å‚æ•°å€¼ï¼š

https://chris.banes.dev/slotting-in-with-compose-ui/

é»˜è®¤å‚æ•°çš„å€¼å¯ä»¥æ˜¯å¯ç»„åˆçš„ï¼Œæˆ–è€…ä¸å¯ç»„åˆçš„ã€‚ä½¿ç”¨å¯ç»„åˆä»£ç ä¸­çš„å€¼æ„å‘³ç€æ‚¨æ­£åœ¨è°ƒç”¨çš„ä»£ç å¯èƒ½æ˜¯*å¯é‡å¯* çš„ï¼Œå¹¶ä¸”è¿”å›å€¼å¯ä»¥å˜åŒ–ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€æŒ‡çš„`@dynamic`é»˜è®¤å‚æ•°ã€‚å¦‚æœé»˜è®¤å‚æ•°å€¼æ˜¯`@dynamic`ï¼Œåˆ™è°ƒç”¨æ–¹å‡½æ•°ä¹Ÿå¯èƒ½éœ€è¦é‡å¯ï¼Œè¿™å°±æ˜¯åº”é¿å…æ„å¤–çš„`@dynamic`çš„åŸå› ã€‚

ç¼–è¯‘æŒ‡æ ‡å°†é`@dynamic`å‚æ•°å€¼ç§°ä¸º`@static`ï¼Œå®ƒå¯èƒ½æ„æˆæ‚¨åœ¨`composables.txt`æ–‡ä»¶ä¸­æ‰¾åˆ°çš„ç»å¤§å¤šæ•°å†…å®¹ã€‚ä½†ä¹Ÿä¸€äº›ä¾‹å¤–æƒ…å†µä¸‹ï¼Œ`@dynamic`æ˜¯å¿…è¦çš„ï¼š

> ### *æ‚¨æ­£åœ¨æ˜¾å¼è¯»å–å¯è§‚å¯Ÿçš„dynamicå˜é‡*

å…³äºè¿™ä¸€ç‚¹ï¼Œæ‚¨æœ€å¸¸è§çš„æƒ…å†µæ˜¯åœ¨Composableä¸Šä½¿ç”¨`MaterialTheme.blah`åšé»˜è®¤å€¼ã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€ä¸ªComposableï¼Œå®ƒæœ‰ 3 ä¸ªè¢«æ ‡è®°ä¸ºdynamicçš„å‚æ•°ã€‚

```
restartable skippable scheme("[androidx.compose.ui.UiComposable]") fun TopAppBarWithBottomContent(
  stable backgroundColor: Color = @dynamic MaterialTheme.colors.primarySurface
  stable contentColor: Color = @dynamic contentColorFor(backgroundColor, $composer, 0b1110 and $dirty shr 0b1111)
  stable elevation: Dp = @dynamic AppBarDefaults.TopAppBarElevation
)
```

å‰ä¸¤ä¸ªå‚æ•°`backgroundColor`å’Œ`contentColor`æ˜¯dynamicï¼ˆåŠ¨æ€ï¼‰çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é—´æ¥è¯»å–æŒ‚åœ¨`MaterialTheme`ä¸Šçš„ composition locals . ç”±äºä¸»é¢˜æ˜¯ç›¸å¯¹é™æ€çš„ï¼ˆç†è®ºä¸Šæ¥è¯´ï¼‰ï¼Œè¿”å›å€¼å®é™…ä¸Šä¸åº”è¯¥ç»å¸¸æ”¹å˜ï¼Œæ‰€ä»¥å®ƒæ˜¯åŠ¨æ€çš„ä¹Ÿé—®é¢˜ä¸å¤§ã€‚

ä½†æ˜¯å¯¹äº`elevation`å‚æ•°ï¼Œæˆ‘å°±ä¸å¤§ç¡®å®šä¸ºä»€ä¹ˆå®ƒè¢«æ ‡è®°ä¸ºåŠ¨æ€çš„äº†ã€‚å®ƒä½¿ç”¨æ¥è‡ª Material æä¾›çš„ `AppBarDefaults`.`TopAppBarElevation` å±æ€§çš„å€¼ï¼Œè¯¥å±æ€§å®šä¹‰ä¸ºï¼š

```
object AppBarDefaults {
    val TopAppBarElevation = 4.dp
}
```

`dp`å±æ€§è¢«æ ‡è®°ä¸º`@Stable`ï¼Œå¹¶ä¸”`Dp`ç±»è¢«æ ‡è®°ä¸º`@Immutable`ã€‚æ‰€ä»¥ä»æˆ‘è¯»åˆ°çš„æƒ…å†µæ¥çœ‹ï¼Œè¿™å¯èƒ½æ˜¯ä¸ªbugï¼Ÿ

æˆ‘åœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸Šä¹Ÿå‘ç°äº†ç±»ä¼¼çš„é—®é¢˜ï¼š

```
restartable skippable scheme("[androidx.compose.ui.UiComposable]") fun SearchTextField(
  stable keyboardOptions: KeyboardOptions? = @dynamic Companion.Default
  keyboardActions: KeyboardActions? = @dynamic KeyboardActions()
)
```

`keyboardOptions`æŒ‡çš„æ˜¯`KeyboardOptions`(ä¸€ä¸ªå•ä¾‹) çš„ä¼´ç”Ÿå¯¹è±¡ï¼Œå¹¶`keyboardActions`åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç©º`KeyboardActions`å®ä¾‹ï¼Œæˆ‘è¯»ç€æ„Ÿè§‰è¿™ä¸¤ä¸ªå®ä¾‹éƒ½åº”è¯¥è¢«æ¨æ–­ä¸º`@static`ã€‚

ä¸è¿™ç¯‡åšæ–‡çš„ç¬¬ä¸€éƒ¨åˆ†ç±»ä¼¼ï¼Œæˆ‘ä¸ç¡®å®šæˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥åšäº›ä»€ä¹ˆæ¥å½±å“ Compose ç¼–è¯‘å™¨ã€‚æˆ‘ä»¬å¯ä»¥å°†`@Stableå’Œ@Immutable`æ·»åŠ åˆ°æˆ‘ä»¬è‡ªå·±çš„ç±»ä¸­ï¼Œä½†ä»`dp`ä¸Šé¢çš„ç¤ºä¾‹æ¥çœ‹ï¼Œè¿™ä¼¼ä¹å¹¶ä¸æ€»æ˜¯æœ‰æ•ˆã€‚

### **ä¸ºå•¥è¦åœ¨releaseä¸‹ï¼Ÿ**

åœ¨è¿™ç¯‡åšæ–‡çš„å¼€å¤´ï¼Œæˆ‘ä»¬æåˆ°æ‚¨éœ€è¦åœ¨releaseç‰ˆæœ¬ä¸Šå¯ç”¨ Compose Compiler æŒ‡æ ‡ã€‚å½“æ‚¨åœ¨debugæ¨¡å¼ä¸‹æ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼ŒCompose ç¼–è¯‘å™¨ä¼šå¯ç”¨è®¸å¤šåŠŸèƒ½æ¥åŠ å¿«å¼€å‘ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯[Live Literals](https://developer.android.com/jetpack/compose/tooling#live-edit-literals)ï¼Œå®ƒä½¿ Android Studio èƒ½åœ¨ä¸é‡æ–°ç¼–è¯‘Composableçš„æƒ…å†µä¸‹â€œæ³¨å…¥â€æŸäº›å‚æ•°å€¼çš„æ–°å€¼ã€‚

ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼ŒCompose ç¼–è¯‘å™¨å°†æŸäº›é»˜è®¤å‚æ•°æ›¿æ¢ä¸ºå¦ä¸€äº›ç”Ÿæˆåçš„ä»£ç ã€‚ç„¶åï¼ŒAndroid Studio å¯ä»¥è°ƒç”¨è¿™äº›ä»£ç æ¥è®¾ç½®æ–°å€¼ã€‚æœ€ç»ˆæ•ˆæœæ˜¯ç”Ÿæˆçš„ Live Literal ä»£ç å°†å¯¼è‡´æ‚¨çš„é»˜è®¤å‚æ•°ä¸º`@dynamic`ï¼Œå³ä½¿å®ƒä»¬å®é™…ä¸Šå¹¶ä¸æ˜¯åŠ¨æ€çš„ã€‚

æ‚¨å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°ä¸€ä¸ªç¤ºä¾‹ã€‚çº¢è‰²ï¼ˆè¯‘æ³¨ï¼šè¿™é‡Œæ²¡é¢œè‰²ï¼Œä»¥ - å¼€å¤´çš„è¡Œï¼‰æ˜¯`debug`æ¨¡å¼è¾“å‡ºï¼Œç»¿è‰²ï¼ˆè¯‘æ³¨ï¼šåŒï¼Œ+ å¼€å¤´çš„è¡Œï¼‰æ¥è‡ª`release`æ„å»ºã€‚releaseæ¨¡å¼ä¸‹ï¼Œå‚æ•°`expanded`å˜æˆäº†`@static`ã€‚

```
--- debug.txt        2022-04-06 14:43:16.000000000 +0100
+++ release.txt        2022-04-06 14:43:24.000000000 +0100
@@ -1,11 +1,11 @@
 restartable skippable scheme("[androidx.compose.ui.UiComposable, [androidx.compose.ui.UiComposable], [androidx.compose.ui.UiComposable], [androidx.compose.ui.UiComposable]]") fun ExpandableFloatingActionButton(
   stable text: Function2<Composer, Int, Unit>
   stable onClick: Function0<Unit>
   stable modifier: Modifier? = @static Companion
   stable icon: Function2<Composer, Int, Unit>
-  stable shape: Shape? = @dynamic MaterialTheme.shapes.small.copy(CornerSize(LiveLiterals$ExpandingFloatingActionButtonKt.Int$arg-0$call-CornerSize$arg-0$call-copy$param-shape$fun-ExpandableFloatingActionButton()))
+  stable shape: Shape? = @dynamic MaterialTheme.shapes.small.copy(CornerSize(50))
   stable backgroundColor: Color = @dynamic MaterialTheme.colors.secondary
   stable contentColor: Color = @dynamic contentColorFor(backgroundColor, $composer, 0b1110 and $dirty shr 0b1111)
   stable elevation: FloatingActionButtonElevation? = @dynamic FloatingActionButtonDefaults.elevation(<unsafe-coerce>(0.0f), <unsafe-coerce>(0.0f), <unsafe-coerce>(0.0f), <unsafe-coerce>(0.0f), $composer, 0b1000000000000000, 0b1111)
-  stable expanded: Boolean = @dynamic LiveLiterals$ExpandingFloatingActionButtonKt.Boolean$param-expanded$fun-ExpandableFloatingActionButton()
+  stable expanded: Boolean = @static true
 )
```

## **æˆ‘åˆšåˆšå­¦åˆ°äº†å•¥ï¼Ÿ**

åˆ°è¿™ä¼šå„¿ï¼Œæ‚¨å¯èƒ½ä¼šè®¤ä¸ºæ‚¨åˆšåˆšèŠ±äº†å¤§çº¦ 30 åˆ†é’Ÿï¼Œé˜…è¯»æˆ‘çš„æ–‡ç« ã€å…‰çœ‹æˆ‘æŒ‡å‡ºäº†è®¸å¤šå¯èƒ½çš„é—®é¢˜â€¦â€¦å¥½å§æ‚¨å¤§æ¦‚ä¹Ÿæ˜¯å¯¹çš„ ğŸ˜…ã€‚ä½†æ˜¯æˆ‘ä»ç„¶è®¤ä¸ºè¿™é‡Œæœ‰ä¸€äº›å›¢é˜Ÿå¯ä»¥é‡‡å–çš„è¡ŒåŠ¨ï¼š

-   å¼€å§‹[åˆ†æå’Œè·Ÿè¸ªæ€§èƒ½ç»Ÿè®¡ä¿¡æ¯](https://developer.android.com/studio/profile)ã€‚æ²¡æœ‰è¿™ä¸ªï¼Œä»»ä½•çš„æ€§èƒ½ä¼˜åŒ–éƒ½æ˜¯åœ¨æ‘¸é»‘çèµ°ã€‚

<!---->

-   å°½æ—©æ›´æ–°åˆ° Compose çš„æ–°ç‰ˆæœ¬ï¼è¿™å°†è®©æ‚¨èƒ½å°è¯•å¹¶è·å¾—æ€§èƒ½ä¸Šçš„æ›´æ–°ï¼ˆå¹¶æŠ¥å‘Šå¯èƒ½çš„é€€æ­¥ï¼‰ã€‚

<!---->

-   å¯»æ‰¾é‚£äº›è¢«æ ‡è®°ä¸º`@Composable`çš„å°çš„åŠŸèƒ½å‡½æ•°æˆ–lambdaè¡¨è¾¾å¼. è¿™äº›å¾€å¾€ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼ˆè€Œä¸æ˜¯æ›´æ–° UIï¼‰ï¼Œå¹¶ä¸”å¾€å¾€åªæ˜¯ä¸ºäº†å¯ä»¥å¼•ç”¨ composition locals ï¼ˆæ ¹æ®æˆ‘çš„ç»éªŒï¼Œ`LocalContext`æ˜¯ä¸€ä¸ªå¸¸è§çš„ç½ªé­ç¥¸é¦–ï¼‰æ‰è¢«æ ‡è®°ä¸ºComposableã€‚æ‚¨å¯ä»¥é€šè¿‡[ä¼ å…¥ä¾èµ–é¡¹](https://developer.android.com/jetpack/compose/state#state-hoisting)è½»æ¾åœ°æ‹¿æ‰è¿™ä¸ªComposableæ³¨è§£ã€‚

## **æœ€åçš„æƒ³æ³•**

æ­£å¦‚æˆ‘åœ¨ä¸Šé¢æåˆ°çš„ï¼Œæˆ‘è®¤ä¸ºè¿™äº›æ–°æŒ‡æ ‡å‘å‰è¿ˆè¿›äº† âœ¨ æƒŠäººçš„ âœ¨ ä¸€æ­¥ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„Composableå®é™…è¢«æ¨æ–­å‡ºçš„å†…å®¹ã€‚

æˆ‘æŒ‡å‡ºçš„é—®é¢˜å®é™…ä¸Šæ˜¯ä¸€ä»¶*å¥½äº‹*ï¼Œå¹¶è¡¨æ˜è¿™äº›æŒ‡æ ‡å’Œè¾“å‡ºæ˜¯æœ‰æ•ˆçš„ã€‚å¦‚æœæ²¡æœ‰è¿™äº›ï¼Œæˆ‘ä»¬å°†å®Œå…¨ä¸çŸ¥é“ä¼šè¢«æ¨æ–­å‡ºä»€ä¹ˆæ¥ï¼Œä¹Ÿæ²¡æ³•çœ‹åˆ°æ¨æ–­çš„ç»“æœä½•æ—¶ä¸å®Œå…¨ç¬¦åˆé¢„æœŸã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œåœ¨Compose[é—®é¢˜è·Ÿè¸ªå™¨](https://chris.banes.dev/composable-metrics/goo.gle/compose-feedback)ä¸Šåˆ›å»ºé—®é¢˜å°±å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

è¿™äº›æŒ‡æ ‡ç°åœ¨æ˜¾ç„¶éå¸¸åŸå§‹ï¼Œä½†åœ¨çŸ¥é“ Compose + Android Studio å·¥å…·å›¢é˜Ÿæœ‰å¤šå‡ºè‰²çš„å‰æä¸‹ï¼Œæˆ‘ç¡®ä¿¡ä¸€ä¸ªç›¸åº”çš„ Android Studio GUI ç‰ˆæœ¬ä¸ä¼šç­‰å¤ªä¹…çš„ã€‚æˆ‘æœŸå¾…ç€çœ‹åˆ°å›¢é˜ŸæŠŠè®©å®ƒæˆä¸ºç°å®ï¼

***

*æ„Ÿè°¢* *[Yoali](https://twitter.com/yoali_sb)* *ã€* *[Taylor](https://twitter.com/1taylorsandusky)* *ã€* *[Nacho](https://twitter.com/mrmans0n)* *å’Œ* *[Ben](https://twitter.com/bentrengrove)* *çš„å®¡é˜…*ğŸ™Œ

(åŸæ–‡ç»“æŸ)
